###  Spring

åœ¨æµ‹è¯•ç±»ä¸­æµ‹è¯•IoCå®¹å™¨çš„å­˜åœ¨

- æ·»åŠ æ³¨è§£`@ContextConfiguration(classes = CommunityApplication.class)`
- å®ç°æ¥å£ `ApplicationContextAware`
- é‡å†™æ–¹æ³•`public void setApplicationContext(ApplicationContext applicationContext)`

```java
@SpringBootTest
@ContextConfiguration(classes = CommunityApplication.class)//åœ¨æµ‹è¯•ç±»ä¸­åŠ ä¸Šæ­¤æ³¨è§£å°±èƒ½å°†é…ç½®ç±»ï¼ˆï¼‰å¼•ç”¨åœ¨æœ¬ç±»ä¸­
class CommunityApplicationTests implements ApplicationContextAware {

	private ApplicationContext applicationContext;
	@Override
	public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
		this.applicationContext = applicationContext;
	}
	@Test
	public void testApplicationContext(){
		System.out.println(applicationContext);
        //org.springframework.web.context.support.GenericWebApplicationContext@598bd2ba, started on Thu Jun 02 19:55:32 CST 2022
		//è¯æ˜å®¹å™¨æ˜¯å­˜åœ¨çš„
	}
}
```

`@Primary`  æ³¨è§£åœ¨beanä¸Šè¡¨ç¤ºä¼˜å…ˆè¢«Iocå®ä¾‹åŒ–
`@PostConstruct` æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºåœ¨æ„é€ å™¨è¿è¡Œä¹‹åæ‰§è¡Œ
`@PreDestory` æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºåœ¨é”€æ¯æ–¹æ³•å‰æ‰§è¡Œ

**æƒ³å®ä¾‹åŒ–ä¸€ä¸ªç¬¬ä¸‰æ–¹jaråŒ…çš„bean**ï¼šè‡ªå·±å†™ä¸ªé…ç½®ç±»ï¼Œé€šè¿‡beanæ³¨è§£å®ç°

`@SpringbootApplication` ä¸€èˆ¬ç”¨äº**ç¨‹åºå…¥å£**çš„é…ç½®ç±»
`@Configuration` è¡¨ç¤ºä¸º**ä¸€èˆ¬**é…ç½®ç±»

```java
@Configuration
public class AlphaConfig {
    @Bean
    public SimpleDateFormat simpleDateFormat(){
        return new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    }
}
```

```java
@Test
	public void testBeanConfiguration(){
		SimpleDateFormat simpleDateFormat = applicationContext.getBean(SimpleDateFormat.class);
		System.out.println(simpleDateFormat.format(new Date()));
        //2022-06-02 20:13:55
	}
```



### MVC

##### ä¼ é€’å‚æ•°æ–¹å¼

ç¬¬ä¸€ç§:

```java
@RequestMapping(path = "/student",method = RequestMethod.GET)
@ResponseBody
public String getStudent(@RequestParam(name="current",required=false,defalutValue="1") int current,
                        @RequestParam(name="limit",required=false,defalutValue="10") int limit){}
```

RestFul

```java
@RequestMapping(path = "/student/{id}",method = RequestMethod.GET)
@ResponseBody
public String getStudent(@PathVariable("id") int id){
        System.out.println(id);
        return "a student";
    }
```

### é‚®ä»¶åŠŸèƒ½

1. åœ¨sinaå¼€å¯æˆæƒç çŠ¶æ€ï¼Œå’ŒPOP3,SMTPæœåŠ¡

2. æ–°å»ºå·¥å…·ç±»MailClient

   ```java
   /*	1.å°†å…¶æ·»åŠ åˆ°springIoCç®¡ç†
   *	2.å®šä¹‰ä¸€ä¸ªLoggerï¼Œç”¨äºè®°å½•é”™è¯¯ä¿¡æ¯
   *	3.å°†é…ç½®æ–‡ä»¶ä¸­çš„usernameæ³¨å…¥ï¼Œè¿™æ˜¯ï¼ˆä»£è¡¨äº†ç½‘ç«™ï¼‰å‘é€æ–¹
   *	4.å®šä¹‰sendMailæ–¹æ³•ï¼Œéœ€è¦ å‘é‚®ä»¶çš„æ ‡é¢˜ ï¼Œå†…å®¹ ï¼Œæˆ‘çš„é‚®ç®± ï¼Œä»–äººçš„é‚®ç®± å››ä¸ªå‚æ•°
   		éœ€è¦springä¸­çš„MimeMessageHelper å¸®åŠ©æ„å»ºé‚®ä»¶
   */
   @Component
   public class MailClient {
       private static final Logger logger = LoggerFactory.getLogger(MailClient.class);
   
       @Autowired
       private JavaMailSender mailSender;
       //éœ€è¦å‘é‚®ä»¶çš„æ ‡é¢˜ï¼Œå†…å®¹ï¼Œæˆ‘çš„é‚®ç®±ï¼Œä»–äººçš„é‚®ç®±
       //å°†usernameæ³¨å…¥ï¼Œå› ä¸ºæœåŠ¡å™¨å‘é‚®ä»¶éƒ½æ˜¯ç”¨ç›´æ¥çš„è´¦å·ï¼ˆé…ç½®ä¸­çš„sinaï¼‰
       @Value("${spring.mail.username}")
       private String from;
   
       //å°è£…å…¬æœ‰æ–¹æ³•
       public void sendMail(String to, String subject, String content) {
           try {
               MimeMessage message = mailSender.createMimeMessage();
               MimeMessageHelper helper = new MimeMessageHelper(message);
               helper.setFrom(from);
               helper.setTo(to);
               helper.setSubject(subject);
               helper.setText(content, true);
               mailSender.send(helper.getMimeMessage());
           } catch (MessagingException e) {
               logger.error("å‘é€é‚®ä»¶å¤±è´¥" + e.getMessage());
           }
       }
   }
   ```

   æµ‹è¯•ï¼š

```java
@Autowired
private MailClient mailClient;//æ³¨å…¥å·¥å…·ç±»

@Test
public void testMail(){
    mailClient.sendMail("574524709@qq.com","test","test mail");
}
```

éœ€è¦å‘htmlå½¢å¼é‚®ç®±ï¼šé‡‡ç”¨thymeleafæ„å»ºæ¨¡æ¿ï¼š

```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>é‚®ä»¶ç¤ºä¾‹</title>
</head>
<body>
    <p>æ¬¢è¿æ‚¨ï¼Œ<span style="color: darkorchid;" th:text="${username}"></span>!</p>
</body>
</html>
```

æµ‹è¯•ï¼š

```java
@Autowired
private TemplateEngine templateEngine;//springbootä¸­å·²ç®¡ç†äº†æ¨¡æ¿å¼•æ“ï¼Œåªéœ€æ³¨å…¥
@Test
    public void testHtmlMail(){
        Context context = new Context();//æ³¨æ„æ˜¯thymeleafçš„ç±»
        context.setVariable("username","sunday");//è¿™æ˜¯å…¶ä¸­çš„ä¸€ä¸ªå˜é‡
        String content = templateEngine.process("/mail/demo", context);//æŠŠæ¨¡æ¿åœ°å€ï¼Œæ•°æ®ä¼ å…¥å¦‚
        System.out.println(content);
        mailClient.sendMail("574524709@qq.com","HTML",content);
}
```

### 6.5

å¯åŠ¨å‡ºç°é—®é¢˜

```
java.sql.SQLNonTransientConnectionException: Public Key Retrieval is not allowed
```

åœ¨é…ç½®ä¸­æ•°æ®åº“è¿æ¥ååŠ ä¸Š

```
allowPublicKeyRetrieval=true
```

åœ¨é¦–é¡µç‚¹å‡»ï¼ˆé¦–é¡µï¼‰ï¼Œï¼ˆæ³¨å†Œï¼‰éƒ½æ— é¡µé¢

```html
<!--æ³¨æ„thymeleafçš„è¿™ä¸ªå†™æ³•æ˜¯é”™çš„-->
<a class="nav-link" th:href="@{site/index.html}">é¦–é¡µ</a>
<!--é‡‡ç”¨è¿™æ ·-->
<a class="nav-link" th:href="@{index}">é¦–é¡µ</a>
```

### Cookie

```java
 //Cookieç¤ºä¾‹
    @RequestMapping(path = "/cookie/set",method = RequestMethod.GET)
    @ResponseBody
    public String setCookie(HttpServletResponse response){
        Cookie cookie = new Cookie("code1", CommunityUtil.generateUUID());
        //è®¾ç½®èŒƒå›´ï¼Œæœ‰äº›è·¯å¾„ä¸‹æœ‰æ•ˆçš„
        cookie.setPath("/community/alpha");
        //ç”Ÿå­˜æ—¶é—´ï¼ˆé»˜è®¤æ˜¯å…³é—­æµè§ˆå™¨å¤±æ•ˆï¼‰
        cookie.setMaxAge(600);//ç§’
        //å‘é€
        response.addCookie(cookie);
        return "set cookie";
    }

    @RequestMapping(path = "/cookie/get",method = RequestMethod.GET)
    @ResponseBody
    public String getCookie(@CookieValue("code1") String code1){//åŸæœ¬åœ¨requestä¸­å–å¾—ï¼Œä½†å¯ä»¥ç”¨æ³¨è§£å–å¾—å¹¶èµ‹ç»™å€¼
        System.out.println();
        return "get cookie";
    }
```

### session

ä¼˜ç‚¹ï¼šå­˜åœ¨æœåŠ¡å™¨æ›´å®‰å…¨

ç¼ºç‚¹ï¼šæœåŠ¡å™¨å‹åŠ›

```java
 //Sessionæ˜¯javaSEçš„è§„èŒƒï¼Œä¸æ˜¯httpçš„
    @RequestMapping(path = "/session/set",method = RequestMethod.GET)
    @ResponseBody
    public String setSession(HttpSession session){//ä¸cookieä¸åŒï¼ŒspringMVCä¼šè‡ªåŠ¨åˆ›å»ºSession,åªéœ€è¦å£°æ˜ï¼Œå°±èƒ½æ³¨å…¥è¿›æ¥
        session.setAttribute("id",1);
        session.setAttribute("name","test");
        return "session test";
    }

    @RequestMapping(path = "/session/get",method = RequestMethod.GET)
    @ResponseBody
    public String getSession(HttpSession session){
        System.out.println(session.getAttribute("id"));
        System.out.println(session.getAttribute("name"));
        return "get session test";
    }
```

<font color=red>åˆ†å¸ƒå¼éƒ¨ç½²</font>ï¼šnginxå®ç°è´Ÿè½½å‡è¡¡

- ç²˜æ€§sessionï¼šåŒä¸€ipçš„è¯·æ±‚å‡åˆ†é…åˆ°æŒ‡å®šä¸€å°æœåŠ¡å™¨ä¸Š
- åŒæ­¥sessionï¼šæœåŠ¡å™¨å°†sessionåŒæ­¥ç»™æ‰€æœ‰æœåŠ¡å™¨
- å…±äº«sessionï¼šæœ‰ä¸€å°å•ç‹¬çš„æœåŠ¡å™¨ç”¨äºå¤„ç†sessionï¼Œå…¶ä»–æœåŠ¡å™¨ä¸è¯¥æœåŠ¡å™¨
- ä¸»æµï¼šä¸ä½¿ç”¨sessionï¼Œè€Œæ˜¯ç”¨cookieï¼Œéƒ¨åˆ†ä¸é€‚åˆå­˜cookieçš„å­˜æ•°æ®åº“é‡Œï¼Œæ•°æ®åº“é›†ç¾¤å¤‡ä»½
- æ›´å¥½çš„åšæ³•ï¼šä¸å­˜åœ¨å…³ç³»å‹æ•°æ®åº“ï¼ˆç¡¬ç›˜ï¼‰ä¸­ï¼Œè€Œæ˜¯NOSQLä¸­

### ç”ŸæˆéªŒè¯ç 

Kaptchaï¼š

- å¯¼å…¥jaråŒ…
- ç¼–å†™kaptchaé…ç½®ç±»
- ç”Ÿæˆéšæœºå­—ç¬¦ï¼Œå›¾ç‰‡

### ç™»å…¥å’Œé€€å‡º

ç™»å½•è¯·æ±‚ï¼š

- ç‚¹å‡»ä¸Šæ–¹çš„â€œç™»å…¥â€ï¼Œèƒ½è·³åˆ°ç™»å…¥é¡µé¢
- ç‚¹å‡»â€œç«‹å³ç™»å…¥â€ï¼Œè¿”å›ç»“æœï¼ˆç™»å…¥å‡­è¯ï¼Œcookieï¼‰å‘ç»™å®¢æˆ·ç«¯

é€€å‡ºè¯·æ±‚:

- å°†ç™»å…¥å‡­è¯ä¿®æ”¹ä¸ºå¤±æ•ˆçŠ¶æ€
- è·³è½¬è‡³é¦–é¡µ

æ•°æ®åº“ä¸­çš„è¡¨ login_ticketï¼š

| id   | user_id | ticket               | status        | expired  |
| ---- | ------- | -------------------- | ------------- | -------- |
|      |         | éšæœºå­—ç¬¦ä¸²ï¼Œå”¯ä¸€æ ‡è¯† | 0-æœ‰æ•ˆ 1-æ— æ•ˆ | è¿‡æœŸæ—¶é—´ |

1ã€åˆ›å»ºå®ä½“ç±»ï¼Œå°è£…æ•°æ®

```java
//dao

/**
 * åœ¨æœ¬ç±»ä¸­ï¼Œå­¦ä¹ ä½¿ç”¨æ³¨è§£å®ç°sqlï¼Œä¸æ˜¯xml
 *
 */
@Mapper
public interface LoginTicketMapper {

    //ç™»å…¥æˆåŠŸåè¦æ’å…¥å‡­è¯//éœ€è¦å£°æ˜ä¸»é”®è‡ªåŠ¨ç”Ÿæˆï¼Œ@Optionsï¼Œä¸”éœ€è¦å°†ç”Ÿæˆçš„å€¼æ³¨å…¥ç»™å¯¹è±¡ï¼ŒkeyProperty = "id"
    @Insert({
            "insert into login_ticket (user_id,ticket,status,expired) ",//åŠ ä¸ªç©ºæ ¼æ–­å¼€
            "values(#{userId},#{ticket},#{status},#{expired})"
    })
    @Options(useGeneratedKeys = true,keyProperty = "id")
    int insertLoginTicket(LoginTicket loginTicket);

    //æŸ¥è¯¢æ–¹æ³•ï¼šå›´ç»•ticket
    @Select({
            "select id,user_id,ticket,status,expired ",
            "from login_ticket where ticket=#{ticket}"
    })
    LoginTicket selectByTicket(String ticket);

    //ä¿®æ”¹å‡­è¯çŠ¶æ€ï¼šä¸åˆ é™¤
    @Update({
            "update login_ticket set status=#{status} where ticket=#{ticket}"
    })
    int updateStatus(String ticket,int status);
    //å­¦ä¹ ï¼šå‡å¦‚éœ€è¦åŠ¨æ€sqlæ—¶
    /*@Update({
            "<script>",
            "update login_ticket set status=#{status} where ticket=#{ticket} ",
            "<if test=\"ticket!=null\">",
            "and 1 =1",
            "</if>",
            "</script>"
    })*/
}
```

```java
//UserService


//å®ç°ç™»å…¥åŠŸèƒ½ï¼šæˆåŠŸã€å¤±è´¥ï¼ˆå¤šç§æƒ…å†µï¼‰
    public Map<String ,Object> login(String username,String password,int expiredSeconds){
        Map<String ,Object> map = new HashMap<>();
        //ç©ºå€¼åˆ¤æ–­
        if(StringUtils.isBlank(username)){
            map.put("usernameMsg","è´¦å·ä¸èƒ½ä¸ºç©ºï¼");
            return map;
        }
        if(StringUtils.isBlank(password)){
            map.put("passwordMsg","å¯†ç ä¸èƒ½ä¸ºç©ºï¼");
            return map;
        }
        //éªŒè¯åˆæ³•æ€§
        User user = userMapper.selectByName(username);
        if(user==null){
            map.put("usernameMsg","è´¦å·ä¸å­˜åœ¨ï¼");
            return map;
        }
        //æ²¡æ¿€æ´»çš„è´¦å·ä¸èƒ½ç™»å…¥
        if(user.getStatus()==0){
            map.put("usernameMsg","è´¦å·æœªæ¿€æ´»ï¼");
            return map;
        }
        //å¯†ç 
        password = CommunityUtil.md5(password+ user.getSalt());
        if(user.getPassword().equals(password)){
            map.put("passwordMsg","å¯†ç ä¸æ­£ç¡®ï¼");
            return map;
        }
        //ç™»å…¥æˆåŠŸï¼Œç”Ÿæˆç™»å…¥å‡­è¯
        LoginTicket loginTicket = new LoginTicket();
        loginTicket.setUserId(user.getId());
        loginTicket.setTicket(CommunityUtil.generateUUID());
        loginTicket.setStatus(0);//æœ‰æ•ˆçŠ¶æ€
        loginTicket.setExpired(new Date(System.currentTimeMillis()+expiredSeconds*1000));
        loginTicketMapper.insertLoginTicket(loginTicket);
        //è¿™ä¸ªLoginTicketè¡¨å°±ç›¸å½“ä¸sessionäº†ï¼Œä¸‹æ¬¡ç”¨æˆ·è¯·æ±‚å¸¦ä¸Šticketï¼ŒæœåŠ¡å™¨æŸ¥è¯¢çŠ¶æ€å’Œæ—¶é—´çœ‹æ˜¯å¦æœ‰æ•ˆ
        map.put("ticket",loginTicket.getTicket());
        return map;
    }
```

```java
//LoginController

@RequestMapping(path = "/login",method = RequestMethod.POST)
    public String login(String username,String password ,String code,boolean rememberme,//è¿™ä¸ªremembermeæ˜¯å‹¾é€‰è®°ä½æˆ‘
                        Model model,HttpSession session,HttpServletResponse response){//modelç”¨äºèŒƒå›´å“åº”æ•°æ®ï¼›getKaptchaå­˜çš„éªŒè¯ç éœ€è¦sessionè·å–ï¼›ç™»å…¥æˆåŠŸäº†ï¼Œéœ€è¦å°†ticketå‘ç»™å®¢æˆ·ç«¯ç”¨cookieä¿å­˜
        String kaptcha = (String) session.getAttribute("kaptcha");
        if(StringUtils.isBlank(kaptcha)||StringUtils.isBlank(code)||!kaptcha.equalsIgnoreCase(code)){
            model.addAttribute("codeMsg","éªŒè¯ç ä¸æ­£ç¡®");
            return "/site/login";
        }
        //æ£€æŸ¥è´¦å·å¯†ç 
        //å¦‚æœå‹¾é€‰äº†â€œè®°ä½æˆ‘â€ï¼Œåˆ™å­˜çš„æ—¶é—´é•¿ä¸€ç‚¹
        //è¿™é‡Œå†æ¬¡åœ¨CommunityConstantç±»æ·»åŠ å¸¸é‡
        int expiredSecond = rememberme?REMEMBER_EXPIRED_SECONDS:DEFAULT_EXPIRED_SECONDS;
        Map<String, Object> map = userService.login(username, password, expiredSecond);
        //å¦‚æœmapæ€»åŒ…å«ticketï¼Œå°±æ˜¯æˆåŠŸäº†
        if(map.containsKey("ticket")){
            Cookie cookie = new Cookie("ticket",map.get("ticket").toString());
            cookie.setPath(contextPath);//è¡¨ç¤ºæ•´ä¸ªé¡¹ç›®ä¸‹cookieéƒ½æ˜¯æœ‰æ•ˆçš„:æ³¨å…¥propertiesä¸­çš„å€¼
            cookie.setMaxAge(expiredSecond);
            response.addCookie(cookie);//å°†cookieå‘ç»™ç”¨æˆ·
            return "redirect:/index";
        }else {
            model.addAttribute("usernameMsg",map.get("usernameMsg"));
            model.addAttribute("passwordMsg",map.get("passwordMsg"));
            return "/site/login";
        }
    }
```

### æ˜¾ç¤ºç™»å…¥ä¿¡æ¯

æ ¹æ®ç™»å…¥ä¸å¦ï¼Œè°ƒæ•´å¤´éƒ¨ä¿¡æ¯ï¼Œç”±äºåœ¨æ•´ä¸ªç½‘ç«™éƒ½æœ‰ï¼šè®¾å®šæ‹¦æˆªå™¨

1ã€å®šä¹‰æ‹¦æˆªå™¨

```java
@Controller
public class AlphaInterceptor implements HandlerInterceptor {
    private static final Logger logger = LoggerFactory.getLogger(AlphaInterceptor.class);

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        logger.debug("preHandleè°ƒç”¨äº†:"+handler.toString());
        return true;
    }

    //åœ¨Controllerä¹‹åè¿è¡Œï¼Œæ¨¡æ¿å¼•æ“ä¹‹å‰æ‰§è¡Œ
    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        logger.debug("postHandleè°ƒç”¨äº†:"+handler.toString());
    }

    //åœ¨æ¨¡æ¿å¼•æ“TemplateEngineä¹‹åæ‰§è¡Œ
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        logger.debug("afterCompletionè°ƒç”¨äº†:"+handler.toString());
    }
    //å†™å®Œä¹‹ååœ¨configå»ºç«‹é…ç½®ç±»
}
```

2ã€é…ç½®æ‹¦æˆªå™¨ï¼ŒæŒ‡å®šã€æ’é™¤è·¯å¾„

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {


    @Autowired
    private AlphaInterceptor alphaInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(alphaInterceptor).
                excludePathPatterns("/**/*.css","/**/*.js","/**/*.png","/**/*.jpg","/**/*.jpeg")  //ä¸æ‹¦æˆªé™æ€èµ„æº
                .addPathPatterns("/register","/login"); //æ˜ç¡®è¦æ‹¦æˆªçš„è·¯å¾„ï¼šæ³¨å†Œå’Œç™»å…¥
    }
}
```

æ‹¦æˆªå™¨åœ¨æœ¬èŠ‚çš„å®ç°ï¼š

-  åœ¨è¯·æ±‚å¼€å§‹æ—¶æŸ¥è¯¢ç™»å…¥ç”¨æˆ·
- åœ¨æœ¬æ¬¡è¯·æ±‚ä¸­æŒæœ‰çš„ç”¨æˆ·æ•°æ®
- åœ¨æ¨¡æ¿è§†å›¾ä¸Šæ˜¾ç¤ºç”¨æˆ·æ•°æ®
- åœ¨ç»“æŸè¯·æ±‚æ—¶æ¸…ç†ç”¨æˆ·æ•°æ®

### è´¦å·è®¾ç½®

ä¸Šä¼ å¤´åƒå’Œä¿®æ”¹å¯†ç 

ä¸Šä¼ æ–‡ä»¶ï¼š

- è¯·æ±‚ï¼špost
- è¡¨å•ï¼šenctype="multipart/form-data"
- SpringMVC ï¼šé€šè¿‡MultipartFileå¤„ç†ä¸Šä¼ æ–‡ä»¶

æ­¥éª¤ï¼š

1. è®¿é—®é¡µé¢
2. ä¸Šä¼ å¤´åƒ
3. è·å–å¤´åƒï¼šåœ¨å…¶ä»–é¡µé¢éƒ½è¦è·å–

## 6.14

### æ³¨å†ŒåŠŸèƒ½

1.Controllerå±‚

```java
//LoginController
@RequestMapping(path = "/register",method = RequestMethod.GET)
    public String getRegisterPage(){
        return "/site/register";
    }
```

2.ä¿®æ”¹registeré¡µé¢

3.å¼•å…¥CommonsLangåŒ…ï¼Œç”¨äºå¸¸ç”¨å­—ç¬¦ä¸²æ£€æµ‹

4.å†™å·¥å…·ç±»ï¼ˆç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼ŒåŠ å¯†ç­‰ï¼‰ï¼Œç”±äºä¸éœ€è¦äº¤ç»™å®¹å™¨æ‰˜ç®¡ï¼Œå› æ­¤å†™æˆé™æ€æ–¹æ³•

```java
//ä½¿ç”¨ è‡ªå¸¦çš„UUIDåŒ…ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
public static String generateUUID(){
        return UUID.randomUUID().toString().replaceAll("-","");//ä¸æƒ³è¦æœ‰æ¨ªçº¿
    }
//åŠ å¯†å¯†ç :ä½¿ç”¨Spring è‡ªå¸¦çš„å·¥å…·ç±» DigestUtils.md5DigestAsHex()
public static String md5(String key){
        if(StringUtils.isBlank(key)){//å…ˆç®€å•åˆ¤æ–­ä¸‹ä¸ä¸ºç©ºï¼Œé‡‡ç”¨äº†commons langåŒ…
            return null;
        }else {
            return DigestUtils.md5DigestAsHex(key.getBytes(StandardCharsets.UTF_8));//è¿™æ˜¯springè‡ªå¸¦çš„åŠ å¯†æ–¹æ³•
        }
    }
```

5.å¼€å‘æ³¨å†Œä¸šåŠ¡

```java
//UserService
//æ³¨å…¥é‚®ä»¶å®¢æˆ·ç«¯ï¼Œæ¨¡æ¿å¼•æ“
//æ³¨å…¥é¡¹ç›®åï¼Œé¡¹ç›®è·¯å¾„
	@Autowired
    private MailClient mailClient;
    @Autowired
    private TemplateEngine templateEngine;
    //æ³¨å†Œæ—¶å‘é€æ¿€æ´»ç éœ€è¦å¸¦ä¸ŠåŸŸåå’Œé¡¹ç›®åï¼Œå› æ­¤ä»propertiesä¸­æ³¨å…¥
    @Value("${community.path.domain}")
    private String domain;
    @Value("${server.servlet.context-path}")
    private String contextPath;
    @Autowired
    private LoginTicketMapper loginTicketMapper;
```

6.å¼€å‘ä¸šåŠ¡

> - è¿”å›ç»“æœï¼šé”™è¯¯ä¿¡æ¯ï¼ˆæ³¨å†ŒæˆåŠŸã€è´¦å·å·²å­˜åœ¨ç­‰ï¼‰---> Map
>
>   1. ç©ºå€¼åˆ¤æ–­ï¼šè´¦å·ï¼Œå¯†ç ï¼Œé‚®ç®±
>
>   2. éªŒè¯ï¼šï¼ˆè´¦å·å·²å­˜åœ¨ã€é‚®ç®±å·²å­˜åœ¨ï¼‰â€”â€”> userMapper.selectByName
>
>   3. æ³¨å†Œç”¨æˆ·ï¼šæŠŠç”¨æˆ·æ’å…¥åº“ä¸­
>
>      1. user.setSalt
>
>      2. user.setPassword() å°†salt+åŸå¯†ç å¹¶åŠ å¯†è¦†ç›–åŸå¯†ç 
>
>      3. user.setType/setStatus/setActivationCode/setHeader
>
>      4. éšæœºå¤´åƒè®¾ç½®
>
>         ```java
>         user.setHeaderUrl(String.format("http:\\image.nowcoder.com/head/%dt.png",new Random().nextInt(1000)));
>         ```
>
>      5. ç»™ç”¨æˆ·å‘æ¿€æ´»é‚®ä»¶
>
>
> ```java
> Context context = new Context();//Thymeleafè‡ªå¸¦å¯¹è±¡ï¼šæ¨¡æ¿ç”Ÿæˆhtmlæ ¼å¼é‚®ä»¶
> context.setVariable("email",user.getEmail()); 
> //åŠ¨æ€æ‹¼æ¥ç”¨æˆ·èƒ½ç‚¹çš„è·¯å¾„ï¼ˆæ¯ä¸ªç”¨æˆ·çš„æ¿€æ´»é¡µé¢æ˜¯ä¸åŒçš„ï¼‰ :101 æ˜¯ç”¨æˆ·idï¼Œcodeæ˜¯æ¿€æ´»ç 
> //http://localhost:8080/community/activation/101/code
> String url = domain+contextPath+"/activation/"+user.getId()+"/"+user.getActivationCode();
> context.setVariable("url",url);
> //ç”Ÿæˆæ¨¡æ¿å¼•æ“
> String content = templateEngine.process("/mail/activation",context);
> mailClient.sendMail(user.getEmail(), "è´¦å·æ¿€æ´»",content);
> ```
>
> 

```java
//userService
    public Map<String,Object> register(User user){
        Map<String ,Object> map = new HashMap<>();
        //å…ˆå¯¹ç©ºå€¼åšåˆ¤æ–­
        if(user==null){
            throw new IllegalArgumentException("å‚æ•°ä¸ä¸ºç©º");
        }
        if(StringUtils.isBlank(user.getUserName())){
            map.put("usernameMsg","è´¦å·ä¸èƒ½ä¸ºç©º!");
            return map;
        }
        if(StringUtils.isBlank(user.getPassword())){
            map.put("passwordMsg","å¯†ç ä¸èƒ½ä¸ºç©º!");
            return map;
        }
        if(StringUtils.isBlank(user.getEmail())){
            map.put("emailMsg","é‚®ç®±ä¸èƒ½ä¸ºç©º!");
            return map;
        }
        //è´¦å·æ˜¯å¦å­˜åœ¨
        User u = userMapper.selectByName(user.getUserName());
        if(u!=null){
            map.put("usernameMsg","è´¦å·å·²å­˜åœ¨!");
            return map;
        }
        //é‚®ç®±éªŒè¯
        u = userMapper.selectByEmail(user.getEmail());
        if(u!=null){
            map.put("emailMsg","è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ!");
            return map;
        }
        //å¯ä»¥æ³¨å†Œäº†
        user.setSalt(CommunityUtil.generateUUID().substring(0,5));
        user.setPassword(CommunityUtil.md5(user.getPassword()+user.getSalt()));
        user.setType(0);//æ™®é€šç”¨æˆ·
        user.setStatus(0);//æœªæ¿€æ´»
        user.setActivationCode(CommunityUtil.generateUUID());//ç”Ÿæˆä¸€ä¸ªæ¿€æ´»ç 
        //ä¸ºç”¨æˆ·è®¾ç½®éšæœºå¤´åƒï¼Œç‰›å®¢ç½‘çš„å¤´åƒåº“æœ‰0-1000 å·å¤´åƒ
        user.setHeaderUrl(String.format("http://images.nowcoder.com/head/%dt.png",new Random().nextInt(1000)));
        user.setCreateTime(new Date());
        userMapper.insertUser(user);
        //ç»™ç”¨æˆ·å‘é‚®ä»¶ï¼Œç”¨äºæ¿€æ´» æ¨¡æ¿ activation.html
        Context context = new Context();
        context.setVariable("email",user.getEmail());
        //åŠ¨æ€æ‹¼æ¥ç”¨æˆ·èƒ½ç‚¹çš„è·¯å¾„ï¼ˆæ¯ä¸ªç”¨æˆ·çš„æ¿€æ´»é¡µé¢æ˜¯ä¸åŒçš„ï¼‰ :101 æ˜¯ç”¨æˆ·idï¼Œcodeæ˜¯æ¿€æ´»ç 
        //http://localhost:8080/community/activation/101/code
        String url = domain+contextPath+"/activation/"+user.getId()+"/"+user.getActivationCode();
        context.setVariable("url",url);
        //ç”Ÿæˆæ¨¡æ¿å¼•æ“
        String content = templateEngine.process("/mail/activation",context);
        mailClient.sendMail(user.getEmail(), "è´¦å·æ¿€æ´»",content);
        return map;
    }
```

7.æ§åˆ¶å™¨

> 1. å°†userServiceæ³¨å…¥
>
> 2. å®šä¹‰æ–¹æ³•å¤„ç†ç”¨æˆ·çš„æ³¨å†Œè¯·æ±‚ï¼šregisteré¡µé¢  post
>
>    ```java
>    @RequestMapping(path = "/register",method = RequestMethod.POST)
>        public String register(Model model, User user)
>    ```
>
>    
>
>    ```java
>    		Map<String,Object> map = userService.register(user);
>            if(map==null||map.isEmpty()){
>                model.addAttribute("msg","æ³¨å†ŒæˆåŠŸï¼Œæˆ‘ä»¬å·²å‘ä½ çš„é‚®ç®±å‘é€äº†æ¿€æ´»é‚®ä»¶ï¼Œè¯·å°½å¿«æ¿€æ´»ï¼");
>                model.addAttribute("target","/index");
>                return "/site/operate-result";//è·³è½¬åˆ°è·³è½¬é¡µé¢
>            }else{//æºå¸¦ä¿¡æ¯ï¼Œé‡æ–°å›åˆ°æ³¨å†Œé¡µé¢ï¼ŒæŠŠserviceå±‚çš„ä¸‰ä¸ªä¿¡æ¯éƒ½å‘å›ï¼Œå¦‚æœæ˜¯ç©ºçš„å°±ä¸æ˜¾ç¤º
>                model.addAttribute("usernameMsg",map.get("usernameMag"));
>                model.addAttribute("passwordMsg",map.get("passwordMag"));
>                model.addAttribute("emailMsg",map.get("emailMag"));
>                model.addAttribute("user",user);//æµ‹è¯•
>                return "/site/register";
>    ```

8.æ¿€æ´»è´¦å·

> åœ¨serviceå±‚æ·»åŠ ä¸šåŠ¡
>
> ```java
> 	public int activation(int userId,String code){//ä¼ å…¥ç”¨æˆ·idï¼Œå’Œæ¿€æ´»ç codeï¼ŒæŸ¥è¯¢æ¿€æ´»ç 
>         User user = userMapper.selectById(userId);
>         if(user.getStatus()==1){//å·²ç»æ¿€æ´»äº†
>             return ACTIVATION_REPEAT;
>         }else if(user.getActivationCode().equals(code)){
>             userMapper.updateStatus(userId,1);//ä¿®æ”¹æ¿€æ´»çŠ¶æ€
>             return ACTIVATION_SUCCESS;
>         }else {
>             return ACTIVATION_FAILURE;
>         }
>     }
> ```
>
> Controller
>
> ```java
> @RequestMapping(path = "/activation/{userId}/{code}",method = RequestMethod.GET)
>     public String activation(Model model, @PathVariable("userId") int userId,@PathVariable("code") String code){
>         int result = userService.activation(userId,code);
>         if(result==ACTIVATION_SUCCESS){
>             model.addAttribute("msg","æ¿€æ´»æˆåŠŸï¼");
>             model.addAttribute("target","/login");
>         }else if(result==ACTIVATION_REPEAT){
>             model.addAttribute("msg","è¯¥è´¦å·å·²ç»æ¿€æ´»è¿‡ï¼");
>             model.addAttribute("target","/index");
>         }else{
>             model.addAttribute("msg","æ¿€æ´»å¤±è´¥ï¼");
>             model.addAttribute("target","/index");
>         }
>         return "/site/operate-result";
>     }
> ```
>
> 

## 8.14

### è´¦å·è®¾ç½®ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰

è¯·æ±‚:å¿…é¡»æ˜¯POSTè¯·æ±‚ï¼Œ
è¡¨å•: enctype= "multipart/form-data
Spring MVC:é€šè¿‡MultipartFileå¤„ç†.ä¸Šä¼ æ–‡ä»¶

## 8.15

### æ£€æŸ¥ç™»å…¥çŠ¶æ€

å¦‚æœæœ‰äººçŸ¥é“ä¸€äº›è·¯å¾„ï¼Œå°±å¯ä»¥åœ¨æ²¡ç™»å…¥æ—¶è¿›å…¥æŸäº›é¡µé¢ï¼Œåº”è¯¥é…ç½®æ‹¦æˆªå™¨é˜»æ­¢éæ³•è®¿é—®ã€‚

```
â—ä½¿ç”¨æ‹¦æˆªå™¨
-åœ¨æ–¹æ³•å‰æ ‡æ³¨è‡ªå®šä¹‰æ³¨è§£
æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œåªå¤„ç†å¸¦æœ‰è¯¥æ³¨è§£çš„æ–¹æ³•
â—è‡ªå®šä¹‰æ³¨è§£
å¸¸ç”¨çš„å…ƒæ³¨è§£:
@Targetã€@Retentionã€@Documentã€ @Inherited
å¦‚ä½•è¯»å–æ³¨è§£:
Method . getDeclaredAnnotations ()
Method . getAnnotation (Class<T> annotationClass)
```

1.å…ˆå®šä¹‰æ³¨è§£

```java
@Target(ElementType.METHOD)
@Retention(RetentionPoliy.RUNTIME)
public @interface LOginRequired{
    //ä¸ç”¨å†™ä¸œè¥¿ï¼Œåªæ˜¯æ ‡è®°çš„ä½œç”¨
}
```

2.åœ¨éœ€è¦çš„æ–¹æ³•å‰åŠ ä¸Šè¯¥æ³¨è§£

3.å®šä¹‰æ‹¦æˆªå™¨

```java
@Autowired
public HostHolder hostHolder;//å°è¯•è·å–å½“å‰çš„ç”¨æˆ·æ¥åˆ¤æ–­ç™»å…¥

@Component
public Class LoginRequiredIntercepter implements HandlerInceptor{
    @override
    public boolean prehander(HttpServletRequest request,HttpServlet response, Object handler) throws Exception{
        //å‚æ•°çš„ Object handleræ˜¯æ‹¦æˆªçš„ç›®æ ‡ï¼Œç›®æ ‡æ˜¯æ–¹æ³•æ‰èƒ½æ‰§è¡Œ
        if(handler instanceof HandlerMethod){
            HandlerMethod handlerMethod = (HandlerMethod) handler;
            //é€šè¿‡å®ƒçš„æ–¹æ³•æ¥ç›´æ¥è·å–æ‹¦æˆªåˆ°çš„æ–¹æ³•
            sMethod method = handlerMethod.getMethod();
            //æœ‰äº†æ–¹æ³•å¯¹è±¡ï¼Œå°è¯•ä»æ–¹æ³•å¯¹è±¡ä¸­è·å–æ³¨è§£
            LoginRequired loginRequired = method.getAnnotation(LoginRequired.class);
            if(loginRequired != null && hostHolder.getUser()== null){//ä¸”è·å–ä¸åˆ°ç™»å…¥ç”¨æˆ·
                response.sendRedirect(request.getContextPath()+"/login");
                return false;
            }
        }
    }
  
}
```

4.å°†æ‹¦æˆªå™¨æ³¨å…¥WebMvcConfig

```java
//1.å…ˆæ³¨å…¥
@Autowired
private LoginRequiredInterceptor loginRequiredInterceptor;
//2.ç„¶ååœ¨addInterceptoråŠ å…¥
registry.addInterceptor().excludePathPatterns()
```

# 9

é¡¹ç›®ç›®å½•

### 3.1 è¿‡æ»¤æ•æ„Ÿè¯ğŸ”°

â€‹	å‰ç¼€æ ‘ï¼Œå»ºæ ‘ï¼Œåˆå§‹åŒ–postConstructï¼Œå­—ç¬¦åŒ¹é…

### 3.6 å‘å¸ƒå¸–å­ğŸ”°

å¼‚æ­¥å¤„ç†AJAXï¼ˆé‡‡ç”¨JSONï¼‰
![image-20220901153603403](Resources/image-20220901153603403.png)

Serviceå±‚--å‘å¸ƒå¸–å­+æ•æ„Ÿè¯è¿‡æ»¤

![image-20220901155938935](Resources/image-20220901155938935.png)

Controllerå±‚

![image-20220901160251008](Resources/image-20220901160251008.png)

### 3.11 å¸–å­è¯¦æƒ…ğŸ”°

ä¼ å…¥å¸–å­id

![image-20220902201311496](Resources/image-20220902201311496.png)

serviceå±‚

![image-20220902203130250](Resources/image-20220902203130250.png)

Controllerå±‚ï¼šä½¿ç”¨åˆ°Rustfulé£æ ¼ï¼Œéœ€è¦å°†discussPostIdä¼ å…¥ï¼Œä½¿ç”¨ `@PathVariable`
		è¿‡ç¨‹ï¼šè°ƒç”¨ä¸šåŠ¡å±‚ï¼Œå°†å¸–å­ä¿¡æ¯æŸ¥è¯¢ï¼Œå°†å¾—åˆ°ç»“æœç»™Model ï¼Œé€šè¿‡`addAttribute` 
					éœ€è¦å°†æŸ¥åˆ°çš„userIdè½¬åŒ–ä¸ºç”¨æˆ·ä¿¡æ¯ï¼Œè°ƒç”¨UserServiceæ¥è·å–
					ï¼ˆä»¥åå¼€å‘ï¼‰å¸–å­çš„å›å¤

![image-20220904135725383](Resources/image-20220904135725383.png)

### 3.13 äº‹åŠ¡ç®¡ç†ğŸ”°

![image-20220904185950992](Resources/image-20220904185950992.png)

![image-20220904190029553](Resources/image-20220904190029553.png)

å£°æ˜å¼äº‹åŠ¡ç®¡ç†ï¼š

éœ€è¦åŠ ä¸Šæ³¨è§£è¡¨ç¤ºæ˜¯äº‹åŠ¡

<img src="Resources/image-20220905180332040.png" alt="image-20220905180332040" style="zoom:67%;" />

è¿˜æœ‰ä¸€ä¸ªå‚æ•°æ˜¯äº‹åŠ¡ä¼ æ’­æœºåˆ¶ï¼šè¡¨ç¤ºè°ƒç”¨äº†å¦ä¸€ä¸ªäº‹åŠ¡

<img src="Resources/image-20220905180807004.png" alt="image-20220905180807004" style="zoom:80%;" />

æˆ‘ä»¬æ–°å»ºä¸€ä¸ªæµ‹è¯•ç±»ï¼šï¼ˆå‰é¢å…ˆåŠ ä¸Šæ³¨è§£ï¼‰

<img src="Resources/image-20220905180953135.png" alt="image-20220905180953135" style="zoom:80%;" />

ç¼–ç¨‹å¼äº‹åŠ¡ï¼š

![image-20220905183350572](Resources/image-20220905183350572.png)

### 3.20 æ˜¾ç¤ºè¯„è®ºğŸ”°

<img src="Resources/image-20220905183619146.png" alt="image-20220905183619146" style="zoom:67%;" />

1.é¦–å…ˆå®šä¹‰å®ä½“entityï¼Œä¸æ•°æ®åº“ä¸­å±æ€§å¯¹åº”

<img src="Resources/image-20220905183928359.png" alt="image-20220905183928359"  />

2.æ•°æ®è®¿é—®å±‚ï¼š

![image-20220905184113536](Resources/image-20220905184113536.png)

3.Mapper

![image-20220905184326486](Resources/image-20220905184326486.png)

4.æ–°å¢ä¸šåŠ¡ç»„ä»¶

![image-20220905184743496](Resources/image-20220905184743496.png)

æŸ¥è¯¢å¸–å­çš„ä¸šåŠ¡åœ¨å¸–å­è¯¦æƒ…Discusspostä¸šåŠ¡ä¸Š

### 3.22 æ·»åŠ è¯„è®ºğŸ”°

åœ¨ä¸šåŠ¡å±‚ï¼šæ·»åŠ è¯„è®ºï¼Œå†æ›´æ–°è¯„è®ºæ•°é‡ï¼Œæ˜¯ä¸¤ä¸ªDMLæ“ä½œï¼Œéœ€è¦ä½¿ç”¨åˆ°**äº‹åŠ¡ç®¡ç†**

![image-20220909144145833](Resources/image-20220909144145833.png)

mapperï¼š

![image-20220909144457992](Resources/image-20220909144457992.png)

ç”±äºæ–°å¢äº†è¯„è®ºï¼Œåˆ™éœ€è¦å†DiscussPostä¸šåŠ¡ä¸­æ–°å¢ â€œæ›´æ–°è¯„è®ºæ•°é‡â€ï¼Œä½¿å¾—æŸ¥çœ‹å¸–å­å°±èƒ½æŸ¥çœ‹è¯„è®º

![image-20220909144750764](Resources/image-20220909144750764.png)

åœ¨ä¸šåŠ¡å±‚æ·»åŠ ï¼š

![image-20220909144850838](Resources/image-20220909144850838.png)

æœ¬å°èŠ‚é‡ç‚¹ï¼šå¢åŠ è¯„è®ºï¼Œåœ¨serviceå±‚æ–°å¢
ç”±äºè¿™å…¶ä¸­åŒ…å«ä¸¤ä¸ªDMLï¼Œå› æ­¤é‡‡ç”¨äº‹åŠ¡ç®¡ç†

![image-20220909145009155](Resources/image-20220909145009155.png)
åªéœ€è¦å¢åŠ æ³¨è§£ï¼š

![image-20220909145207332](Resources/image-20220909145207332.png)
å¢åŠ è¯„è®ºéœ€è¦å¤„ç†*htmlæ ‡ç­¾è¿‡æ»¤*å’Œ*æ•æ„Ÿè¯è¿‡æ»¤*ï¼š

![image-20220909145330127](Resources/image-20220909145330127.png)
![image-20220909145618492](Resources/image-20220909145618492.png)

Controllerï¼š

![image-20220909151715501](Resources/image-20220909151715501.png)

### 3.24ç§ä¿¡åˆ—è¡¨

### 3.27 å‘é€ç§ä¿¡

### 3.31 ç»Ÿä¸€å¤„ç†å¼‚å¸¸ğŸ”°

ç”±spring æä¾›çš„æ³¨è§£ï¼š

![image-20220909152817672](Resources/image-20220909152817672.png)

å°†é”™è¯¯é¡µé¢æ·»åŠ åˆ°templateç›®å½•ä¸‹ï¼šç”±springBootç»Ÿä¸€å¤„ç†

![image-20220909153120626](Resources/image-20220909153120626.png)

ä¸ºäº†å®Œå–„å¼‚å¸¸å¤„ç†å’Œé€šçŸ¥ï¼šå®Œæˆä»¥ä¸‹é…ç½®

åœ¨Controlleræ–°å»ºåŒ…adviceï¼Œæ–°å»ºç±» ExceptionAdviceï¼Œä½¿ç”¨æ³¨è§£ `@ControllerAdvice`ï¼Œè¿™æ ·ç»„ä»¶ä¼šæ‰«ææ‰€æœ‰çš„beanï¼Œå› æ­¤é™å®šå…¶æ‰«æå¸¦æœ‰Conrtrolleræ³¨è§£çš„bean
![image-20220909154548170](Resources/image-20220909154548170.png)

æ–¹æ³•ï¼š

```java
@ControllerAdvice(annotation = Controller.class)
public class ExceptionAdvice{
   //å…ˆå°†æ—¥å¿—ç»„ä»¶æ³¨å…¥
    private static final Logger logger = LoggerFactory.getLogget(EcxeptionAdvice.class);
    //å¤„ç†å¼‚å¸¸çš„æ–¹æ³•éœ€è¦è¿™ä¸ªæ³¨è§£
    //æ–¹æ³•å¿…é¡»æ˜¯ public void çš„ï¼Œå‚æ•°æ˜¯Exceptionï¼Œå’Œreqï¼Œresp
  	public void handler(Exception e,HttpServletRequest request,HttpServletResponse response)
    throws IOException{
        //å°†å¼‚å¸¸è®¡å…¥æ—¥å¿—
        logger.error("æœåŠ¡å™¨å‘ç”Ÿå¼‚å¸¸:"+e.getMessage());
        //æˆ‘ä»¬æƒ³æ›´è¯¦ç»†çš„å¼‚å¸¸ä¿¡æ¯ï¼šæ ˆä¿¡æ¯ï¼šéå†æ ˆ
        //æ ˆä¸­å…ƒç´ æ˜¯ StackTraceElement
        for(StackTraceElement elemnt :e.getStackTrace()){
            logger.error(element.tostring());
        }
        //ç”±äºè¿™é‡Œæ˜¯é‡å®šå‘ 500è¿™ä¸ªé¡µé¢ï¼Œåªé€‚ç”¨äºåŒæ­¥çš„è¯·æ±‚
        //å¦‚æœæ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œéœ€è¦è¿”å›json/XML
        //é€šè¿‡requestæ¥åˆ¤æ–­
       String xRequestedWith =  request.getHeader("x-requested-with");
        if("XMLHttpRequest"==xRequestedWith){//å‘ç°æ˜¯å¼‚æ­¥è¯·æ±‚
            response.setContentType("application/plain;charset=utf-8");
            PrintWriter writer = response.getWriter();//è¿™é‡Œéœ€è¦æŠ›å‡ºå¼‚å¸¸
            writer.write(CommunityUtil.getJSONString(1,"æœåŠ¡å™¨å¼‚å¸¸"));
        }else{//æ˜¯æ™®é€šè¯·æ±‚çš„è¯ï¼Œå°±é‡å®šå‘
            response.sendRedirect(request.getContextPath()+"/error");
        }
    }
}
//ä½¿ç”¨è¯¥æ–¹æ³•çš„å¥½å¤„æ˜¯ï¼Œä¸éœ€è¦åœ¨ä»»ä½•Controllerä¸Šæ”¹åŠ¨å°±èƒ½ç»Ÿä¸€å¤„ç†é—®é¢˜
```



### 3.33 ç»Ÿä¸€è®°å½•æ—¥å¿—ğŸ”°

é‡‡ç”¨AOP

![image-20220910131517908](Resources/image-20220910131517908.png)

![image-20220910131853845](Resources/image-20220910131853845.png)

![image-20220910132434989](Resources/image-20220910132434989.png)

```java
@Component
@Aspect
public class ServiceLogAspect{
    private static final Logger logger = LoggerFactory.getLogger(ServiceLogAspect);
    //é¦–å…ˆç”³æ˜åˆ‡ç‚¹
    //åŠ ä¸Š PointCutæ³¨è§£
    @PointCut("execution(* com.nowcoder.community.service.*.*(..))")
    public void pointCut(){
    }
    
    //ä½¿ç”¨å‰ç½®é€šçŸ¥
    @Before("pointCut()")
    public void before(){
        //æ ¼å¼ ç”¨æˆ·[ip] åœ¨ XXXæ—¶é—´è®¿é—®äº† XXXæ–¹æ³•
        //è¿™é‡Œéœ€è¦è·å–ç”¨æˆ·åœ°å€ï¼Œä½†ä¸è¦åœ¨è¿™å£°æ˜Requestå¯¹è±¡ï¼Œè€Œä½¿ç”¨å·¥å…·ç±»RequestContextHolder
        ServletReqeustAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();
        String ip = request.getRemoteHost();
        String now = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date());
        //æœ€åè®¿é—®æŸä¸ªç±»çš„æ–¹æ³•ï¼Œéœ€è¦è¿æ¥ç‚¹jointPoint
        String target = jointPoint.getSignature().getDeclaringTypeName()+"."+jointPoint.getSignature().getName();
        logger.info(String.format("ç”¨æˆ·[%s]ï¼Œåœ¨[%s]è®¿é—®äº†[%s].",ip,now,target));
    }
    
}
```



### 4.1 redisğŸ”°

![image-20220910145214386](Resources/image-20220910145214386.png)

å¿«ç…§å½¢å¼ï¼šRDBï¼šæ•´ä½“å­˜å…¥ç¡¬ç›˜ä¸­

æ—¥å¿—å½¢å¼ï¼šAOFï¼šå°†æ—¥å¿—è®°å…¥ç¡¬ç›˜ä¸­ï¼Œå®æ—¶æ€§å¥½ï¼Œä½†ç»´æŠ¤è€—æ—¶

åœ¨githubä¸‹è½½windowsçš„redisï¼Œå®‰è£…åè‡ªåŠ¨è¿è¡Œï¼Œå…¶é»˜è®¤ç«¯å£å·ä¸ºï¼š6379.å°†å…¶é…ç½®åœ¨ç³»ç»Ÿå˜é‡

![image-20220910172826392](Resources/image-20220910172826392.png)

```shell
redis-cli #å¯åŠ¨å®¢æˆ·ç«¯
#ç³»ç»Ÿé»˜è®¤16ä¸ªåº“ï¼Œé‡‡ç”¨0-15å‘½å
>>select 1	#åˆ‡æ¢åˆ°åº“1
OK
>>flushdb  #åˆ·æ–°å†…å®¹
#String ç±»å‹
>>set test:count 1
OK
>>get test:count
"1"
>>incr test:count #å˜é‡è‡ªå¢
(integer) 2
>>decr test:count
(integer) 1
```

```shell
# Hash ç±»å‹æ•°æ®,å€¼ä¹Ÿæ˜¯é”®å€¼å¯¹  hset KEY FIELD VALUE
>>hset test id 1
(integer) 1
>>hset test username zhangshan
"zhanshan"
>>hget test id
"1"
```

```shell
# List åˆ—è¡¨:æ”¯æŒå·¦ã€å³æ’å…¥   å·¦ã€å³å–å€¼
>>lpush test 101 102 103  #ç›¸å½“äºå°†101ï¼Œ102ï¼Œ103å·¦æ’å…¥åˆ—è¡¨ï¼Œæ­¤æ—¶ä¸º[103, 102, 101]
(integer) 3
>>llen test
3
>>lindex test 0
103
>>lrange test 0 2 #è¡¨ç¤ºèŒƒå›´ä»0åˆ°2
1) "103"
2) "102"
3) "101"
>>rpop test  #ä»å³ä¾§å¼¹å‡º
"101"
```

```shell
#Set é›†åˆ
>>sadd test aaa bbb ccc ddd eee
(integer) 5
>>sard test # ç»Ÿè®¡å¤šå°‘å…ƒç´ 
(integer) 5
>>spop test #éšæœºå¼¹å‡ºä¸€ä¸ªå…ƒç´ 
"ccc"
>>smembers test # é›†åˆå‰©ä½™å…ƒç´ 
1) "aaa"
2) "bbb"
3) "ddd"
4) "eee"
```

```shell
#socket setæœ‰åºé›†åˆ :ç»™å®šåˆ†æ•°ï¼ŒæŒ‰åˆ†æ•°æ’åº
>>zadd test 10 aaa 20 bbb 30 ccc 40 ddd 50 eee
(integer) 5
>>zcard test # ç»Ÿè®¡å¤šå°‘å…ƒç´ 
(integer) 5
>>zscore test ccc #æŸ¥è¯¢æŸä¸ªå€¼çš„åˆ†æ•°
"30"
>>zrank test ccc # è¿”å›æŸä¸ªå€¼çš„æ’å
(integer) 2
>>zrange test 0 2
"aaa"
"bbb"
"ccc"
```

```shell
#å…¨å±€å‘½ä»¤
 >>keys * #æŸ¥è¯¢åº“ä¸­æœ‰å¤šå°‘
 >>keys t* #ä»¥ t å¼€å¤´çš„æœ‰å¤šå°‘ä¸ª
 >>type test # æŸ¥è¯¢æ˜¯ä»€ä¹ˆæ•°æ®ç±»å‹çš„
 >>exists test #æŸ¥è¯¢æ˜¯å¦å­˜åœ¨
 >> del
 >>expire test 60 #è®¾ç½®è¯¥keysçš„è¿‡æœŸæ—¶é—´ä¸º60sï¼Œç”¨äºéªŒè¯ç 

```



### 4.7 springboot æ•´åˆredisğŸ”°

![image-20220910195751926](Resources/image-20220910195751926.png)

Springbootå°†Redisçš„é”®å€¼å¯¹çš„é”®ç”±Stringè½¬æˆObjectï¼Œä½†æˆ‘ä»¬å¸¸ç”¨è¿˜æ˜¯Stringï¼Œå› æ­¤è¦é‡æ–°é…ç½®

é¦–å…ˆåœ¨application.propertiesé…ç½®

```shell
spring.redis.database=11 #éšä¾¿é€‰ä¸€ä¸ªåº“å°±è¡Œ
spring.redis.host=localhost
spring.redis.port=6379
```

ç¼–å†™é…ç½®ç±»ï¼š

```java
@Configuration
public class RedisConfig{
    @Bean
    public RedisTemplate<String,Object> redisTemplate(RedisConnectionFactory factory){
        //è¦èƒ½è®¿é—®æ•°æ®åº“ï¼Œéœ€è¦åˆ›å»ºè¿æ¥ï¼šæ³¨å…¥å·¥å‚(åœ¨å½¢å‚ä¸­æ³¨å…¥)
        //åœ¨æ–¹æ³•ä¸­å®ä¾‹åŒ–Bean
        RedisTemplate<String,Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        //ä¸»è¦é…çš„æ˜¯åºåˆ—åŒ–çš„æ–¹å¼ï¼ˆå°†javaæ•°æ®å­˜å…¥redisï¼‰
        //1.è®¾ç½®keyçš„åºåˆ—åŒ–æ–¹å¼
        template.setKeySerializer(RedisSerializer.string());
        //2.è®¾ç½®valueçš„åºåˆ—åŒ–æ–¹å¼
        template.setValueSerializer(RedisSerilalizer.json());
        //ç‰¹æ®Šï¼šè®¾ç½®hashçš„keyçš„åºåˆ—åŒ–æ–¹å¼
        template.setHashKeySerializer(RedisSerializer.string());
        //ç‰¹æ®Šï¼šè®¾ç½®hashçš„valueåºåˆ—åŒ–æ–¹å¼
        template.setHashValueSerialize(RedisSerializer.json());
        //ä½¿è®¾ç½®çš„é…ç½®ç”Ÿæ•ˆ
        template.afterPropertiesSet();
        return template;
    }
}
```

```java
//æµ‹è¯•
@Autowired
private RedisTemplate redisTemplate;
@Test
public void testStrings(){
    String redisKey = "test:count";
    redisTemplate.opsForValue().set(redisKey,1);
    sout(redisTemplate.opsForValue().get(redisKey));
    sout(redisTemplate.opsForValue().increment(redisKey));
}
```

æµ‹è¯•HashåŒç†

![image-20220910205107028](Resources/image-20220910205107028.png)

æµ‹è¯•åˆ—è¡¨

![image-20220910205259621](Resources/image-20220910205259621.png)

æµ‹è¯•é›†åˆ

![image-20220910205506828](Resources/image-20220910205506828.png)

å¯¹Keysçš„æµ‹è¯•

![image-20220910205656523](Resources/image-20220910205656523.png)



![image-20220912140722395](Resources/image-20220912140722395.png)

ç¼–ç¨‹å¼äº‹åŠ¡

![image-20220912141747691](Resources/image-20220912141747691.png)

ç”±`multi()` å¼€å¯äº‹åŠ¡ï¼Œç”±`exec()`æäº¤äº‹åŠ¡ï¼Œåœ¨äº‹åŠ¡ä¹‹é—´çš„æ“ä½œä¿å­˜åœ¨é˜Ÿåˆ—é‡Œå¹¶ä¸ä¼šæ‰§è¡Œï¼Œå› æ­¤æŸ¥è¯¢è¯­å¥ä¸ä¼šæ˜¾ç¤ºæŸ¥åˆ°ç»“æœ

### 4.10 ç‚¹èµğŸ”°

ç”±äºredisæ“ä½œç®€å•ï¼Œå› æ­¤ä¸å¼€å‘mapperï¼Œè€Œç›´æ¥å¼€å‘serviceå±‚ï¼Œé¢å‘**key** å®ç°

```java
//å…ˆå†™ä¸ªå·¥å…·ç±»
public class RedisKeyUtil{
    private static final String SPLIT = ":";//å­˜ä¸‹åˆ†éš”ç¬¦
    //æˆ‘ä»¬å°†å¸–å­å’Œå¸–å­çš„è¯„è®ºç§°ä¸ºå®ä½“
    private static final String PREFIX_ENTITY_LIKE = "like:entity";
    
    //è¿”å›æŸä¸ªå®ä½“çš„èµï¼Œæ‹¼æˆä»¥ä¸‹å½¢å¼ï¼š//å°†ç‚¹è¿‡èµçš„ç”¨æˆ·idå­˜å…¥é›†åˆä¸­
    // like:eneity:{entityType}:{entityId} -> set(userId)
    public static String getEntityLikeKey(int entityType,int entityId){
        return PREFIX_ENTITY_LIKE + SPLIT + entityType + SPLIT + entityId;
    }
}
```

```java
// LikeService
@Service
public class LikeService{
    @Autowired
    private RedisTemplate redisTemplate;
    
    //ç‚¹èµ
    public void like(int userId,int entityType,int entityId){
        //å­˜å…¥Redisçš„keyç»Ÿä¸€å‘½å
        String entityLikeKey = RedisKeyType.getEntityLikeKey(entityType,entityId);
        //æ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼ˆç‚¹è¿‡èµå†æ¬¡ç‚¹å‡»å°±æ˜¯å–æ¶ˆï¼‰
        boolean isMember = redisTemplate.opsForSet().idMemeber(entityLikeKey,userId);
        if(isMember){
            redisTemplate.opsForSet().remove(entityLikeKey,useId);
        }else{//å¦åˆ™å°±æ·»åŠ æ•°æ®
            redisTemplate.opsForSet().add(entityLikeKey,useId);
        }
    }
    
    //æŸ¥è¯¢å®ä½“çš„ç‚¹èµæ•°é‡
    public long findEntityLikeCount(int entityType,int entityId){
        String entityLikeKey = RedisKeyType.getEntityLikeKey(entityType,entityId);
        return redisTemplate.opsForSet().size(entityLikeKey);
    }
    //æŸ¥è¯¢æŸäººå¯¹æŸå®ä½“çš„ç‚¹èµçŠ¶æ€ï¼Œè¿”å›æ•´æ•°ï¼ˆä»¥åä¸šåŠ¡æ‰©å±•å‡ºç‚¹è¸©ï¼‰
    public int findEntityLikeStatus(int userId,int entityType,int entityId){
        String entityLikeKey = RedisKeyType.getEntityLikeKey(entityType,entityId);
        return redisTemplate.opsForSet().isMember(entityLikeKey,userId)?1:0;
    }
}
```

```java
//è¡¨ç°å±‚ï¼šç‚¹èµæ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œå³ä½¿åˆ·æ–°
@Controller
public class LikeController{
    @Autowired
    private LikeService likeService;
    @Autowired
    private HostHolder hostHolder;
    
    @Requestmapping(path = "/like",method =RequestMethod.POST)
    @ResponseBody//å¼‚æ­¥è¯·æ±‚
    public String liek(int eneityType,int entityId){
        User user = hostHolder.getUser();
        //ä»¥åä¼šä½¿ç”¨Spring Securityå¯¹æ‹¦æˆªå™¨é‡æ„
        //ç‚¹èµå®ç°
        likeService.like(user.getId(),entityType,entityId);
        //æ•°é‡
        long likeCount = likeService.findEntityLikeCount(entityType,entityId);
        //çŠ¶æ€	
        int likeStatus = likeService.findEntityLikeStatus(user.getID(),entityType,entityId);
        //ç”¨map å°è£…
        Map<String,Object> map = new HashMap<>();
        map.put("likeCount",likeCount);
        map.put("likeStatus",likeStatus);
        //æœ€ç»ˆè¿”å›jsonæ ¼å¼æ•°æ®
        return CommunityUtil.getJsonString(0,null,map);//è¿™æ˜¯ä¹‹å‰å°è£…çš„å·¥å…·
    }
}
```

ä¿®æ”¹æ¨¡æ¿

æ‰¾åˆ°ç‚¹èµçš„ä½ç½®ï¼Œä¿®æ”¹hrefä¸ºç©ºï¼Œæ–°å¢ `onclick`æ ‡ç­¾ï¼Œé‡Œé¢è°ƒç”¨jså‡½æ•°`like(this,1,${post,id})`
this æ˜¯ä»æœ¬é¡µé¢ä¸‰ç§ç±»å‹çš„èµæ‰¾åˆ°ï¼Œ1æ˜¯è¡¨ç¤ºå¸–å­çš„entityType

![image-20220912151419460](Resources/image-20220912151419460.png)

è¿”å›çŠ¶æ€ï¼šèµæ˜¯æ•°é‡
![image-20220912151708160](Resources/image-20220912151708160.png)

å†™ä¸ªjsæ–‡ä»¶

![image-20220914221127201](Resources/image-20220914221127201.png)

btnæ˜¯å½“å‰æŒ‰é’®ï¼Œè·å–æŒ‰é’®ä¸‹çš„æ ‡ç­¾bï¼Œå’Œiï¼Œä¿®æ”¹å…¶å€¼

è¿è¡Œåå¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯åˆå§‹æ˜¾ç¤ºçš„èµæ•°é‡ä¸å¯¹



### 4.13 æˆ‘å—åˆ°çš„èµ

### 4.16 å…³æ³¨ã€å–æ¶ˆå…³æ³¨

### 4.19 å…³æ³¨åˆ—è¡¨ã€ç²‰ä¸åˆ—è¡¨

### 4.23 ä¼˜åŒ–ç™»å…¥æ¨¡å—



### 5.1é˜»å¡é˜Ÿåˆ—ğŸ”°

![image-20220914223339003](Resources/image-20220914223339003.png)



### 5.5 kafkağŸ”°

![image-20220914224515423](Resources/image-20220914224515423.png)

é«˜ååé‡ï¼Œæ¶ˆæ¯æŒä¹…åŒ–ï¼šå¯¹ç¡¬ç›˜çš„é¡ºåºè¯»å–æ•ˆç‡æ˜¯é«˜äºå†…å­˜çš„éšæœºè¯»å–çš„ã€‚
é«˜å¯é æ€§ï¼šæ˜¯åˆ†å¸ƒå¼çš„
Brokerï¼škafkaé›†ç¾¤ä¸Šæ¯ä¸€ä¸ª**æœåŠ¡å™¨**ç§°ä¸ºBroker
Zookeeperï¼šç”¨äºç®¡ç†é›†ç¾¤
Topicï¼šç”¨äºç‚¹å¯¹å¤šç”Ÿäº§æ¶ˆè´¹æ–¹å¼ï¼Œæ¶ˆè´¹è€…å‘å¸ƒåçš„ï¼Œ ç”¨äºå­˜æ”¾æ¶ˆæ¯çš„ä½ç½®
Partitionï¼šå¯¹topicä½ç½®çš„åˆ†åŒº
offsetï¼šæ¶ˆæ¯åœ¨åˆ†åŒºå†…å­˜æ”¾çš„ç´¢å¼•
Replicaï¼šå‰¯æœ¬ï¼Œä¸»å‰¯æœ¬å’Œä»å‰¯æœ¬ï¼ˆåªåšå¤‡ä»½ä¸åšå“åº”ï¼‰ï¼Œä¸»å‰¯æœ¬æŒ‚æ‰ï¼Œä¼šä»ä¼—å¤šä»å‰¯æœ¬é‡æ–°é€‰

ä¸‹è½½kafkaï¼Œåšåˆå§‹é…ç½®ã€‚ï¼ˆ.sh æ˜¯linuxå‘½ä»¤ï¼Œ.bat æ˜¯Windowså‘½ä»¤ï¼‰é»˜è®¤ç«¯å£æ˜¯9092

1.é…ç½®zookeeperï¼Œå°†åŸæœ¬liunxåœ°å€æ”¹æˆwindowsä¸‹åœ°å€

![image-20220914225749325](Resources/image-20220914225749325.png)ã€

![image-20220914225855475](Resources/image-20220914225855475.png)

2.é…ç½®server.propertiseï¼š![image-20220914230005260](Resources/image-20220914230005260.png)
é»˜è®¤æ—¥å¿—åœ°å€æ”¹ä¸ºwindows

å¯åŠ¨æµ‹è¯•ï¼šéœ€è¦å…ˆå¯åŠ¨zookeeperï¼Œå¹¶æŒ‡å®šé…ç½®æ–‡ä»¶

![image-20220914230232479](Resources/image-20220914230232479.png)

å†æ‰“å¼€å¦ä¸€ä¸ªå‘½ä»¤è¡Œï¼Œå¯åŠ¨kafka

![image-20220914230349079](Resources/image-20220914230349079.png)

æ‰§è¡Œä»¥ä¸‹ï¼š![image-20220916224450539](Resources/image-20220916224450539.png)

`--create` åˆ›å»ºä¸»é¢˜
`--bootstrap--server` åœ¨å“ªä¸ªä¸»é¢˜ä¸Š
`--replication-factor 1`  åˆ›å»º 1 ä¸ªå‰¯æœ¬
`--partitions 1`   ä¸€ä¸ªåˆ†åŒº
`--topic`  ä¸»é¢˜åå­—

æŸ¥è¯¢ä»¥ä¸‹æœ‰æ²¡æœ‰åˆ›å»ºæˆåŠŸï¼š![image-20220916224823102](Resources/image-20220916224823102.png)

æ¥ä¸‹æ¥å‘é€æ¶ˆæ¯ï¼Œä»¥ç”Ÿäº§è€…èº«ä»½è°ƒç”¨

![image-20220916224955009](Resources/image-20220916224955009.png)

`--broker-list` é€‰æ‹©æœåŠ¡å™¨ï¼ˆç°åœ¨åªæœ‰ä¸€ä¸ªï¼‰   `--topic test` é€‰æ‹©ä¸»é¢˜ã€‚å®Œæˆåä¸‹è¡Œå‡ºç°ä¸‰è§’

![image-20220916225154483](Resources/image-20220916225154483.png)

å‘é€äº†æ¶ˆæ¯ï¼Œç°åœ¨æ˜¯é˜»å¡çŠ¶æ€ï¼Œç„¶åæˆ‘ä»¬å†æ‰“å¼€ä¸€ä¸ªcmdå¯ç”¨æ¶ˆè´¹è€…

![image-20220916225340895](Resources/image-20220916225340895.png)

ç„¶ååœ¨ç”Ÿäº§è€…è¾“å…¥ï¼Œæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨å‡ºç°ï¼ˆæœ‰ç‚¹åƒèŠå¤©ï¼‰



### 5.9 springboot æ•´åˆkafkağŸ”°

springä¸­æ•´åˆçš„ä¸»è¦ä¾èµ–`kafkaTemplate`ï¼ˆç”¨çš„æ—¶å€™ç›´æ¥æ³¨å…¥ï¼‰

![image-20220916225524714](Resources/image-20220916225524714.png)

1.mvnå¼•å…¥kafka

2.é…ç½®properties

å…ˆæ‰“å¼€kafakæ–‡ä»¶çš„consumer.properties

![image-20220916225934873](Resources/image-20220916225934873.png)

![image-20220916230100151](Resources/image-20220916230100151.png)

å†™æµ‹è¯•

```java
public class KafkaTests{
    @Autowired
    private KafkaProducer kafkaProducer;
    @Test
    public void testKafka(){
        kafkaProducer.sendMessage("test","ä½ å¥½");
        kafkaProducer.sendMessage("test","åœ¨å—");
        //ç­‰å¾…ä¸€ä¸‹è®©æ¶ˆè´¹è€…è¾“å‡º
        try{
            Thread.sleep(10000);
        }catch(Exception e){
            e.printStackTrace();
        }
    }
}

//åœ¨è¿™é‡Œå†™ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
@Component
class KafkaProducer{
    @Autowired
    private KafkaTemplate kafkaTemplate;
    public void sendMessage(String topic,String content){//å‚æ•°æ˜¯ä¸»é¢˜å’Œå†…å®¹
        kafkaTemplate.send(topic,content);
    }
}

@Component
class KafkaConsumer{
    //ä¸éœ€è¦kafkaTemplateï¼Œå› ä¸ºæ˜¯è¢«åŠ¨çš„æ¥å—å‚æ•°
    @KafkaListener(topics={"test"})//springè‡ªåŠ¨ç›‘å¬è¿™äº›ä¸»é¢˜ï¼Œé˜»å¡ç›‘å¬ï¼Œç„¶åäº¤ç»™æ–¹æ³•
	public void handleMessage(ConsumerRecord record){
        sout(record);
    }
    
}
```

å…³é”®ç‚¹ï¼š**ç”Ÿäº§è€…æ˜¯ä¸»åŠ¨è°ƒç”¨çš„ï¼Œè€Œæ¶ˆè´¹è€…è¢«åŠ¨çš„**



### 5.11 å‘é€ç³»ç»Ÿé€šçŸ¥ğŸ”°



![image-20220916232907187](Resources/image-20220916232907187.png)

ä»¥äº‹ä»¶ä½œä¸ºé©±åŠ¨ï¼Œå®šä¹‰äº‹ä»¶class

```java
public class Event{
    private String topic;
    private int userId;
    private int entityType;
    private int entityId;
    private int entityUserId;
    private Map<String,Object> data = new HashMap<>();//å­˜å…¶ä»–è¿˜ä¸çŸ¥é“çš„ä¸œè¥¿
    //å¯¹åº”getterï¼Œsetter
    //ä¿®æ”¹setteræ–¹æ³•ï¼Œè¿”å›å€¼Eventï¼Œå¯ä»¥æ¯æ¬¡å¢åŠ ä¸€ä¸ªå±æ€§ï¼Œè¿”å›å†æ¬¡å¢åŠ 
    //ä¿®æ”¹setDataæ–¹æ³•ï¼Œä½¿ä¹‹ä¸è¦ç›´æ¥ä¼ mapï¼Œ
    public Event setData(String key,Object value){
        this.data.put(key,value);
        return this;
    }
}
```

æ¥ç€å¼€å‘äº‹ä»¶çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼š

æ–°å»ºä¸€ä¸ªåŒ…Event

```java
//ç”Ÿäº§è€…éœ€è¦è°ƒç”¨kafkaTemplate
public class EventProducer{
    @Autowired
    private KafkaTemplate kafkaTemplate;
    //å¤„ç†äº‹ä»¶
    //
    public void fireEvent(Event event){
        //å°†äº‹ä»¶å‘å¸ƒåˆ°æŒ‡å®šçš„ä¸»é¢˜
        //å†…å®¹ä¸ºjsonæ ¼å¼
        kafkaTemplate.send(event.getTopic(),JSONObject.toJSONString(event));
    }
}
```

```java
public class EventConsumer{
    private static final Logger logger = LoggerFactory.getLogger(EventConsumer.class);
    //å¤„ç†äº‹ä»¶æ˜¯ä¸ºäº†ç»™messageè¡¨æ’å…¥æ•°æ®
    @Autowired
    private MessageService messageService;
    //å¯ä»¥ä¸€ä¸ªæ–¹æ³•æ¶ˆè´¹ä¸€ä¸ªä¸»é¢˜ï¼Œä¸€ä¸ªæ–¹æ³•æ¶ˆè´¹å¤šä¸ªä¸»é¢˜
    @KafkaListener(topics={/*å†™åœ¨æ¥å£çš„å¸¸é‡*/TOPIC_COMMENT,TOPIC_LIKE,TOPIC_FOLLOW})
    public void handlerCommentMessage(ConsumerRecord record){
        if(record==null||record.value()==null){
            logger.error("æ¶ˆæ¯å†…å®¹ä¸ºç©º");return ;
        }
        //å°†JSONæ ¼å¼å­—ç¬¦ä¸²æ¢å¤æˆå¯¹è±¡
        Event event= JSONObject.parseObject(record.value().toString(),Event.class);
        if(event==null){
            logger.error("æ¶ˆæ¯æ ¼å¼é”™è¯¯");return;
        }
        Message message = new Message();
        message.setFromId(1);//æˆ–è€…å­˜å…¥æ¥å£å¸¸é‡
        message.setToID(event.getEntityUserId());
        message.setConversationId(event.getTopic());
        message.setCreateTime(new Date());
        
        //æˆ‘ä»¬éœ€è¦åœ¨é€šçŸ¥ä¸­æ‹¼å‡ºè¯­å¥ï¼Œè° å¹²äº†ä»€ä¹ˆï¼Œç„¶åé“¾æ¥åˆ°æŒ‡å®šä½ç½®
        Map<String,Object> content = new HashMap<>();
        content.put("userId",event.getUserID());//è·å–å“ªä¸ªç”¨æˆ·å¹²äº†ä»€ä¹ˆ
        content.put("entityType",event.getEntityEype());
        content.put("entityId",event.getEntityId());
        
        if(!event.getData().isEmpty()){
            for(Map.Entry<String,Object> entry:event.getData().entrySet()){
                content.put(entry.getKey(),entry.getValue());
            }
        }
        
        message.setContent(JSONObject.toJSONSTRING(content));
        messageService.add(message);
        //æ–¹æ³•æ˜¯æ¶ˆè´¹ä¸‰ä¸ªä¸»é¢˜çš„æ•°æ®ï¼Œæ¶ˆè´¹çš„é€»è¾‘æ˜¯å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯æ„é€ ä¸€æ ·
    }
}
```



```java
//CommentController æ·»åŠ 
//æ³¨å…¥äº‹ä»¶
@Autowired
private EventProducer eventProducer;//åœ¨LikeControllerå’ŒFollowControllerä¹Ÿè¦åŠ ä¸Š
//åœ¨addCommentå‡½æ•°ä¸­æ·»åŠ ä»£ç 
{
    //åœ¨commentService.addComment(comment); ä¹‹åæ“ä½œ
    //è§¦å‘è¯„è®ºäº‹ä»¶
    //1.æ„é€ äº‹ä»¶å¯¹è±¡ï¼Œå°†å†…å®¹åŒ…å«è¿›æ¥
    Event event = new Event().setTopic(1/*å¼•ç”¨å¸¸é‡*/).setUserId(hostHolder.getUser().getId())
        .setEntityType(comment.getEntityType())
        .setEntityId(comment.getEntityId())
        .setData("PostId",disscussPostId);//ç”¨äºé“¾æ¥æ—¶ éœ€è¦å¸–å­IDï¼Œè¿™é‡Œå­˜è¿›map
    //åŒºåˆ†å¸–å­è¿˜æ˜¯è¯„è®ºæ¥è·å¾—å¯¹åº”UserId
    if(commetn.getEntityType()==?){
        DiscussPost target = discussPostService.findDiscussPostById(comment.getEntityId());
        event.setEntityUserId(target.getUserId());
    }else{
        //..
    }
    //ä¹‹åæˆ‘ä»¬å†è°ƒç”¨Producerå¤„ç†äº‹ä»¶
    eventProducer.fireEvent(event);//æ–°çº¿ç¨‹æ‰§è¡Œï¼Œä¸ä¼šå½±å“åç»­ä¸šåŠ¡
}


```















### 5.13 æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥

å°†ä¸Šä¸€èŠ‚å­˜å…¥æ•°æ®åº“çš„é€šçŸ¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š

![image-20221008203456892](Resources/image-20221008203456892.png)

daoå±‚

```java
//MessageMapperæ·»åŠ ï¼š
//æŸ¥è¯¢æŸä¸ªä¸»é¢˜ä¸‹æœ€æ–°é€šçŸ¥     æŸ¥è¯¢æŸä¸ªä¸»é¢˜ä¸‹é€šçŸ¥æ•°é‡	æœªè¯»çš„é€šçŸ¥æ•°é‡
Message selectLatestNotice(int userId,String topic);
int selectNoticeCount(int userId,String topic);
int selectNoticeUnreadCount(int userId,String topic);

```

mapper

```xml
<!--Message-mapper-->
<select id="selectLatestNotice" resultType="Message">
	select <include refid="selectFields"></include>
    from message
    where id in(
    	select max(id) from message
    	where status!=2 and from_id=1' and to_id =#{userId} and conversation_id =#{topic}
    ) 
</select>


<select id="selectNoticeCount" resultType="int">
	select count(id)
    from message
    where status!=2
    and from_id =1
    and to_id = #{userId}
    and conversation_id = #{topic}
</select>

<select id="selectNoticeUnreadCount" resultType="int">
	select count(id)
    from message
    where status=0<!--è¡¨ç¤ºæœªè¯»-->
    and from_id =1
    and to_id = #{userId}
    <if test="topic!=null">
    	and conversation_id=#{topic}
    </if>
</select>
```

service

```java
//MessageService
```





### 6.1 ElasticSearch

### 6.4 spring bootæ•´åˆElasticSearch

### 6.6 å¼€å‘ç¤¾åŒºæœç´¢åŠŸèƒ½

### 7.1 SpringSecurity

### 7.3 æƒé™æ§åˆ¶

