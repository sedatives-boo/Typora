###  Spring

åœ¨æµ‹è¯•ç±»ä¸­æµ‹è¯•IoCå®¹å™¨çš„å­˜åœ¨

- æ·»åŠ æ³¨è§£`@ContextConfiguration(classes = CommunityApplication.class)`
- å®ç°æ¥å£ `ApplicationContextAware`
- é‡å†™æ–¹æ³•`public void setApplicationContext(ApplicationContext applicationContext)`

```java
@SpringBootTest
@ContextConfiguration(classes = CommunityApplication.class)//åœ¨æµ‹è¯•ç±»ä¸­åŠ ä¸Šæ­¤æ³¨è§£å°±èƒ½å°†é…ç½®ç±»ï¼ˆï¼‰å¼•ç”¨åœ¨æœ¬ç±»ä¸­
class CommunityApplicationTests implements ApplicationContextAware {

	private ApplicationContext applicationContext;
	@Override
	public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
		this.applicationContext = applicationContext;
	}
	@Test
	public void testApplicationContext(){
		System.out.println(applicationContext);
        //org.springframework.web.context.support.GenericWebApplicationContext@598bd2ba, started on Thu Jun 02 19:55:32 CST 2022
		//è¯æ˜å®¹å™¨æ˜¯å­˜åœ¨çš„
	}
}
```

`@Primary`  æ³¨è§£åœ¨beanä¸Šè¡¨ç¤ºä¼˜å…ˆè¢«Iocå®ä¾‹åŒ–
`@PostConstruct` æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºåœ¨æ„é€ å™¨è¿è¡Œä¹‹åæ‰§è¡Œ
`@PreDestory` æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºåœ¨é”€æ¯æ–¹æ³•å‰æ‰§è¡Œ

**æƒ³å®ä¾‹åŒ–ä¸€ä¸ªç¬¬ä¸‰æ–¹jaråŒ…çš„bean**ï¼šè‡ªå·±å†™ä¸ªé…ç½®ç±»ï¼Œé€šè¿‡beanæ³¨è§£å®ç°

`@SpringbootApplication` ä¸€èˆ¬ç”¨äº**ç¨‹åºå…¥å£**çš„é…ç½®ç±»
`@Configuration` è¡¨ç¤ºä¸º**ä¸€èˆ¬**é…ç½®ç±»

```java
@Configuration
public class AlphaConfig {
    @Bean
    public SimpleDateFormat simpleDateFormat(){
        return new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    }
}
```

```java
@Test
	public void testBeanConfiguration(){
		SimpleDateFormat simpleDateFormat = applicationContext.getBean(SimpleDateFormat.class);
		System.out.println(simpleDateFormat.format(new Date()));
        //2022-06-02 20:13:55
	}
```



### MVC

##### ä¼ é€’å‚æ•°æ–¹å¼

ç¬¬ä¸€ç§:

```java
@RequestMapping(path = "/student",method = RequestMethod.GET)
@ResponseBody
public String getStudent(@RequestParam(name="current",required=false,defalutValue="1") int current,
                        @RequestParam(name="limit",required=false,defalutValue="10") int limit){}
```

RestFul

```java
@RequestMapping(path = "/student/{id}",method = RequestMethod.GET)
@ResponseBody
public String getStudent(@PathVariable("id") int id){
        System.out.println(id);
        return "a student";
    }
```

### é‚®ä»¶åŠŸèƒ½

1. åœ¨sinaå¼€å¯æˆæƒç çŠ¶æ€ï¼Œå’ŒPOP3,SMTPæœåŠ¡

2. æ–°å»ºå·¥å…·ç±»MailClient

   ```java
   /*	1.å°†å…¶æ·»åŠ åˆ°springIoCç®¡ç†
   *	2.å®šä¹‰ä¸€ä¸ªLoggerï¼Œç”¨äºè®°å½•é”™è¯¯ä¿¡æ¯
   *	3.å°†é…ç½®æ–‡ä»¶ä¸­çš„usernameæ³¨å…¥ï¼Œè¿™æ˜¯ï¼ˆä»£è¡¨äº†ç½‘ç«™ï¼‰å‘é€æ–¹
   *	4.å®šä¹‰sendMailæ–¹æ³•ï¼Œéœ€è¦ å‘é‚®ä»¶çš„æ ‡é¢˜ ï¼Œå†…å®¹ ï¼Œæˆ‘çš„é‚®ç®± ï¼Œä»–äººçš„é‚®ç®± å››ä¸ªå‚æ•°
   		éœ€è¦springä¸­çš„MimeMessageHelper å¸®åŠ©æ„å»ºé‚®ä»¶
   */
   @Component
   public class MailClient {
       private static final Logger logger = LoggerFactory.getLogger(MailClient.class);
   
       @Autowired
       private JavaMailSender mailSender;
       //éœ€è¦å‘é‚®ä»¶çš„æ ‡é¢˜ï¼Œå†…å®¹ï¼Œæˆ‘çš„é‚®ç®±ï¼Œä»–äººçš„é‚®ç®±
       //å°†usernameæ³¨å…¥ï¼Œå› ä¸ºæœåŠ¡å™¨å‘é‚®ä»¶éƒ½æ˜¯ç”¨ç›´æ¥çš„è´¦å·ï¼ˆé…ç½®ä¸­çš„sinaï¼‰
       @Value("${spring.mail.username}")
       private String from;
   
       //å°è£…å…¬æœ‰æ–¹æ³•
       public void sendMail(String to, String subject, String content) {
           try {
               MimeMessage message = mailSender.createMimeMessage();
               MimeMessageHelper helper = new MimeMessageHelper(message);
               helper.setFrom(from);
               helper.setTo(to);
               helper.setSubject(subject);
               helper.setText(content, true);
               mailSender.send(helper.getMimeMessage());
           } catch (MessagingException e) {
               logger.error("å‘é€é‚®ä»¶å¤±è´¥" + e.getMessage());
           }
       }
   }
   ```

   æµ‹è¯•ï¼š

```java
@Autowired
private MailClient mailClient;//æ³¨å…¥å·¥å…·ç±»

@Test
public void testMail(){
    mailClient.sendMail("574524709@qq.com","test","test mail");
}
```

éœ€è¦å‘htmlå½¢å¼é‚®ç®±ï¼šé‡‡ç”¨thymeleafæ„å»ºæ¨¡æ¿ï¼š

```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>é‚®ä»¶ç¤ºä¾‹</title>
</head>
<body>
    <p>æ¬¢è¿æ‚¨ï¼Œ<span style="color: darkorchid;" th:text="${username}"></span>!</p>
</body>
</html>
```

æµ‹è¯•ï¼š

```java
@Autowired
private TemplateEngine templateEngine;//springbootä¸­å·²ç®¡ç†äº†æ¨¡æ¿å¼•æ“ï¼Œåªéœ€æ³¨å…¥
@Test
    public void testHtmlMail(){
        Context context = new Context();//æ³¨æ„æ˜¯thymeleafçš„ç±»
        context.setVariable("username","sunday");//è¿™æ˜¯å…¶ä¸­çš„ä¸€ä¸ªå˜é‡
        String content = templateEngine.process("/mail/demo", context);//æŠŠæ¨¡æ¿åœ°å€ï¼Œæ•°æ®ä¼ å…¥å¦‚
        System.out.println(content);
        mailClient.sendMail("574524709@qq.com","HTML",content);
}
```

### 6.5

å¯åŠ¨å‡ºç°é—®é¢˜

```
java.sql.SQLNonTransientConnectionException: Public Key Retrieval is not allowed
```

åœ¨é…ç½®ä¸­æ•°æ®åº“è¿æ¥ååŠ ä¸Š

```
allowPublicKeyRetrieval=true
```

åœ¨é¦–é¡µç‚¹å‡»ï¼ˆé¦–é¡µï¼‰ï¼Œï¼ˆæ³¨å†Œï¼‰éƒ½æ— é¡µé¢

```html
<!--æ³¨æ„thymeleafçš„è¿™ä¸ªå†™æ³•æ˜¯é”™çš„-->
<a class="nav-link" th:href="@{site/index.html}">é¦–é¡µ</a>
<!--é‡‡ç”¨è¿™æ ·-->
<a class="nav-link" th:href="@{index}">é¦–é¡µ</a>
```

### Cookie

```java
 //Cookieç¤ºä¾‹
    @RequestMapping(path = "/cookie/set",method = RequestMethod.GET)
    @ResponseBody
    public String setCookie(HttpServletResponse response){
        Cookie cookie = new Cookie("code1", CommunityUtil.generateUUID());
        //è®¾ç½®èŒƒå›´ï¼Œæœ‰äº›è·¯å¾„ä¸‹æœ‰æ•ˆçš„
        cookie.setPath("/community/alpha");
        //ç”Ÿå­˜æ—¶é—´ï¼ˆé»˜è®¤æ˜¯å…³é—­æµè§ˆå™¨å¤±æ•ˆï¼‰
        cookie.setMaxAge(600);//ç§’
        //å‘é€
        response.addCookie(cookie);
        return "set cookie";
    }

    @RequestMapping(path = "/cookie/get",method = RequestMethod.GET)
    @ResponseBody
    public String getCookie(@CookieValue("code1") String code1){//åŸæœ¬åœ¨requestä¸­å–å¾—ï¼Œä½†å¯ä»¥ç”¨æ³¨è§£å–å¾—å¹¶èµ‹ç»™å€¼
        System.out.println();
        return "get cookie";
    }
```

### session

ä¼˜ç‚¹ï¼šå­˜åœ¨æœåŠ¡å™¨æ›´å®‰å…¨

ç¼ºç‚¹ï¼šæœåŠ¡å™¨å‹åŠ›

```java
 //Sessionæ˜¯javaSEçš„è§„èŒƒï¼Œä¸æ˜¯httpçš„
    @RequestMapping(path = "/session/set",method = RequestMethod.GET)
    @ResponseBody
    public String setSession(HttpSession session){//ä¸cookieä¸åŒï¼ŒspringMVCä¼šè‡ªåŠ¨åˆ›å»ºSession,åªéœ€è¦å£°æ˜ï¼Œå°±èƒ½æ³¨å…¥è¿›æ¥
        session.setAttribute("id",1);
        session.setAttribute("name","test");
        return "session test";
    }

    @RequestMapping(path = "/session/get",method = RequestMethod.GET)
    @ResponseBody
    public String getSession(HttpSession session){
        System.out.println(session.getAttribute("id"));
        System.out.println(session.getAttribute("name"));
        return "get session test";
    }
```

<font color=red>åˆ†å¸ƒå¼éƒ¨ç½²</font>ï¼šnginxå®ç°è´Ÿè½½å‡è¡¡

- ç²˜æ€§sessionï¼šåŒä¸€ipçš„è¯·æ±‚å‡åˆ†é…åˆ°æŒ‡å®šä¸€å°æœåŠ¡å™¨ä¸Š
- åŒæ­¥sessionï¼šæœåŠ¡å™¨å°†sessionåŒæ­¥ç»™æ‰€æœ‰æœåŠ¡å™¨
- å…±äº«sessionï¼šæœ‰ä¸€å°å•ç‹¬çš„æœåŠ¡å™¨ç”¨äºå¤„ç†sessionï¼Œå…¶ä»–æœåŠ¡å™¨ä¸è¯¥æœåŠ¡å™¨
- ä¸»æµï¼šä¸ä½¿ç”¨sessionï¼Œè€Œæ˜¯ç”¨cookieï¼Œéƒ¨åˆ†ä¸é€‚åˆå­˜cookieçš„å­˜æ•°æ®åº“é‡Œï¼Œæ•°æ®åº“é›†ç¾¤å¤‡ä»½
- æ›´å¥½çš„åšæ³•ï¼šä¸å­˜åœ¨å…³ç³»å‹æ•°æ®åº“ï¼ˆç¡¬ç›˜ï¼‰ä¸­ï¼Œè€Œæ˜¯NOSQLä¸­

### ç”ŸæˆéªŒè¯ç 

Kaptchaï¼š

- å¯¼å…¥jaråŒ…
- ç¼–å†™kaptchaé…ç½®ç±»
- ç”Ÿæˆéšæœºå­—ç¬¦ï¼Œå›¾ç‰‡

### ç™»å…¥å’Œé€€å‡º

ç™»å½•è¯·æ±‚ï¼š

- ç‚¹å‡»ä¸Šæ–¹çš„â€œç™»å…¥â€ï¼Œèƒ½è·³åˆ°ç™»å…¥é¡µé¢
- ç‚¹å‡»â€œç«‹å³ç™»å…¥â€ï¼Œè¿”å›ç»“æœï¼ˆç™»å…¥å‡­è¯ï¼Œcookieï¼‰å‘ç»™å®¢æˆ·ç«¯

é€€å‡ºè¯·æ±‚:

- å°†ç™»å…¥å‡­è¯ä¿®æ”¹ä¸ºå¤±æ•ˆçŠ¶æ€
- è·³è½¬è‡³é¦–é¡µ

æ•°æ®åº“ä¸­çš„è¡¨ login_ticketï¼š

| id   | user_id | ticket               | status        | expired  |
| ---- | ------- | -------------------- | ------------- | -------- |
|      |         | éšæœºå­—ç¬¦ä¸²ï¼Œå”¯ä¸€æ ‡è¯† | 0-æœ‰æ•ˆ 1-æ— æ•ˆ | è¿‡æœŸæ—¶é—´ |

1ã€åˆ›å»ºå®ä½“ç±»ï¼Œå°è£…æ•°æ®

```java
//dao

/**
 * åœ¨æœ¬ç±»ä¸­ï¼Œå­¦ä¹ ä½¿ç”¨æ³¨è§£å®ç°sqlï¼Œä¸æ˜¯xml
 *
 */
@Mapper
public interface LoginTicketMapper {

    //ç™»å…¥æˆåŠŸåè¦æ’å…¥å‡­è¯//éœ€è¦å£°æ˜ä¸»é”®è‡ªåŠ¨ç”Ÿæˆï¼Œ@Optionsï¼Œä¸”éœ€è¦å°†ç”Ÿæˆçš„å€¼æ³¨å…¥ç»™å¯¹è±¡ï¼ŒkeyProperty = "id"
    @Insert({
            "insert into login_ticket (user_id,ticket,status,expired) ",//åŠ ä¸ªç©ºæ ¼æ–­å¼€
            "values(#{userId},#{ticket},#{status},#{expired})"
    })
    @Options(useGeneratedKeys = true,keyProperty = "id")
    int insertLoginTicket(LoginTicket loginTicket);

    //æŸ¥è¯¢æ–¹æ³•ï¼šå›´ç»•ticket
    @Select({
            "select id,user_id,ticket,status,expired ",
            "from login_ticket where ticket=#{ticket}"
    })
    LoginTicket selectByTicket(String ticket);

    //ä¿®æ”¹å‡­è¯çŠ¶æ€ï¼šä¸åˆ é™¤
    @Update({
            "update login_ticket set status=#{status} where ticket=#{ticket}"
    })
    int updateStatus(String ticket,int status);
    //å­¦ä¹ ï¼šå‡å¦‚éœ€è¦åŠ¨æ€sqlæ—¶
    /*@Update({
            "<script>",
            "update login_ticket set status=#{status} where ticket=#{ticket} ",
            "<if test=\"ticket!=null\">",
            "and 1 =1",
            "</if>",
            "</script>"
    })*/
}
```

```java
//UserService


//å®ç°ç™»å…¥åŠŸèƒ½ï¼šæˆåŠŸã€å¤±è´¥ï¼ˆå¤šç§æƒ…å†µï¼‰
    public Map<String ,Object> login(String username,String password,int expiredSeconds){
        Map<String ,Object> map = new HashMap<>();
        //ç©ºå€¼åˆ¤æ–­
        if(StringUtils.isBlank(username)){
            map.put("usernameMsg","è´¦å·ä¸èƒ½ä¸ºç©ºï¼");
            return map;
        }
        if(StringUtils.isBlank(password)){
            map.put("passwordMsg","å¯†ç ä¸èƒ½ä¸ºç©ºï¼");
            return map;
        }
        //éªŒè¯åˆæ³•æ€§
        User user = userMapper.selectByName(username);
        if(user==null){
            map.put("usernameMsg","è´¦å·ä¸å­˜åœ¨ï¼");
            return map;
        }
        //æ²¡æ¿€æ´»çš„è´¦å·ä¸èƒ½ç™»å…¥
        if(user.getStatus()==0){
            map.put("usernameMsg","è´¦å·æœªæ¿€æ´»ï¼");
            return map;
        }
        //å¯†ç 
        password = CommunityUtil.md5(password+ user.getSalt());
        if(user.getPassword().equals(password)){
            map.put("passwordMsg","å¯†ç ä¸æ­£ç¡®ï¼");
            return map;
        }
        //ç™»å…¥æˆåŠŸï¼Œç”Ÿæˆç™»å…¥å‡­è¯
        LoginTicket loginTicket = new LoginTicket();
        loginTicket.setUserId(user.getId());
        loginTicket.setTicket(CommunityUtil.generateUUID());
        loginTicket.setStatus(0);//æœ‰æ•ˆçŠ¶æ€
        loginTicket.setExpired(new Date(System.currentTimeMillis()+expiredSeconds*1000));
        loginTicketMapper.insertLoginTicket(loginTicket);
        //è¿™ä¸ªLoginTicketè¡¨å°±ç›¸å½“ä¸sessionäº†ï¼Œä¸‹æ¬¡ç”¨æˆ·è¯·æ±‚å¸¦ä¸Šticketï¼ŒæœåŠ¡å™¨æŸ¥è¯¢çŠ¶æ€å’Œæ—¶é—´çœ‹æ˜¯å¦æœ‰æ•ˆ
        map.put("ticket",loginTicket.getTicket());
        return map;
    }
```

```java
//LoginController

@RequestMapping(path = "/login",method = RequestMethod.POST)
    public String login(String username,String password ,String code,boolean rememberme,//è¿™ä¸ªremembermeæ˜¯å‹¾é€‰è®°ä½æˆ‘
                        Model model,HttpSession session,HttpServletResponse response){//modelç”¨äºèŒƒå›´å“åº”æ•°æ®ï¼›getKaptchaå­˜çš„éªŒè¯ç éœ€è¦sessionè·å–ï¼›ç™»å…¥æˆåŠŸäº†ï¼Œéœ€è¦å°†ticketå‘ç»™å®¢æˆ·ç«¯ç”¨cookieä¿å­˜
        String kaptcha = (String) session.getAttribute("kaptcha");
        if(StringUtils.isBlank(kaptcha)||StringUtils.isBlank(code)||!kaptcha.equalsIgnoreCase(code)){
            model.addAttribute("codeMsg","éªŒè¯ç ä¸æ­£ç¡®");
            return "/site/login";
        }
        //æ£€æŸ¥è´¦å·å¯†ç 
        //å¦‚æœå‹¾é€‰äº†â€œè®°ä½æˆ‘â€ï¼Œåˆ™å­˜çš„æ—¶é—´é•¿ä¸€ç‚¹
        //è¿™é‡Œå†æ¬¡åœ¨CommunityConstantç±»æ·»åŠ å¸¸é‡
        int expiredSecond = rememberme?REMEMBER_EXPIRED_SECONDS:DEFAULT_EXPIRED_SECONDS;
        Map<String, Object> map = userService.login(username, password, expiredSecond);
        //å¦‚æœmapæ€»åŒ…å«ticketï¼Œå°±æ˜¯æˆåŠŸäº†
        if(map.containsKey("ticket")){
            Cookie cookie = new Cookie("ticket",map.get("ticket").toString());
            cookie.setPath(contextPath);//è¡¨ç¤ºæ•´ä¸ªé¡¹ç›®ä¸‹cookieéƒ½æ˜¯æœ‰æ•ˆçš„:æ³¨å…¥propertiesä¸­çš„å€¼
            cookie.setMaxAge(expiredSecond);
            response.addCookie(cookie);//å°†cookieå‘ç»™ç”¨æˆ·
            return "redirect:/index";
        }else {
            model.addAttribute("usernameMsg",map.get("usernameMsg"));
            model.addAttribute("passwordMsg",map.get("passwordMsg"));
            return "/site/login";
        }
    }
```

### æ˜¾ç¤ºç™»å…¥ä¿¡æ¯

æ ¹æ®ç™»å…¥ä¸å¦ï¼Œè°ƒæ•´å¤´éƒ¨ä¿¡æ¯ï¼Œç”±äºåœ¨æ•´ä¸ªç½‘ç«™éƒ½æœ‰ï¼šè®¾å®šæ‹¦æˆªå™¨

1ã€å®šä¹‰æ‹¦æˆªå™¨

```java
@Controller
public class AlphaInterceptor implements HandlerInterceptor {
    private static final Logger logger = LoggerFactory.getLogger(AlphaInterceptor.class);

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        logger.debug("preHandleè°ƒç”¨äº†:"+handler.toString());
        return true;
    }

    //åœ¨Controllerä¹‹åè¿è¡Œï¼Œæ¨¡æ¿å¼•æ“ä¹‹å‰æ‰§è¡Œ
    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        logger.debug("postHandleè°ƒç”¨äº†:"+handler.toString());
    }

    //åœ¨æ¨¡æ¿å¼•æ“TemplateEngineä¹‹åæ‰§è¡Œ
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        logger.debug("afterCompletionè°ƒç”¨äº†:"+handler.toString());
    }
    //å†™å®Œä¹‹ååœ¨configå»ºç«‹é…ç½®ç±»
}
```

2ã€é…ç½®æ‹¦æˆªå™¨ï¼ŒæŒ‡å®šã€æ’é™¤è·¯å¾„

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {


    @Autowired
    private AlphaInterceptor alphaInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(alphaInterceptor).
                excludePathPatterns("/**/*.css","/**/*.js","/**/*.png","/**/*.jpg","/**/*.jpeg")  //ä¸æ‹¦æˆªé™æ€èµ„æº
                .addPathPatterns("/register","/login"); //æ˜ç¡®è¦æ‹¦æˆªçš„è·¯å¾„ï¼šæ³¨å†Œå’Œç™»å…¥
    }
}
```

æ‹¦æˆªå™¨åœ¨æœ¬èŠ‚çš„å®ç°ï¼š

-  åœ¨è¯·æ±‚å¼€å§‹æ—¶æŸ¥è¯¢ç™»å…¥ç”¨æˆ·
- åœ¨æœ¬æ¬¡è¯·æ±‚ä¸­æŒæœ‰çš„ç”¨æˆ·æ•°æ®
- åœ¨æ¨¡æ¿è§†å›¾ä¸Šæ˜¾ç¤ºç”¨æˆ·æ•°æ®
- åœ¨ç»“æŸè¯·æ±‚æ—¶æ¸…ç†ç”¨æˆ·æ•°æ®

### è´¦å·è®¾ç½®

ä¸Šä¼ å¤´åƒå’Œä¿®æ”¹å¯†ç 

ä¸Šä¼ æ–‡ä»¶ï¼š

- è¯·æ±‚ï¼špost
- è¡¨å•ï¼šenctype="multipart/form-data"
- SpringMVC ï¼šé€šè¿‡MultipartFileå¤„ç†ä¸Šä¼ æ–‡ä»¶

æ­¥éª¤ï¼š

1. è®¿é—®é¡µé¢
2. ä¸Šä¼ å¤´åƒ
3. è·å–å¤´åƒï¼šåœ¨å…¶ä»–é¡µé¢éƒ½è¦è·å–

## 6.14

### æ³¨å†ŒåŠŸèƒ½

1.Controllerå±‚

```java
//LoginController
@RequestMapping(path = "/register",method = RequestMethod.GET)
    public String getRegisterPage(){
        return "/site/register";
    }
```

2.ä¿®æ”¹registeré¡µé¢

3.å¼•å…¥CommonsLangåŒ…ï¼Œç”¨äºå¸¸ç”¨å­—ç¬¦ä¸²æ£€æµ‹

4.å†™å·¥å…·ç±»ï¼ˆç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼ŒåŠ å¯†ç­‰ï¼‰ï¼Œç”±äºä¸éœ€è¦äº¤ç»™å®¹å™¨æ‰˜ç®¡ï¼Œå› æ­¤å†™æˆé™æ€æ–¹æ³•

```java
//ä½¿ç”¨ è‡ªå¸¦çš„UUIDåŒ…ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
public static String generateUUID(){
        return UUID.randomUUID().toString().replaceAll("-","");//ä¸æƒ³è¦æœ‰æ¨ªçº¿
    }
//åŠ å¯†å¯†ç :ä½¿ç”¨Spring è‡ªå¸¦çš„å·¥å…·ç±» DigestUtils.md5DigestAsHex()
public static String md5(String key){
        if(StringUtils.isBlank(key)){//å…ˆç®€å•åˆ¤æ–­ä¸‹ä¸ä¸ºç©ºï¼Œé‡‡ç”¨äº†commons langåŒ…
            return null;
        }else {
            return DigestUtils.md5DigestAsHex(key.getBytes(StandardCharsets.UTF_8));//è¿™æ˜¯springè‡ªå¸¦çš„åŠ å¯†æ–¹æ³•
        }
    }
```

5.å¼€å‘æ³¨å†Œä¸šåŠ¡

```java
//UserService
//æ³¨å…¥é‚®ä»¶å®¢æˆ·ç«¯ï¼Œæ¨¡æ¿å¼•æ“
//æ³¨å…¥é¡¹ç›®åï¼Œé¡¹ç›®è·¯å¾„
	@Autowired
    private MailClient mailClient;
    @Autowired
    private TemplateEngine templateEngine;
    //æ³¨å†Œæ—¶å‘é€æ¿€æ´»ç éœ€è¦å¸¦ä¸ŠåŸŸåå’Œé¡¹ç›®åï¼Œå› æ­¤ä»propertiesä¸­æ³¨å…¥
    @Value("${community.path.domain}")
    private String domain;
    @Value("${server.servlet.context-path}")
    private String contextPath;
    @Autowired
    private LoginTicketMapper loginTicketMapper;
```

6.å¼€å‘ä¸šåŠ¡

> - è¿”å›ç»“æœï¼šé”™è¯¯ä¿¡æ¯ï¼ˆæ³¨å†ŒæˆåŠŸã€è´¦å·å·²å­˜åœ¨ç­‰ï¼‰---> Map
>
>   1. ç©ºå€¼åˆ¤æ–­ï¼šè´¦å·ï¼Œå¯†ç ï¼Œé‚®ç®±
>
>   2. éªŒè¯ï¼šï¼ˆè´¦å·å·²å­˜åœ¨ã€é‚®ç®±å·²å­˜åœ¨ï¼‰â€”â€”> userMapper.selectByName
>
>   3. æ³¨å†Œç”¨æˆ·ï¼šæŠŠç”¨æˆ·æ’å…¥åº“ä¸­
>
>      1. user.setSalt
>
>      2. user.setPassword() å°†salt+åŸå¯†ç å¹¶åŠ å¯†è¦†ç›–åŸå¯†ç 
>
>      3. user.setType/setStatus/setActivationCode/setHeader
>
>      4. éšæœºå¤´åƒè®¾ç½®
>
>         ```java
>         user.setHeaderUrl(String.format("http:\\image.nowcoder.com/head/%dt.png",new Random().nextInt(1000)));
>         ```
>
>      5. ç»™ç”¨æˆ·å‘æ¿€æ´»é‚®ä»¶
>
>
> ```java
> Context context = new Context();//Thymeleafè‡ªå¸¦å¯¹è±¡ï¼šæ¨¡æ¿ç”Ÿæˆhtmlæ ¼å¼é‚®ä»¶
> context.setVariable("email",user.getEmail()); 
> //åŠ¨æ€æ‹¼æ¥ç”¨æˆ·èƒ½ç‚¹çš„è·¯å¾„ï¼ˆæ¯ä¸ªç”¨æˆ·çš„æ¿€æ´»é¡µé¢æ˜¯ä¸åŒçš„ï¼‰ :101 æ˜¯ç”¨æˆ·idï¼Œcodeæ˜¯æ¿€æ´»ç 
> //http://localhost:8080/community/activation/101/code
> String url = domain+contextPath+"/activation/"+user.getId()+"/"+user.getActivationCode();
> context.setVariable("url",url);
> //ç”Ÿæˆæ¨¡æ¿å¼•æ“
> String content = templateEngine.process("/mail/activation",context);
> mailClient.sendMail(user.getEmail(), "è´¦å·æ¿€æ´»",content);
> ```
>
> 

```java
//userService
    public Map<String,Object> register(User user){
        Map<String ,Object> map = new HashMap<>();
        //å…ˆå¯¹ç©ºå€¼åšåˆ¤æ–­
        if(user==null){
            throw new IllegalArgumentException("å‚æ•°ä¸ä¸ºç©º");
        }
        if(StringUtils.isBlank(user.getUserName())){
            map.put("usernameMsg","è´¦å·ä¸èƒ½ä¸ºç©º!");
            return map;
        }
        if(StringUtils.isBlank(user.getPassword())){
            map.put("passwordMsg","å¯†ç ä¸èƒ½ä¸ºç©º!");
            return map;
        }
        if(StringUtils.isBlank(user.getEmail())){
            map.put("emailMsg","é‚®ç®±ä¸èƒ½ä¸ºç©º!");
            return map;
        }
        //è´¦å·æ˜¯å¦å­˜åœ¨
        User u = userMapper.selectByName(user.getUserName());
        if(u!=null){
            map.put("usernameMsg","è´¦å·å·²å­˜åœ¨!");
            return map;
        }
        //é‚®ç®±éªŒè¯
        u = userMapper.selectByEmail(user.getEmail());
        if(u!=null){
            map.put("emailMsg","è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ!");
            return map;
        }
        //å¯ä»¥æ³¨å†Œäº†
        user.setSalt(CommunityUtil.generateUUID().substring(0,5));
        user.setPassword(CommunityUtil.md5(user.getPassword()+user.getSalt()));
        user.setType(0);//æ™®é€šç”¨æˆ·
        user.setStatus(0);//æœªæ¿€æ´»
        user.setActivationCode(CommunityUtil.generateUUID());//ç”Ÿæˆä¸€ä¸ªæ¿€æ´»ç 
        //ä¸ºç”¨æˆ·è®¾ç½®éšæœºå¤´åƒï¼Œç‰›å®¢ç½‘çš„å¤´åƒåº“æœ‰0-1000 å·å¤´åƒ
        user.setHeaderUrl(String.format("http://images.nowcoder.com/head/%dt.png",new Random().nextInt(1000)));
        user.setCreateTime(new Date());
        userMapper.insertUser(user);
        //ç»™ç”¨æˆ·å‘é‚®ä»¶ï¼Œç”¨äºæ¿€æ´» æ¨¡æ¿ activation.html
        Context context = new Context();
        context.setVariable("email",user.getEmail());
        //åŠ¨æ€æ‹¼æ¥ç”¨æˆ·èƒ½ç‚¹çš„è·¯å¾„ï¼ˆæ¯ä¸ªç”¨æˆ·çš„æ¿€æ´»é¡µé¢æ˜¯ä¸åŒçš„ï¼‰ :101 æ˜¯ç”¨æˆ·idï¼Œcodeæ˜¯æ¿€æ´»ç 
        //http://localhost:8080/community/activation/101/code
        String url = domain+contextPath+"/activation/"+user.getId()+"/"+user.getActivationCode();
        context.setVariable("url",url);
        //ç”Ÿæˆæ¨¡æ¿å¼•æ“
        String content = templateEngine.process("/mail/activation",context);
        mailClient.sendMail(user.getEmail(), "è´¦å·æ¿€æ´»",content);
        return map;
    }
```

7.æ§åˆ¶å™¨

> 1. å°†userServiceæ³¨å…¥
>
> 2. å®šä¹‰æ–¹æ³•å¤„ç†ç”¨æˆ·çš„æ³¨å†Œè¯·æ±‚ï¼šregisteré¡µé¢  post
>
>    ```java
>    @RequestMapping(path = "/register",method = RequestMethod.POST)
>        public String register(Model model, User user)
>    ```
>
>    
>
>    ```java
>    		Map<String,Object> map = userService.register(user);
>            if(map==null||map.isEmpty()){
>                model.addAttribute("msg","æ³¨å†ŒæˆåŠŸï¼Œæˆ‘ä»¬å·²å‘ä½ çš„é‚®ç®±å‘é€äº†æ¿€æ´»é‚®ä»¶ï¼Œè¯·å°½å¿«æ¿€æ´»ï¼");
>                model.addAttribute("target","/index");
>                return "/site/operate-result";//è·³è½¬åˆ°è·³è½¬é¡µé¢
>            }else{//æºå¸¦ä¿¡æ¯ï¼Œé‡æ–°å›åˆ°æ³¨å†Œé¡µé¢ï¼ŒæŠŠserviceå±‚çš„ä¸‰ä¸ªä¿¡æ¯éƒ½å‘å›ï¼Œå¦‚æœæ˜¯ç©ºçš„å°±ä¸æ˜¾ç¤º
>                model.addAttribute("usernameMsg",map.get("usernameMag"));
>                model.addAttribute("passwordMsg",map.get("passwordMag"));
>                model.addAttribute("emailMsg",map.get("emailMag"));
>                model.addAttribute("user",user);//æµ‹è¯•
>                return "/site/register";
>    ```

8.æ¿€æ´»è´¦å·

> åœ¨serviceå±‚æ·»åŠ ä¸šåŠ¡
>
> ```java
> 	public int activation(int userId,String code){//ä¼ å…¥ç”¨æˆ·idï¼Œå’Œæ¿€æ´»ç codeï¼ŒæŸ¥è¯¢æ¿€æ´»ç 
>         User user = userMapper.selectById(userId);
>         if(user.getStatus()==1){//å·²ç»æ¿€æ´»äº†
>             return ACTIVATION_REPEAT;
>         }else if(user.getActivationCode().equals(code)){
>             userMapper.updateStatus(userId,1);//ä¿®æ”¹æ¿€æ´»çŠ¶æ€
>             return ACTIVATION_SUCCESS;
>         }else {
>             return ACTIVATION_FAILURE;
>         }
>     }
> ```
>
> Controller
>
> ```java
> @RequestMapping(path = "/activation/{userId}/{code}",method = RequestMethod.GET)
>     public String activation(Model model, @PathVariable("userId") int userId,@PathVariable("code") String code){
>         int result = userService.activation(userId,code);
>         if(result==ACTIVATION_SUCCESS){
>             model.addAttribute("msg","æ¿€æ´»æˆåŠŸï¼");
>             model.addAttribute("target","/login");
>         }else if(result==ACTIVATION_REPEAT){
>             model.addAttribute("msg","è¯¥è´¦å·å·²ç»æ¿€æ´»è¿‡ï¼");
>             model.addAttribute("target","/index");
>         }else{
>             model.addAttribute("msg","æ¿€æ´»å¤±è´¥ï¼");
>             model.addAttribute("target","/index");
>         }
>         return "/site/operate-result";
>     }
> ```
>
> 

## 8.14

### è´¦å·è®¾ç½®ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰

è¯·æ±‚:å¿…é¡»æ˜¯POSTè¯·æ±‚ï¼Œ
è¡¨å•: enctype= "multipart/form-data
Spring MVC:é€šè¿‡MultipartFileå¤„ç†.ä¸Šä¼ æ–‡ä»¶

## 8.15

### æ£€æŸ¥ç™»å…¥çŠ¶æ€

å¦‚æœæœ‰äººçŸ¥é“ä¸€äº›è·¯å¾„ï¼Œå°±å¯ä»¥åœ¨æ²¡ç™»å…¥æ—¶è¿›å…¥æŸäº›é¡µé¢ï¼Œåº”è¯¥é…ç½®æ‹¦æˆªå™¨é˜»æ­¢éæ³•è®¿é—®ã€‚

```
â—ä½¿ç”¨æ‹¦æˆªå™¨
-åœ¨æ–¹æ³•å‰æ ‡æ³¨è‡ªå®šä¹‰æ³¨è§£
æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œåªå¤„ç†å¸¦æœ‰è¯¥æ³¨è§£çš„æ–¹æ³•
â—è‡ªå®šä¹‰æ³¨è§£
å¸¸ç”¨çš„å…ƒæ³¨è§£:
@Targetã€@Retentionã€@Documentã€ @Inherited
å¦‚ä½•è¯»å–æ³¨è§£:
Method . getDeclaredAnnotations ()
Method . getAnnotation (Class<T> annotationClass)
```

1.å…ˆå®šä¹‰æ³¨è§£

```java
@Target(ElementType.METHOD)
@Retention(RetentionPoliy.RUNTIME)
public @interface LOginRequired{
    //ä¸ç”¨å†™ä¸œè¥¿ï¼Œåªæ˜¯æ ‡è®°çš„ä½œç”¨
}
```

2.åœ¨éœ€è¦çš„æ–¹æ³•å‰åŠ ä¸Šè¯¥æ³¨è§£

3.å®šä¹‰æ‹¦æˆªå™¨

```java
@Autowired
public HostHolder hostHolder;//å°è¯•è·å–å½“å‰çš„ç”¨æˆ·æ¥åˆ¤æ–­ç™»å…¥

@Component
public Class LoginRequiredIntercepter implements HandlerInceptor{
    @override
    public boolean prehander(HttpServletRequest request,HttpServlet response, Object handler) throws Exception{
        //å‚æ•°çš„ Object handleræ˜¯æ‹¦æˆªçš„ç›®æ ‡ï¼Œç›®æ ‡æ˜¯æ–¹æ³•æ‰èƒ½æ‰§è¡Œ
        if(handler instanceof HandlerMethod){
            HandlerMethod handlerMethod = (HandlerMethod) handler;
            //é€šè¿‡å®ƒçš„æ–¹æ³•æ¥ç›´æ¥è·å–æ‹¦æˆªåˆ°çš„æ–¹æ³•
            sMethod method = handlerMethod.getMethod();
            //æœ‰äº†æ–¹æ³•å¯¹è±¡ï¼Œå°è¯•ä»æ–¹æ³•å¯¹è±¡ä¸­è·å–æ³¨è§£
            LoginRequired loginRequired = method.getAnnotation(LoginRequired.class);
            if(loginRequired != null && hostHolder.getUser()== null){//ä¸”è·å–ä¸åˆ°ç™»å…¥ç”¨æˆ·
                response.sendRedirect(request.getContextPath()+"/login");
                return false;
            }
        }
    }
  
}
```

4.å°†æ‹¦æˆªå™¨æ³¨å…¥WebMvcConfig

```java
//1.å…ˆæ³¨å…¥
@Autowired
private LoginRequiredInterceptor loginRequiredInterceptor;
//2.ç„¶ååœ¨addInterceptoråŠ å…¥
registry.addInterceptor().excludePathPatterns()
```

# 9

### 3.1 è¿‡æ»¤æ•æ„Ÿè¯ğŸ”°ğŸˆµ

â€‹	å‰ç¼€æ ‘ï¼Œå»ºæ ‘ï¼Œåˆå§‹åŒ–postConstructï¼Œå­—ç¬¦åŒ¹é…

<img src="Resources/image-20221107211439831.png" alt="image-20221107211439831" style="zoom:67%;" />

1.åœ¨resource ä¸‹åˆ›å»ºæ–‡ä»¶ï¼Œå†™å…¥æ•æ„Ÿè¯

2.åœ¨utilåŒ…ä¸‹åˆ›å»º  sensitiveFilter

```java
//@component
class sensitiveFilter{
    private class TrieNode{
        //ç»“æŸæ ‡è¯†
       private boolean isEnd = false;
        //å­ç»“ç‚¹
        private Map<Character,TrieNode> subNodes = new HashMap<>();
        
        //getter setteræ–¹æ³•
        //...
      
        //æ·»åŠ å­èŠ‚ç‚¹ 
        public void addSubNode(Character c,TrieNode node){
            subNodes.put(c,node);
        }
        public TrieNode getSubNode(Character c){
            return subNodes.get(c);
        }
    }
    
    //æœ¬ç±»çš„å…¶ä½™å†…å®¹
    //Logger.........
    //æ•æ„Ÿè¯æ‰€æ›¿æ¢çš„å¸¸é‡ ***
    //æ ¹èŠ‚ç‚¹:åªè¦é¦–æ¬¡è®¿é—®æ—¶å°±æœ‰å°±è¡Œäº†
    public TrieNode rootNode = new TrieNode();
    
    //åˆå§‹åŒ–æ–¹æ³•
    @PostConstruct
    public void init(){
        //tryçš„æ‹¬å·é‡Œæ‰§è¡Œä¸‹ä¸¤æ­¥
        //æƒ³è·å–æ•°ï¼ŒæŠŠtxtæ–‡ä»¶çš„è¯»å–å‡ºæ¥ï¼Œæˆ‘ä»¬è·å–ç±»åŠ è½½å™¨ï¼Œä»ç±»è·¯å¾„ä¸‹åŠ è½½èµ„æºï¼ˆideaä¸­é¡¹ç›®çš„targetåŒ…ä¸‹çš„classesåŒ…ï¼‰
        InputStream is = this.getClass().getClassLoader().getResourceAsStream("sensitive-words.txt");//æ³¨æ„åŠ ä¸Štry-catch-finaly
        //è½¬åŒ–æˆç¼“å†²æµæ•ˆç‡é«˜ 
        BufferedReader reader = new BufferedReader(new InputStreamReader(is));
        //tryçš„å†…éƒ¨
        String keyword;
        while((keyword=reader.readLine())!=null){
            //æ·»åŠ åˆ°å‰ç¼€æ ‘ä¸­
            this.addKeyword(keyword);
        }
    }
    
    //addKeyword(String word) æ–¹æ³•
   private void addKeyword(String keyword){
       TrieNode tempNode = rootNode;
       for(int i = 0;i<keyword.length();i++){
           char c = keyword.charAt(i);
         TrieNode subNode = tempNode.getSubNode(c);//æœ‰çš„è¯å°±è·å–ï¼Œæ²¡æœ‰çš„è¯å°±æ–°å»º
           if(subNode==null){
               //åˆå§‹åŒ–å­èŠ‚ç‚¹
               subNode = new TrieNode();
               tempNode.addSubNode(c,subNode);
           }
           //æŒ‡å‘å­èŠ‚ç‚¹ï¼Œè¿›å…¥ä¸‹ä¸€å±‚å¾ªç¯
           tempNode = subNode;
           //æœ€åä¸€ä¸ªå­—ç¬¦
           if(i==keyword.length()-1){
               tempNode.setKeyWordEnd(true);
           }
       }
   } 
    
    //æ£€ç´¢çš„æ–¹æ³• ï¼Œè¿”å›ä¸€ä¸ªå·²ç»æ›¿æ¢è¿‡çš„å­—ç¬¦ä¸²
    public String filter(String text){
        if(StringUtils.isBlank(text)){return null};
        //æ ¹æ®å›¾è§£ï¼Œéœ€è¦ä¸‰ä¸ªæŒ‡é’ˆ
      	TrieNode tempNode = rootNode;
        int begin = 0;
        int position = 0;
        //å­˜ç»“æœ
        StringBuilder sb = new StringBuilder();
        while(position<text.length()){
            char c= text.charAt(position);
            //è·³è¿‡ç¬¦å·é€»è¾‘ï¼šæ¯”å¦‚   â™¥æ€â™¥äººâ™¥   :å°è£…ä¸ªæ–¹æ³•
            if(isSymbol(c)){
                //å¦‚æœå½“å‰æŒ‡é’ˆæŒ‡å‘æ ¹èŠ‚ç‚¹ï¼Œç›´æ¥è¾“å‡º
                if(tempNode==rootNode){
                    sb.append(c);
                    begin++;
                }
                //æ— è®ºç¬¦å·åœ¨å¼€å¤´æˆ–è€…ä¸­é—´ï¼Œpositionéƒ½å‘ä¸‹èµ°ä¸€æ­¥
                position++;
                contiune;
            }
            //æ£€æŸ¥ä¸‹ä¸ªèŠ‚ç‚¹
            tempNode = tempNode.getSubNode(c);
            if(tempNode==null){
                //ä»¥beginå¼€å¤´çš„å­—ç¬¦ä¸²ä¸æ˜¯æ•æ„Ÿè¯ï¼Œåˆ™å°†beginè¿™ä¸ªå­—ç¬¦è®°å½•
                sb.append(text.charAt(begin));
                //è¿›å…¥ä¸‹ä¸€ä½ç½®
                position = ++begin;
                //é‡æ–°æŒ‡å‘æ ¹èŠ‚ç‚¹
                tempNode = rootNode;
            }else if(tempNode.isKeywordEnd){
                //å‘ç°äº†æ•æ„Ÿå­—ï¼Œä»¥beginå¼€å¤´ï¼Œpositionç»“å°¾
                sb.append(REPLACEMENT);
                begin = ++position;
                tempNode = rootNode;
            }else {
                position++;
            }
        }
        //è¡¥å……ï¼Œå¾ªç¯ç»“æŸäº†ï¼Œä½†æ˜¯æœ€åbeginåˆ°posotionçš„å­—ç¬¦è¿˜æ²¡è®°å½•è¿›å»
        sb.append(text.substring(being));
    }
    
    //åˆ¤æ–­æ˜¯å¦ä¸ºç¬¦å·
    private boolean isSymbol(Character c){
        //c<0x2E80||c>0X9FFF æ˜¯ä¸œäºšæ–‡å­—èŒƒå›´
        return !CharUtils.isAsciiAlphanumer(c)&&(c<0x2E80||c>0X9FFF);
    }
    
}
```

#### æ–‡å­—å›ç­”

é€šè¿‡å‰ç¼€æ ‘æ¥å®ç°ï¼Œç”¨åŒæŒ‡é’ˆæŒ‡å‘è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œä¸€ä¸ªä¸€ä¸ªå­—éå†ï¼Œå½“æ£€æŸ¥åˆ°æœ‰æ•æ„Ÿè¯æ—¶å°±æ›¿æ¢ï¼Œåˆ©ç”¨å·¥å…·ç±»æ¥è·³è¿‡ç‰¹æ®Šç¬¦å·

### 3.6 å‘å¸ƒå¸–å­ğŸ”°

ç¤ºä¾‹ï¼šJqueryå‘é€ajaxè¯·æ±‚:

å¼‚æ­¥å¤„ç†AJAXï¼ˆé‡‡ç”¨JSONï¼‰
![image-20220901153603403](Resources/image-20220901153603403.png)

Serviceå±‚--å‘å¸ƒå¸–å­+æ•æ„Ÿè¯è¿‡æ»¤

![image-20220901155938935](Resources/image-20220901155938935.png)

Controllerå±‚

![image-20220901160251008](Resources/image-20220901160251008.png)

### 3.11 å¸–å­è¯¦æƒ…ğŸ”°

ä¼ å…¥å¸–å­id

![image-20220902201311496](Resources/image-20220902201311496.png)

serviceå±‚

![image-20220902203130250](Resources/image-20220902203130250.png)

Controllerå±‚ï¼šä½¿ç”¨åˆ°Rustfulé£æ ¼ï¼Œéœ€è¦å°†discussPostIdä¼ å…¥ï¼Œä½¿ç”¨ `@PathVariable`
		è¿‡ç¨‹ï¼šè°ƒç”¨ä¸šåŠ¡å±‚ï¼Œå°†å¸–å­ä¿¡æ¯æŸ¥è¯¢ï¼Œå°†å¾—åˆ°ç»“æœç»™Model ï¼Œé€šè¿‡`addAttribute` 
					éœ€è¦å°†æŸ¥åˆ°çš„userIdè½¬åŒ–ä¸ºç”¨æˆ·ä¿¡æ¯ï¼Œè°ƒç”¨UserServiceæ¥è·å–
					ï¼ˆä»¥åå¼€å‘ï¼‰å¸–å­çš„å›å¤

![image-20220904135725383](Resources/image-20220904135725383.png)

### 3.13 äº‹åŠ¡ç®¡ç†ğŸ”°

ç¬¬ä¸€ç±»ä¸¢å¤±æ›´æ–°ï¼š

> æŸä¸€ä¸ªäº‹åŠ¡çš„å›æ»šï¼Œå¯¼è‡´å¦ä¸€ä¸ªå·²æäº¤çš„æ•°æ®ä¸¢å¤±äº†ã€‚
>
> 

ç¬¬äºŒç±»ä¸¢å¤±æ›´æ–°ï¼š

> æŸä¸€ä¸ªäº‹åŠ¡æäº¤ï¼Œå¯¼è‡´å¦ä¸€ä¸ªå·²æ›´æ–°çš„æ•°æ®ä¸¢å¤±äº†ã€‚
>
> <img src="Resources/image-20221109160623904.png" alt="image-20221109160623904" style="zoom:67%;" />



ä¸å¯é‡å¤è¯»ï¼šåŒä¸€äº‹åŠ¡ï¼Œä¸¤æ¬¡è¯»å–çš„æ•°æ®ä¸ä¸€è‡´
å¹»è¯»ï¼šåŒä¸€äº‹åŠ¡å†…ï¼ŒåŒä¸€ä¸ªè¡¨ä¸¤æ¬¡æŸ¥è¯¢çš„è¡Œæ•°ä¸ä¸€è‡´

<img src="Resources/image-20221109161040147.png" alt="image-20221109161040147" style="zoom:67%;" />



<img src="Resources/image-20220904185950992.png" alt="image-20220904185950992" style="zoom:67%;" />

<img src="Resources/image-20220904190029553.png" alt="image-20220904190029553" style="zoom:67%;" />

å£°æ˜å¼äº‹åŠ¡ç®¡ç†ï¼š

éœ€è¦åŠ ä¸Šæ³¨è§£è¡¨ç¤ºæ˜¯äº‹åŠ¡

<img src="Resources/image-20220905180332040.png" alt="image-20220905180332040" style="zoom:67%;" />

è¿˜æœ‰ä¸€ä¸ªå‚æ•°æ˜¯äº‹åŠ¡ä¼ æ’­æœºåˆ¶ï¼šè¡¨ç¤ºè°ƒç”¨äº†å¦ä¸€ä¸ªäº‹åŠ¡

<img src="Resources/image-20220905180807004.png" alt="image-20220905180807004" style="zoom:80%;" />

æˆ‘ä»¬æ–°å»ºä¸€ä¸ªæµ‹è¯•ç±»ï¼šï¼ˆå‰é¢å…ˆåŠ ä¸Šæ³¨è§£ï¼‰

<img src="Resources/image-20220905180953135.png" alt="image-20220905180953135" style="zoom:80%;" />

ç¼–ç¨‹å¼äº‹åŠ¡ï¼š

![image-20220905183350572](Resources/image-20220905183350572.png)

### 3.20 æ˜¾ç¤ºè¯„è®ºğŸ”°

<img src="Resources/image-20220905183619146.png" alt="image-20220905183619146" style="zoom:67%;" />

1.é¦–å…ˆå®šä¹‰å®ä½“entityï¼Œä¸æ•°æ®åº“ä¸­å±æ€§å¯¹åº”

<img src="Resources/image-20220905183928359.png" alt="image-20220905183928359"  />

2.æ•°æ®è®¿é—®å±‚ï¼š

![image-20220905184113536](Resources/image-20220905184113536.png)

3.Mapper

![image-20220905184326486](Resources/image-20220905184326486.png)

4.æ–°å¢ä¸šåŠ¡ç»„ä»¶

![image-20220905184743496](Resources/image-20220905184743496.png)

æŸ¥è¯¢å¸–å­çš„ä¸šåŠ¡åœ¨å¸–å­è¯¦æƒ…Discusspostä¸šåŠ¡ä¸Š

### 3.22 æ·»åŠ è¯„è®ºğŸ”°

åœ¨ä¸šåŠ¡å±‚ï¼šæ·»åŠ è¯„è®ºï¼Œå†æ›´æ–°è¯„è®ºæ•°é‡ï¼Œæ˜¯ä¸¤ä¸ªDMLæ“ä½œï¼Œéœ€è¦ä½¿ç”¨åˆ°**äº‹åŠ¡ç®¡ç†**

<img src="Resources/image-20220909144145833.png" alt="image-20220909144145833" style="zoom:67%;" />

mapperï¼š

![image-20220909144457992](Resources/image-20220909144457992.png)

ç”±äºæ–°å¢äº†è¯„è®ºï¼Œåˆ™éœ€è¦å†DiscussPostä¸šåŠ¡ä¸­æ–°å¢ â€œæ›´æ–°è¯„è®ºæ•°é‡â€ï¼Œä½¿å¾—æŸ¥çœ‹å¸–å­å°±èƒ½æŸ¥çœ‹è¯„è®º

![image-20220909144750764](Resources/image-20220909144750764.png)

åœ¨ä¸šåŠ¡å±‚æ·»åŠ ï¼š

![image-20220909144850838](Resources/image-20220909144850838.png)

æœ¬å°èŠ‚é‡ç‚¹ï¼šå¢åŠ è¯„è®ºï¼Œåœ¨serviceå±‚æ–°å¢
ç”±äºè¿™å…¶ä¸­åŒ…å«ä¸¤ä¸ªDMLï¼Œå› æ­¤é‡‡ç”¨äº‹åŠ¡ç®¡ç†

![image-20220909145009155](Resources/image-20220909145009155.png)
åªéœ€è¦å¢åŠ æ³¨è§£ï¼š

![image-20220909145207332](Resources/image-20220909145207332.png)
å¢åŠ è¯„è®ºéœ€è¦å¤„ç†*htmlæ ‡ç­¾è¿‡æ»¤*å’Œ*æ•æ„Ÿè¯è¿‡æ»¤*ï¼š

![image-20220909145330127](Resources/image-20220909145330127.png)
![image-20220909145618492](Resources/image-20220909145618492.png)

Controllerï¼š

![image-20220909151715501](Resources/image-20220909151715501.png)

### 3.24ç§ä¿¡åˆ—è¡¨

### 3.27 å‘é€ç§ä¿¡

### 3.31 ç»Ÿä¸€å¤„ç†å¼‚å¸¸ğŸ”°ğŸ”°

ç”±spring æä¾›çš„æ³¨è§£ï¼š

<img src="Resources/image-20220909152817672.png" alt="image-20220909152817672" style="zoom:80%;" />

å°†é”™è¯¯é¡µé¢æ·»åŠ åˆ°templateç›®å½•ä¸‹ï¼šç”±springBootç»Ÿä¸€å¤„ç†

![image-20220909153120626](Resources/image-20220909153120626.png)

ä¸ºäº†å®Œå–„å¼‚å¸¸å¤„ç†å’Œé€šçŸ¥ï¼šå®Œæˆä»¥ä¸‹é…ç½®

åœ¨Controlleræ–°å»ºåŒ…adviceï¼Œæ–°å»ºç±» ExceptionAdviceï¼Œä½¿ç”¨æ³¨è§£ `@ControllerAdvice`ï¼Œè¿™æ ·ç»„ä»¶ä¼šæ‰«ææ‰€æœ‰çš„beanï¼Œå› æ­¤é™å®šå…¶æ‰«æå¸¦æœ‰Controlleræ³¨è§£çš„bean
![image-20220909154548170](Resources/image-20220909154548170.png)

æ–¹æ³•ï¼š

```java
@ControllerAdvice(annotation = Controller.class)
public class ExceptionAdvice{
   //å…ˆå°†æ—¥å¿—ç»„ä»¶æ³¨å…¥
    private static final Logger logger = LoggerFactory.getLogget(EcxeptionAdvice.class);
    //å¤„ç†å¼‚å¸¸çš„æ–¹æ³•éœ€è¦è¿™ä¸ªæ³¨è§£
    //æ–¹æ³•å¿…é¡»æ˜¯ public void çš„ï¼Œå‚æ•°æ˜¯Exceptionï¼Œå’Œreqï¼Œresp
    @ExceptionHandler(annotation = Controller.class)
  	public void handler(Exception e,HttpServletRequest request,HttpServletResponse response) throws IOException{
        //å°†å¼‚å¸¸è®¡å…¥æ—¥å¿—
        logger.error("æœåŠ¡å™¨å‘ç”Ÿå¼‚å¸¸:"+e.getMessage());
        //æˆ‘ä»¬æƒ³æ›´è¯¦ç»†çš„å¼‚å¸¸ä¿¡æ¯ï¼šæ ˆä¿¡æ¯ï¼šéå†æ ˆ
        //æ ˆä¸­å…ƒç´ æ˜¯ StackTraceElement
        for(StackTraceElement elemnt :e.getStackTrace()){
            logger.error(element.tostring());
        }
        //ç”±äºè¿™é‡Œæ˜¯é‡å®šå‘ 500è¿™ä¸ªé¡µé¢ï¼Œåªé€‚ç”¨äºåŒæ­¥çš„è¯·æ±‚
        //å¦‚æœæ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œéœ€è¦è¿”å›json/XML
        //é€šè¿‡requestæ¥åˆ¤æ–­
       String xRequestedWith =  request.getHeader("x-requested-with");
        if("XMLHttpRequest"==xRequestedWith){//å‘ç°æ˜¯å¼‚æ­¥è¯·æ±‚
            response.setContentType("application/plain;charset=utf-8");
            PrintWriter writer = response.getWriter();//è¿™é‡Œéœ€è¦æŠ›å‡ºå¼‚å¸¸
            writer.write(CommunityUtil.getJSONString(1,"æœåŠ¡å™¨å¼‚å¸¸"));
        }else{//æ˜¯æ™®é€šè¯·æ±‚çš„è¯ï¼Œå°±é‡å®šå‘
            response.sendRedirect(request.getContextPath()+"/error");
        }
    }
}
//ä½¿ç”¨è¯¥æ–¹æ³•çš„å¥½å¤„æ˜¯ï¼Œä¸éœ€è¦åœ¨ä»»ä½•Controllerä¸Šæ”¹åŠ¨å°±èƒ½ç»Ÿä¸€å¤„ç†é—®é¢˜
```

#### æ–‡å­—å›ç­”

<font color ='litered'>é‡‡ç”¨ControllerAdviceæ³¨è§£ï¼Œåˆ›å»ºä¸€ä¸ªå¼‚å¸¸å¤„ç†ç±»ï¼Œå‚æ•°é‡Œåªè¦ç­›é€‰Controllerå±‚çš„ç±»ï¼Œç„¶åå®ç°æ–¹æ³•handlerï¼Œé‡‡ç”¨ExceptionHandleræ³¨è§£ï¼Œæ–¹æ³•å‚æ•°ä¼ é€’å¼‚å¸¸eï¼Œresponseå’Œrequestï¼Œå…·ä½“å¤„ç†æµç¨‹ï¼šä½¿ç”¨æ—¥å¿—ç»„ä»¶å†™å…¥æ—¥å¿—ï¼Œæ‰“å°æ ˆï¼Œé‡å®šå‘`response.sendRedirect`åˆ°500é¡µé¢.</font>



### 3.33 ç»Ÿä¸€è®°å½•æ—¥å¿—ğŸ”°ğŸ”°

ä¼ ç»Ÿæ–¹æ³•ï¼šå°†è®°å½•æ—¥å¿—çš„ç»„ä»¶å°è£…åˆ°æ–¹æ³•é‡Œï¼Œç„¶ååœ¨éœ€è¦çš„åœ°æ–¹è°ƒç”¨

ä½†è¿™ä¸ªæ˜¯ç³»ç»Ÿéœ€æ±‚ï¼Œåœ¨ä¸šåŠ¡æ–¹æ³•é‡Œé¢è€¦åˆçš„è¯å¾ˆä¸å¥½ï¼Œå°†æ¥è¦æ”¹åŠ¨çš„è¯å¾ˆéš¾ã€‚

é‡‡ç”¨AOP

![image-20220910131517908](Resources/image-20220910131517908.png)

<img src="Resources/image-20220910131853845.png" alt="image-20220910131853845" style="zoom:67%;" />

<img src="Resources/image-20220910132434989.png" alt="image-20220910132434989" style="zoom:67%;" />

```java
@Component
@Aspect
public class ServiceLogAspect{
    private static final Logger logger = LoggerFactory.getLogger(ServiceLogAspect);
    //é¦–å…ˆç”³æ˜åˆ‡ç‚¹
    //åŠ ä¸Š PointCutæ³¨è§£ï¼Œå£°æ˜ç»‡å…¥çš„ä½ç½®
    @PointCut("execution(* com.nowcoder.community.service.*.*(..))")
    public void pointCut(){
    }
    
    //ä½¿ç”¨å‰ç½®é€šçŸ¥
    @Before("pointCut()")
    public void before(JointPoint jointPoint){
        //æ ¼å¼ ç”¨æˆ·[ip] åœ¨ XXXæ—¶é—´è®¿é—®äº† XXXæ–¹æ³•
        //è¿™é‡Œéœ€è¦è·å–ç”¨æˆ·åœ°å€ï¼Œä½†ä¸è¦åœ¨è¿™å£°æ˜Requestå¯¹è±¡ï¼Œè€Œä½¿ç”¨å·¥å…·ç±»RequestContextHolder
        ServletReqeustAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();
        String ip = request.getRemoteHost();
        String now = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date());
        //æœ€åè®¿é—®æŸä¸ªç±»çš„æ–¹æ³•ï¼Œéœ€è¦è¿æ¥ç‚¹å‚æ•°jointPoint
        String target = jointPoint.getSignature().getDeclaringTypeName()+"."+jointPoint.getSignature().getName();
        logger.info(String.format("ç”¨æˆ·[%s]ï¼Œåœ¨[%s]è®¿é—®äº†[%s].",ip,now,target));
    }
    
}
```



### 4.1 redisğŸ”°

<img src="Resources/image-20220910145214386.png" alt="image-20220910145214386" style="zoom:67%;" />

å¿«ç…§å½¢å¼ï¼šRDBï¼šæ•´ä½“å­˜å…¥ç¡¬ç›˜ä¸­

æ—¥å¿—å½¢å¼ï¼šAOFï¼šå°†æ—¥å¿—è®°å…¥ç¡¬ç›˜ä¸­ï¼Œå®æ—¶æ€§å¥½ï¼Œä½†ç»´æŠ¤è€—æ—¶

åœ¨githubä¸‹è½½windowsçš„redisï¼Œå®‰è£…åè‡ªåŠ¨è¿è¡Œï¼Œå…¶é»˜è®¤ç«¯å£å·ä¸ºï¼š6379.å°†å…¶é…ç½®åœ¨ç³»ç»Ÿå˜é‡

![image-20220910172826392](Resources/image-20220910172826392.png)

```shell
redis-cli #å¯åŠ¨å®¢æˆ·ç«¯
#ç³»ç»Ÿé»˜è®¤16ä¸ªåº“ï¼Œé‡‡ç”¨0-15å‘½å
>>select 1	#åˆ‡æ¢åˆ°åº“1
OK
>>flushdb  #åˆ·æ–°å†…å®¹
#String ç±»å‹
>>set test:count 1
OK
>>get test:count
"1"
>>incr test:count #å˜é‡è‡ªå¢
(integer) 2
>>decr test:count
(integer) 1
```

```shell
# Hash ç±»å‹æ•°æ®,å€¼ä¹Ÿæ˜¯é”®å€¼å¯¹  hset KEY FIELD VALUE
>>hset test id 1
(integer) 1
>>hset test username zhangshan
"zhanshan"
>>hget test id
"1"
```

```shell
# List åˆ—è¡¨:æ”¯æŒå·¦ã€å³æ’å…¥   å·¦ã€å³å–å€¼
>>lpush test 101 102 103  #ç›¸å½“äºå°†101ï¼Œ102ï¼Œ103å·¦æ’å…¥åˆ—è¡¨ï¼Œæ­¤æ—¶ä¸º[103, 102, 101]
(integer) 3
>>llen test
3
>>lindex test 0
103
>>lrange test 0 2 #è¡¨ç¤ºèŒƒå›´ä»0åˆ°2
1) "103"
2) "102"
3) "101"
>>rpop test  #ä»å³ä¾§å¼¹å‡º
"101"
```

```shell
#Set é›†åˆ
>>sadd test aaa bbb ccc ddd eee
(integer) 5
>>sard test # ç»Ÿè®¡å¤šå°‘å…ƒç´ 
(integer) 5
>>spop test #éšæœºå¼¹å‡ºä¸€ä¸ªå…ƒç´ 
"ccc"
>>smembers test # é›†åˆå‰©ä½™å…ƒç´ 
1) "aaa"
2) "bbb"
3) "ddd"
4) "eee"
```

```shell
#socket setæœ‰åºé›†åˆ :ç»™å®šåˆ†æ•°ï¼ŒæŒ‰åˆ†æ•°æ’åº
>>zadd test 10 aaa 20 bbb 30 ccc 40 ddd 50 eee
(integer) 5
>>zcard test # ç»Ÿè®¡å¤šå°‘å…ƒç´ 
(integer) 5
>>zscore test ccc #æŸ¥è¯¢æŸä¸ªå€¼çš„åˆ†æ•°
"30"
>>zrank test ccc # è¿”å›æŸä¸ªå€¼çš„æ’å
(integer) 2
>>zrange test 0 2
"aaa"
"bbb"
"ccc"
```

```shell
#å…¨å±€å‘½ä»¤
 >>keys * #æŸ¥è¯¢åº“ä¸­æœ‰å¤šå°‘
 >>keys t* #ä»¥ t å¼€å¤´çš„æœ‰å¤šå°‘ä¸ª
 >>type test # æŸ¥è¯¢æ˜¯ä»€ä¹ˆæ•°æ®ç±»å‹çš„
 >>exists test #æŸ¥è¯¢æ˜¯å¦å­˜åœ¨
 >> del
 >>expire test 60 #è®¾ç½®è¯¥keysçš„è¿‡æœŸæ—¶é—´ä¸º60sï¼Œç”¨äºéªŒè¯ç 

```



### 4.7 springboot æ•´åˆredisğŸ”°

<img src="Resources/image-20220910195751926.png" alt="image-20220910195751926" style="zoom:67%;" />

Springbootå°†Redisçš„é”®å€¼å¯¹çš„é”®ç”±Stringè½¬æˆObjectï¼Œä½†æˆ‘ä»¬å¸¸ç”¨è¿˜æ˜¯Stringï¼Œå› æ­¤è¦é‡æ–°é…ç½®

é¦–å…ˆåœ¨application.propertiesé…ç½®

```shell
spring.redis.database=11 #éšä¾¿é€‰ä¸€ä¸ªåº“å°±è¡Œ
spring.redis.host=localhost
spring.redis.port=6379
```

ç¼–å†™é…ç½®ç±»ï¼š

```java
@Configuration
public class RedisConfig{
    @Bean
    public RedisTemplate<String,Object> redisTemplate(RedisConnectionFactory factory){
        //è¦èƒ½è®¿é—®æ•°æ®åº“ï¼Œéœ€è¦åˆ›å»ºè¿æ¥ï¼šæ³¨å…¥å·¥å‚(åœ¨å½¢å‚ä¸­æ³¨å…¥)
        //åœ¨æ–¹æ³•ä¸­å®ä¾‹åŒ–Bean
        RedisTemplate<String,Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        //ä¸»è¦é…çš„æ˜¯åºåˆ—åŒ–çš„æ–¹å¼ï¼ˆå°†javaæ•°æ®å­˜å…¥redisï¼‰
        //1.è®¾ç½®keyçš„åºåˆ—åŒ–æ–¹å¼
        template.setKeySerializer(RedisSerializer.string());
        //2.è®¾ç½®valueçš„åºåˆ—åŒ–æ–¹å¼
        template.setValueSerializer(RedisSerilalizer.json());
        //ç‰¹æ®Šï¼šè®¾ç½®hashçš„keyçš„åºåˆ—åŒ–æ–¹å¼
        template.setHashKeySerializer(RedisSerializer.string());
        //ç‰¹æ®Šï¼šè®¾ç½®hashçš„valueåºåˆ—åŒ–æ–¹å¼
        template.setHashValueSerialize(RedisSerializer.json());
        //ä½¿è®¾ç½®çš„é…ç½®ç”Ÿæ•ˆ
        template.afterPropertiesSet();
        return template;
    }
}
```

```java
//æµ‹è¯•
@Autowired
private RedisTemplate redisTemplate;
@Test
public void testStrings(){
    String redisKey = "test:count";
    redisTemplate.opsForValue().set(redisKey,1);
    sout(redisTemplate.opsForValue().get(redisKey));
    sout(redisTemplate.opsForValue().increment(redisKey));
}
```

æµ‹è¯•HashåŒç†

![image-20220910205107028](Resources/image-20220910205107028.png)

æµ‹è¯•åˆ—è¡¨

![image-20220910205259621](Resources/image-20220910205259621.png)

æµ‹è¯•é›†åˆ

![image-20220910205506828](Resources/image-20220910205506828.png)

å¯¹Keysçš„æµ‹è¯•

![image-20220910205656523](Resources/image-20220910205656523.png)



![image-20220912140722395](Resources/image-20220912140722395.png)

ç¼–ç¨‹å¼äº‹åŠ¡

![image-20220912141747691](Resources/image-20220912141747691.png)

ç”±`multi()` å¼€å¯äº‹åŠ¡ï¼Œç”±`exec()`æäº¤äº‹åŠ¡ï¼Œåœ¨äº‹åŠ¡ä¹‹é—´çš„æ“ä½œä¿å­˜åœ¨é˜Ÿåˆ—é‡Œå¹¶ä¸ä¼šæ‰§è¡Œï¼Œå› æ­¤æŸ¥è¯¢è¯­å¥ä¸ä¼šæ˜¾ç¤ºæŸ¥åˆ°ç»“æœ

### 4.10 ç‚¹èµğŸ”°

ç”±äºredisæ“ä½œç®€å•ï¼Œå› æ­¤ä¸å¼€å‘mapperï¼Œè€Œç›´æ¥å¼€å‘serviceå±‚ï¼Œé¢å‘**key** å®ç°

```java
//å…ˆå†™ä¸ªå·¥å…·ç±»
public class RedisKeyUtil{
    private static final String SPLIT = ":";//å­˜ä¸‹åˆ†éš”ç¬¦
    //æˆ‘ä»¬å°†å¸–å­å’Œå¸–å­çš„è¯„è®ºç§°ä¸ºå®ä½“
    private static final String PREFIX_ENTITY_LIKE = "like:entity";
    
    //è¿”å›æŸä¸ªå®ä½“çš„èµï¼Œæ‹¼æˆä»¥ä¸‹å½¢å¼ï¼š//å°†ç‚¹è¿‡èµçš„ç”¨æˆ·idå­˜å…¥é›†åˆä¸­
    // like:eneity:{entityType}:{entityId} -> set(userId)
    public static String getEntityLikeKey(int entityType,int entityId){
        return PREFIX_ENTITY_LIKE + SPLIT + entityType + SPLIT + entityId;
    }
}
```

```java
// LikeService
@Service
public class LikeService{
    @Autowired
    private RedisTemplate redisTemplate;
    
    //ç‚¹èµ
    public void like(int userId,int entityType,int entityId){
        //å­˜å…¥Redisçš„keyç»Ÿä¸€å‘½å
        String entityLikeKey = RedisKeyType.getEntityLikeKey(entityType,entityId);
        //æ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼ˆç‚¹è¿‡èµå†æ¬¡ç‚¹å‡»å°±æ˜¯å–æ¶ˆï¼‰
        boolean isMember = redisTemplate.opsForSet().idMemeber(entityLikeKey,userId);
        if(isMember){
            redisTemplate.opsForSet().remove(entityLikeKey,useId);
        }else{//å¦åˆ™å°±æ·»åŠ æ•°æ®
            redisTemplate.opsForSet().add(entityLikeKey,useId);
        }
    }
    
    //æŸ¥è¯¢å®ä½“çš„ç‚¹èµæ•°é‡
    public long findEntityLikeCount(int entityType,int entityId){
        String entityLikeKey = RedisKeyType.getEntityLikeKey(entityType,entityId);
        return redisTemplate.opsForSet().size(entityLikeKey);
    }
    //æŸ¥è¯¢æŸäººå¯¹æŸå®ä½“çš„ç‚¹èµçŠ¶æ€ï¼Œè¿”å›æ•´æ•°ï¼ˆä»¥åä¸šåŠ¡æ‰©å±•å‡ºç‚¹è¸©ï¼‰
    public int findEntityLikeStatus(int userId,int entityType,int entityId){
        String entityLikeKey = RedisKeyType.getEntityLikeKey(entityType,entityId);
        return redisTemplate.opsForSet().isMember(entityLikeKey,userId)?1:0;
    }
}
```

```java
//è¡¨ç°å±‚ï¼šç‚¹èµæ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œå³æ—¶åˆ·æ–°
@Controller
public class LikeController{
    @Autowired
    private LikeService likeService;
    @Autowired
    private HostHolder hostHolder;
    
    @Requestmapping(path = "/like",method =RequestMethod.POST)
    @ResponseBody//å¼‚æ­¥è¯·æ±‚
    public String liek(int eneityType,int entityId){
        User user = hostHolder.getUser();
        //ä»¥åä¼šä½¿ç”¨Spring Securityå¯¹æ‹¦æˆªå™¨é‡æ„
        //ç‚¹èµå®ç°
        likeService.like(user.getId(),entityType,entityId);
        //æ•°é‡
        long likeCount = likeService.findEntityLikeCount(entityType,entityId);
        //çŠ¶æ€	
        int likeStatus = likeService.findEntityLikeStatus(user.getID(),entityType,entityId);
        //ç”¨map å°è£…
        Map<String,Object> map = new HashMap<>();
        map.put("likeCount",likeCount);
        map.put("likeStatus",likeStatus);
        //æœ€ç»ˆè¿”å›jsonæ ¼å¼æ•°æ®
        return CommunityUtil.getJsonString(0,null,map);//è¿™æ˜¯ä¹‹å‰å°è£…çš„å·¥å…·
    }
}
```

ä¿®æ”¹æ¨¡æ¿

æ‰¾åˆ°ç‚¹èµçš„ä½ç½®ï¼Œä¿®æ”¹hrefä¸ºç©ºï¼Œæ–°å¢ `onclick`æ ‡ç­¾ï¼Œé‡Œé¢è°ƒç”¨jså‡½æ•°`like(this,1,${post,id})`
this æ˜¯ä»æœ¬é¡µé¢ä¸‰ç§ç±»å‹çš„èµæ‰¾åˆ°ï¼Œ1æ˜¯è¡¨ç¤ºå¸–å­çš„entityType

![image-20220912151419460](Resources/image-20220912151419460.png)

è¿”å›çŠ¶æ€ï¼šèµæ˜¯æ•°é‡
![image-20220912151708160](Resources/image-20220912151708160.png)

å†™ä¸ªjsæ–‡ä»¶

![image-20220914221127201](Resources/image-20220914221127201.png)

btnæ˜¯å½“å‰æŒ‰é’®ï¼Œè·å–æŒ‰é’®ä¸‹çš„æ ‡ç­¾bï¼Œå’Œiï¼Œä¿®æ”¹å…¶å€¼

è¿è¡Œåå¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯åˆå§‹æ˜¾ç¤ºçš„èµæ•°é‡ä¸å¯¹



### 4.13 æˆ‘å—åˆ°çš„èµ

### 4.16 å…³æ³¨ã€å–æ¶ˆå…³æ³¨

### 4.19 å…³æ³¨åˆ—è¡¨ã€ç²‰ä¸åˆ—è¡¨

### 4.23 ä¼˜åŒ–ç™»å…¥æ¨¡å—



### 5.1é˜»å¡é˜Ÿåˆ—ğŸ”°

![image-20220914223339003](Resources/image-20220914223339003.png)



### 5.5 kafkağŸ”°

![image-20220914224515423](Resources/image-20220914224515423.png)

é«˜ååé‡ï¼Œæ¶ˆæ¯æŒä¹…åŒ–ï¼šå¯¹ç¡¬ç›˜çš„é¡ºåºè¯»å–æ•ˆç‡æ˜¯é«˜äºå†…å­˜çš„éšæœºè¯»å–çš„ã€‚
é«˜å¯é æ€§ï¼šæ˜¯åˆ†å¸ƒå¼çš„
Brokerï¼škafkaé›†ç¾¤ä¸Šæ¯ä¸€ä¸ª**æœåŠ¡å™¨**ç§°ä¸ºBroker
Zookeeperï¼šç”¨äºç®¡ç†é›†ç¾¤
Topicï¼šç”¨äºç‚¹å¯¹å¤šç”Ÿäº§æ¶ˆè´¹æ–¹å¼ï¼Œæ¶ˆè´¹è€…å‘å¸ƒåçš„ï¼Œ ç”¨äºå­˜æ”¾æ¶ˆæ¯çš„ä½ç½®
Partitionï¼šå¯¹topicä½ç½®çš„åˆ†åŒº
offsetï¼šæ¶ˆæ¯åœ¨åˆ†åŒºå†…å­˜æ”¾çš„ç´¢å¼•
Replicaï¼šå‰¯æœ¬ï¼Œä¸»å‰¯æœ¬å’Œä»å‰¯æœ¬ï¼ˆåªåšå¤‡ä»½ä¸åšå“åº”ï¼‰ï¼Œä¸»å‰¯æœ¬æŒ‚æ‰ï¼Œä¼šä»ä¼—å¤šä»å‰¯æœ¬é‡æ–°é€‰

ä¸‹è½½kafkaï¼Œåšåˆå§‹é…ç½®ã€‚ï¼ˆ.sh æ˜¯linuxå‘½ä»¤ï¼Œ.bat æ˜¯Windowså‘½ä»¤ï¼‰é»˜è®¤ç«¯å£æ˜¯9092

1.é…ç½®zookeeperï¼Œå°†åŸæœ¬liunxåœ°å€æ”¹æˆwindowsä¸‹åœ°å€

![image-20220914225749325](Resources/image-20220914225749325.png)ã€

![image-20220914225855475](Resources/image-20220914225855475.png)

2.é…ç½®server.propertiseï¼š![image-20220914230005260](Resources/image-20220914230005260.png)
é»˜è®¤æ—¥å¿—åœ°å€æ”¹ä¸ºwindows

å¯åŠ¨æµ‹è¯•ï¼šéœ€è¦å…ˆå¯åŠ¨zookeeperï¼Œå¹¶æŒ‡å®šé…ç½®æ–‡ä»¶

![image-20220914230232479](Resources/image-20220914230232479.png)

å†æ‰“å¼€å¦ä¸€ä¸ªå‘½ä»¤è¡Œï¼Œå¯åŠ¨kafka

![image-20220914230349079](Resources/image-20220914230349079.png)

æ‰§è¡Œä»¥ä¸‹ï¼š![image-20220916224450539](Resources/image-20220916224450539.png)

`--create` åˆ›å»ºä¸»é¢˜
`--bootstrap--server` åœ¨å“ªä¸ªä¸»é¢˜ä¸Š
`--replication-factor 1`  åˆ›å»º 1 ä¸ªå‰¯æœ¬
`--partitions 1`   ä¸€ä¸ªåˆ†åŒº
`--topic`  ä¸»é¢˜åå­—

æŸ¥è¯¢ä»¥ä¸‹æœ‰æ²¡æœ‰åˆ›å»ºæˆåŠŸï¼š![image-20220916224823102](Resources/image-20220916224823102.png)

æ¥ä¸‹æ¥å‘é€æ¶ˆæ¯ï¼Œä»¥ç”Ÿäº§è€…èº«ä»½è°ƒç”¨

![image-20220916224955009](Resources/image-20220916224955009.png)

`--broker-list` é€‰æ‹©æœåŠ¡å™¨ï¼ˆç°åœ¨åªæœ‰ä¸€ä¸ªï¼‰   `--topic test` é€‰æ‹©ä¸»é¢˜ã€‚å®Œæˆåä¸‹è¡Œå‡ºç°ä¸‰è§’

![image-20220916225154483](Resources/image-20220916225154483.png)

å‘é€äº†æ¶ˆæ¯ï¼Œç°åœ¨æ˜¯é˜»å¡çŠ¶æ€ï¼Œç„¶åæˆ‘ä»¬å†æ‰“å¼€ä¸€ä¸ªcmdå¯ç”¨æ¶ˆè´¹è€…

![image-20220916225340895](Resources/image-20220916225340895.png)

ç„¶ååœ¨ç”Ÿäº§è€…è¾“å…¥ï¼Œæ¶ˆè´¹è€…ä¼šè‡ªåŠ¨å‡ºç°ï¼ˆæœ‰ç‚¹åƒèŠå¤©ï¼‰



### 5.9 springboot æ•´åˆkafkağŸ”°

springä¸­æ•´åˆçš„ä¸»è¦ä¾èµ–`kafkaTemplate`ï¼ˆç”¨çš„æ—¶å€™ç›´æ¥æ³¨å…¥ï¼‰

![image-20220916225524714](Resources/image-20220916225524714.png)

1.mvnå¼•å…¥kafka

2.é…ç½®properties

å…ˆæ‰“å¼€kafakæ–‡ä»¶çš„consumer.properties

![image-20220916225934873](Resources/image-20220916225934873.png)

![image-20220916230100151](Resources/image-20220916230100151.png)

å†™æµ‹è¯•

```java
public class KafkaTests{
    @Autowired
    private KafkaProducer kafkaProducer;
    @Test
    public void testKafka(){
        kafkaProducer.sendMessage("test","ä½ å¥½");
        kafkaProducer.sendMessage("test","åœ¨å—");
        //ç­‰å¾…ä¸€ä¸‹è®©æ¶ˆè´¹è€…è¾“å‡º
        try{
            Thread.sleep(10000);
        }catch(Exception e){
            e.printStackTrace();
        }
    }
}

//åœ¨è¿™é‡Œå†™ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
@Component
class KafkaProducer{
    @Autowired
    private KafkaTemplate kafkaTemplate;
    public void sendMessage(String topic,String content){//å‚æ•°æ˜¯ä¸»é¢˜å’Œå†…å®¹
        kafkaTemplate.send(topic,content);
    }
}

@Component
class KafkaConsumer{
    //ä¸éœ€è¦kafkaTemplateï¼Œå› ä¸ºæ˜¯è¢«åŠ¨çš„æ¥å—å‚æ•°
    @KafkaListener(topics={"test"})//springè‡ªåŠ¨ç›‘å¬è¿™äº›ä¸»é¢˜ï¼Œé˜»å¡ç›‘å¬ï¼Œç„¶åäº¤ç»™æ–¹æ³•
	public void handleMessage(ConsumerRecord record){
        sout(record);
    }
    
}
```

å…³é”®ç‚¹ï¼š**ç”Ÿäº§è€…æ˜¯ä¸»åŠ¨è°ƒç”¨çš„ï¼Œè€Œæ¶ˆè´¹è€…è¢«åŠ¨çš„**



### 5.11 å‘é€ç³»ç»Ÿé€šçŸ¥ğŸ”°



![image-20220916232907187](Resources/image-20220916232907187.png)

ä»¥äº‹ä»¶ä½œä¸ºé©±åŠ¨ï¼Œå®šä¹‰äº‹ä»¶class

```java
public class Event{
    private String topic;
    private int userId;
    private int entityType;
    private int entityId;
    private int entityUserId;
    private Map<String,Object> data = new HashMap<>();//å­˜å…¶ä»–è¿˜ä¸çŸ¥é“çš„ä¸œè¥¿
    //å¯¹åº”getterï¼Œsetter
    //ä¿®æ”¹setteræ–¹æ³•ï¼Œè¿”å›å€¼Eventï¼Œå¯ä»¥æ¯æ¬¡å¢åŠ ä¸€ä¸ªå±æ€§ï¼Œè¿”å›å†æ¬¡å¢åŠ 
    //ä¿®æ”¹setDataæ–¹æ³•ï¼Œä½¿ä¹‹ä¸è¦ç›´æ¥ä¼ mapï¼Œ
    public Event setData(String key,Object value){
        this.data.put(key,value);
        return this;
    }
}
```

æ¥ç€å¼€å‘äº‹ä»¶çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼š

æ–°å»ºä¸€ä¸ªåŒ…Event

```java
//ç”Ÿäº§è€…éœ€è¦è°ƒç”¨kafkaTemplate
public class EventProducer{
    @Autowired
    private KafkaTemplate kafkaTemplate;
    //å¤„ç†äº‹ä»¶
    //
    public void fireEvent(Event event){
        //å°†äº‹ä»¶å‘å¸ƒåˆ°æŒ‡å®šçš„ä¸»é¢˜
        //å†…å®¹ä¸ºjsonæ ¼å¼
        kafkaTemplate.send(event.getTopic(),JSONObject.toJSONString(event));
    }
}
```

```java
public class EventConsumer{
    private static final Logger logger = LoggerFactory.getLogger(EventConsumer.class);
    //å¤„ç†äº‹ä»¶æ˜¯ä¸ºäº†ç»™messageè¡¨æ’å…¥æ•°æ®
    @Autowired
    private MessageService messageService;
    //å¯ä»¥ä¸€ä¸ªæ–¹æ³•æ¶ˆè´¹ä¸€ä¸ªä¸»é¢˜ï¼Œä¸€ä¸ªæ–¹æ³•æ¶ˆè´¹å¤šä¸ªä¸»é¢˜
    @KafkaListener(topics={/*å†™åœ¨æ¥å£çš„å¸¸é‡*/TOPIC_COMMENT,TOPIC_LIKE,TOPIC_FOLLOW})
    public void handlerCommentMessage(ConsumerRecord record){
        if(record==null||record.value()==null){
            logger.error("æ¶ˆæ¯å†…å®¹ä¸ºç©º");return ;
        }
        //å°†JSONæ ¼å¼å­—ç¬¦ä¸²æ¢å¤æˆå¯¹è±¡
        Event event= JSONObject.parseObject(record.value().toString(),Event.class);
        if(event==null){
            logger.error("æ¶ˆæ¯æ ¼å¼é”™è¯¯");return;
        }
        Message message = new Message();
        message.setFromId(1);//æˆ–è€…å­˜å…¥æ¥å£å¸¸é‡
        message.setToID(event.getEntityUserId());
        message.setConversationId(event.getTopic());
        message.setCreateTime(new Date());
        
        //æˆ‘ä»¬éœ€è¦åœ¨é€šçŸ¥ä¸­æ‹¼å‡ºè¯­å¥ï¼Œè° å¹²äº†ä»€ä¹ˆï¼Œç„¶åé“¾æ¥åˆ°æŒ‡å®šä½ç½®
        Map<String,Object> content = new HashMap<>();
        content.put("userId",event.getUserID());//è·å–å“ªä¸ªç”¨æˆ·å¹²äº†ä»€ä¹ˆ
        content.put("entityType",event.getEntityEype());
        content.put("entityId",event.getEntityId());
        
        if(!event.getData().isEmpty()){
            for(Map.Entry<String,Object> entry:event.getData().entrySet()){
                content.put(entry.getKey(),entry.getValue());
            }
        }
        
        message.setContent(JSONObject.toJSONSTRING(content));
        messageService.add(message);
        //æ–¹æ³•æ˜¯æ¶ˆè´¹ä¸‰ä¸ªä¸»é¢˜çš„æ•°æ®ï¼Œæ¶ˆè´¹çš„é€»è¾‘æ˜¯å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯æ„é€ ä¸€æ ·
    }
}
```



```java
//CommentController æ·»åŠ 
//æ³¨å…¥äº‹ä»¶
@Autowired
private EventProducer eventProducer;//åœ¨LikeControllerå’ŒFollowControllerä¹Ÿè¦åŠ ä¸Š
//åœ¨addCommentå‡½æ•°ä¸­æ·»åŠ ä»£ç 
{
    //åœ¨commentService.addComment(comment); ä¹‹åæ“ä½œ
    //è§¦å‘è¯„è®ºäº‹ä»¶
    //1.æ„é€ äº‹ä»¶å¯¹è±¡ï¼Œå°†å†…å®¹åŒ…å«è¿›æ¥
    Event event = new Event().setTopic(1/*å¼•ç”¨å¸¸é‡*/).setUserId(hostHolder.getUser().getId())
        .setEntityType(comment.getEntityType())
        .setEntityId(comment.getEntityId())
        .setData("PostId",disscussPostId);//ç”¨äºé“¾æ¥æ—¶ éœ€è¦å¸–å­IDï¼Œè¿™é‡Œå­˜è¿›map
    //åŒºåˆ†å¸–å­è¿˜æ˜¯è¯„è®ºæ¥è·å¾—å¯¹åº”UserId
    if(commetn.getEntityType()==?){
        DiscussPost target = discussPostService.findDiscussPostById(comment.getEntityId());
        event.setEntityUserId(target.getUserId());
    }else{
        //..
    }
    //ä¹‹åæˆ‘ä»¬å†è°ƒç”¨Producerå¤„ç†äº‹ä»¶
    eventProducer.fireEvent(event);//æ–°çº¿ç¨‹æ‰§è¡Œï¼Œä¸ä¼šå½±å“åç»­ä¸šåŠ¡
}


```















### 5.13 æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥

å°†ä¸Šä¸€èŠ‚å­˜å…¥æ•°æ®åº“çš„é€šçŸ¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š

![image-20221008203456892](Resources/image-20221008203456892.png)

daoå±‚

```java
//MessageMapperæ·»åŠ ï¼š
//æŸ¥è¯¢æŸä¸ªä¸»é¢˜ä¸‹æœ€æ–°é€šçŸ¥     æŸ¥è¯¢æŸä¸ªä¸»é¢˜ä¸‹é€šçŸ¥æ•°é‡	æœªè¯»çš„é€šçŸ¥æ•°é‡
Message selectLatestNotice(int userId,String topic);
int selectNoticeCount(int userId,String topic);
int selectNoticeUnreadCount(int userId,String topic);

```

mapper

```xml
<!--Message-mapper-->
<select id="selectLatestNotice" resultType="Message">
	select <include refid="selectFields"></include>
    from message
    where id in(
    	select max(id) from message
    	where status!=2 and from_id=1' and to_id =#{userId} and conversation_id =#{topic}
    ) 
</select>


<select id="selectNoticeCount" resultType="int">
	select count(id)
    from message
    where status!=2
    and from_id =1
    and to_id = #{userId}
    and conversation_id = #{topic}
</select>

<select id="selectNoticeUnreadCount" resultType="int">
	select count(id)
    from message
    where status=0<!--è¡¨ç¤ºæœªè¯»-->
    and from_id =1
    and to_id = #{userId}
    <if test="topic!=null">
    	and conversation_id=#{topic}
    </if>
</select>
```

service

```java
//MessageService
```





### 6.1 ElasticSearchğŸ”°

å­¦ä¹ ç¬”è®°ï¼š[(13æ¡æ¶ˆæ¯) Elasticsearchå­¦ä¹ ç¬”è®°_å·¨è¼ªçš„åšå®¢-CSDNåšå®¢_elasticsearchå­¦ä¹ ç¬”è®°](https://blog.csdn.net/u011863024/article/details/115721328)

<img src="Resources/image-20221013164958801.png" alt="image-20221013164958801" style="zoom:67%;" />

Restfulï¼šæ¯ä¸ªURIä»£è¡¨ä¸€ä¸ªèµ„æºï¼›å®¢æˆ·ç«¯é€šè¿‡å››ä¸ªhttpåŠ¨è¯ï¼Œå®¢æˆ·ç«¯ä¸èƒ½æ“ä½œèµ„æºè€Œæ˜¯æäº¤è¯·æ±‚ï¼›å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’é€šè¿‡è¡¨ç°å±‚ã€‚

> ESä¸­çš„**ç´¢å¼•**ä¸æ•°æ®åº“çš„**database**å¯¹åº”()ï¼ˆ6.0å ç´¢å¼•å¯¹åº”tableï¼‰
>
> ESä¸­çš„**ç±»å‹**ä¸æ•°æ®åº“çš„ **table**å¯¹åº”ï¼ˆé€æ¸åºŸå¼ƒï¼‰
>
> **æ–‡æ¡£**ï¼šä¸€æ¡**æ•°æ®**ï¼Œä¸€è¡Œï¼Œæ–‡æ¡£æ•°æ®ç»“æ„ä¸€èˆ¬ä¸ºjsonï¼Œjsonçš„ä¸€ä¸ªå±æ€§ä¸º**å­—æ®µ**

> **é›†ç¾¤**çš„æ¯ä¸€ä¸ªæœåŠ¡å™¨ç§°ä¸º**èŠ‚ç‚¹**
>
> **åˆ†ç‰‡**ï¼šå¯¹ç´¢å¼•çš„è¿›ä¸€æ­¥åˆ’åˆ†ï¼ˆå¹¶å‘åœ°å­˜ï¼‰
>
> **å‰¯æœ¬**ï¼šå¯¹åˆ†ç‰‡çš„å¤‡ä»½



ä¸‹è½½ä¿®æ”¹é…ç½® elasticsearch.yml

```yaml
cluster.name: nowcoder   #é›†ç¾¤åå­—
path.data: d:/work/data/elasticsearch-6.4.3/data #æ•°æ®ç›®å½• 
path.log: d:/work/data/elasticsearch-6.4.3/logs #æ—¥å¿—
```

ç„¶åé…ç½®ç¯å¢ƒå˜é‡

ç„¶åå®‰è£…<u>ä¸­æ–‡åˆ†è¯æ’ä»¶</u>ï¼šåœ¨githubä¸Šæœç´¢  `elasticsearch ik`
å¿…é¡»è§£å‹åˆ° `work/elasticsearch-6.4.3/plugins/ik` ç›®å½•ä¸‹

å¦‚ä½•å¯åŠ¨ï¼š`bin /elasticsearch.bat`
æç¤ºç»‘å®šäº†<font color='litblue'>9200</font>ç«¯å£ï¼Œè¡¨ç¤ºæˆåŠŸ

æ‰“å¼€å‘½ä»¤è¡Œè®¿é—®ï¼š

```
curl -X GET "localhost:9200/-cat/health?v"    #æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶å†µ  vè¡¨ç¤ºæ˜¾ç¤ºæ ‡é¢˜
```

![image-20221014155708679](Resources/image-20221014155708679.png)

æŸ¥çœ‹é›†ç¾¤æœ‰ä»€ä¹ˆèŠ‚ç‚¹

```
curl -X GET "localhost:9200/-cat/nodes?v"
```

![image-20221014155820833](Resources/image-20221014155820833.png)

æŸ¥çœ‹å½“å‰æœåŠ¡å™¨æœ‰å¤šå°‘ä¸ªç´¢å¼•ï¼Ÿï¼ˆES6.0ä»¥ä¸Šç´¢å¼•å°±æ˜¯ä¸€ä¸ªè¡¨ï¼‰

```
curl -X GET "localhost:9200/-cat/indices?v"
```

æ²¡æœ‰æ•°æ®ï¼ŒåŠæ²¡æœ‰ç´¢å¼•

å¦‚ä½•å»ºç«‹ç´¢å¼•ï¼Ÿè¿”å›jsonæ ¼å¼

```
curl -X PUT "localhost:9200/test"  #ä½¿ç”¨put
```

![image-20221014160104012](Resources/image-20221014160104012.png)

ç„¶åå†æ¬¡æŸ¥è¯¢æœ‰å¤šå°‘ç´¢å¼•

![image-20221014160212913](Resources/image-20221014160212913.png)

ç´¢å¼•çš„å¥åº·çŠ¶å†µä¸ºyellowï¼Œç„¶ååˆ é™¤ç´¢å¼•ï¼š

![image-20221014161111166](Resources/image-20221014161111166.png)

é‡‡ç”¨postmanæ¥æ“ä½œï¼šæ·»åŠ ä¸€æ¡å­—æ®µï¼ˆtestç´¢å¼•ä¸‹ï¼Œid ä¸º 1ï¼‰

![image-20221014161742810](Resources/image-20221014161742810.png)

ç»“æœï¼š<img src="Resources/image-20221014161953256.png" alt="image-20221014161953256" style="zoom: 80%;" />

å†æŸ¥è¯¢è¿™æ¡æ•°æ®ï¼š

![image-20221014162050958](Resources/image-20221014162050958.png)

![image-20221014162108792](Resources/image-20221014162108792.png)

åœ¨è¡¨ä¸­æŸ¥è¯¢ï¼Œä½¿ç”¨searchï¼Œï¼ˆä¸åŠ å…¶ä»–å‚æ•°åˆ™éƒ½ä¼šå‘½ä¸­ï¼‰

![image-20221014163224067](Resources/image-20221014163224067.png)

æŸ¥è¯¢content

![image-20221014163328496](Resources/image-20221014163328496.png)

ä¼šå¯¹å…³é”®å­—æä¾›åˆ†è¯

å¦‚æœè¦å¤åˆæŸ¥è¯¢ï¼šï¼ˆåœ¨putè¯·æ±‚ä¸­ä½¿ç”¨rowæ ¼å¼bodyï¼Œé‡‡ç”¨jsonæ ¼å¼ï¼‰

![image-20221014163635280](Resources/image-20221014163635280.png)

å…³é”®å­—ï¼šquery:â€œäº’è”ç½‘â€
åœ¨å“ªäº›å­—æ®µï¼šfieldsï¼šæ ‡é¢˜å’Œå†…å®¹éƒ½æŸ¥è¯¢

### 6.4 spring bootæ•´åˆElasticSearchğŸ”°

<img src="Resources/image-20221014163838781.png" alt="image-20221014163838781" style="zoom:67%;" />

ElasticsearchTemplateæ˜¯ç±»ï¼ŒElasticsearchRepositoryæ˜¯æ¥å£

ESçš„ç«¯å£æœ‰9200ï¼ˆåŸºäºHttpï¼‰ï¼Œ9300ï¼ˆåŸºäºTCPï¼‰

ESçš„åº•å±‚åŸºäºnettyï¼Œè€Œredisåº•å±‚ä¹ŸåŸºäºnettyï¼Œä¼šå‡ºç°å†²çªï¼Œ
åœ¨nettyRuntimeç±»ä¸­æœ‰ä¸ªsetAvailableProcessors æ–¹æ³•ï¼Œredisè°ƒç”¨äº†åˆ™å½“ES çš„Netty4Utilsä¹Ÿè°ƒç”¨å°±ä¼šå‡ºé”™ï¼Œéœ€è¦è®¾ç½®å‚æ•°

```properties
spring.data.elasticsearch.cluster-name=nowcoder#å®‰è£…æ—¶åœ¨é…ç½®æ–‡ä»¶ä¿®æ”¹çš„
spring.data.elasticsearch.cluster-nodes=127.0.0.1:9300
```

æ¥ä¸‹æ¥è§£å†³ä¸€ä¸ªå†²çª

```java
//åœ¨CommunityApplicationä¸­ï¼Œæ·»åŠ ä¸€ä¸ª@PostContrust ä¿®é¥°çš„æ–¹æ³•
@PostConstruct
public void init(){
    //è§£å†³nettyå¯åŠ¨å†²çªé—®é¢˜
    System.setProperty("es.set.netty.runtime.available.processors","false");
}
//ä¸‹é¢æ˜¯mainæ–¹æ³•
```

æˆ‘ä»¬éœ€è¦é€šè¿‡æ³¨è§£æ¥ä¿®æ”¹ä¹‹å‰çš„å®ä½“ç±»

```java
//é€šè¿‡æ³¨è§£è®©ESä¸å®ä½“ç±»å±æ€§æ˜ å°„
@Document(indexName="discusspost",type="_doc",shards=6,replicas=3)//åˆ›å»ºå‡ ä¸ªåˆ†ç‰‡å’Œå‰¯æœ¬
public class DiscussPost{
    @ID
    private int id;
    
    @Field(type=FieldType.Integer)//å…¶ä»–å±æ€§
    private int userId;
    
    //ä¸¤ä¸ªåˆ†è¯å™¨ï¼Œç¬¬ä¸€ä¸ªæ˜¯å­˜å‚¨ï¼Œç¬¬äºŒä¸ªæ˜¯æœç´¢ï¼Œå­˜å‚¨æ—¶é‡‡ç”¨å°½å¯èƒ½å¤šçš„åˆ†è¯
    @Field(type=FieldType.Text,analyzer="ik_max_word",searchAnalyzer = "ik_smart")//æ–‡æœ¬ç±»å‹ï¼Œå­˜å‚¨æ—¶è§£æå™¨å’Œæœç´¢æ—¶è§£æå™¨
    private String title;//æœç´¢çš„å…³é”®å­—æ®µ
    
    //....å…¶ä½™ç±»ä¼¼
    
}
```

åœ¨serviceåŒ…ä¸‹åˆ›å»ºelasticsearchåŒ…ï¼Œåˆ›å»ºåä¸º `DiscussPostRepository`æ¥å£ï¼ŒåŠ ä¸Š@Repository

```java
@Repository
//æ¥å£éœ€è¦ç»§æ‰¿ElasticsearchRepositoryï¼Œå¹¶æŒ‡å®šæ³›å‹å­˜çš„å®ä½“ç±»å’Œä¸»é”®
public interface DiscussPostRepository extends ElasticsearchRepository<DiscussPost,Integer>{
    
}
```

```java
//æµ‹è¯•
//ç”±äºæ˜¯éœ€è¦ä»mysqlä¸­å–å‡ºï¼Œè½¬å­˜åˆ°esä¸­
{	
    @Autowired
    public DiscussPostMapper = discussMapper;
    
    @Autowired
    private DiscussPostReposiory = discussPostReposiory;
    
    @Autowired
    private ElasticsearchTemplate elasticsearchTemplate;//æœ‰æ—¶å€™Reposioryæ¥å£å¤„ç†ä¸äº†çš„éœ€è¦ä½¿ç”¨Templateå­ç±»æ¥è§£å†³
	
    //å‘ESæœåŠ¡å¤„æ’å…¥æ•°æ®
    @Test
    public void testInsert(){
        discussRepository.save(discussMapper.selectDiscussPostById(241));
    }
    
    //æŸ¥è¯¢
    @Test
    public void testSearchByRepository(){
        SearchQuery searchQuery = new NativeSearchQueryBuilder().withQuery(QueryBuilders.multiMatchQuery("äº’è”ç½‘å¯’å†¬","title","content"))
            .withSort(SortBuilders.fieldSort("type").order(SortOrder.DESC))
            .withSort(SortBuilders.fieldSort("score").order(SortOrder.DESC))
             .withSort(SortBuilders.fieldSort("creatTime").order(SortOrder.DESC))
            .withPageable(PageRequest.of(0,10))
            .withHighlightFields(
        		new HighlightBuilder.Fields("title").preTags("<em>").postTags("</em>"),
            	new HighlightBuilder.Fields("content").preTags("<em>").postTags("</em>"),
        ).build();
        
        //é€šè¿‡Pageå¯¹è±¡å¯¹æŸ¥è¯¢ç»“æœå°è£…
        Page<DiscussPost> page = discussRepository.search(searchQuery);
        sout(page.getTotalElements());
        sout(page.getTotalPages());
        sout(page.getNumber());
        //ç”±äºRepositoryæ¥å£åº•å±‚å®ç°ï¼Œå¹¶æ²¡æœ‰å°†é«˜äº®ç»“æœæ•´åˆï¼Œä¸‹é¢ä½¿ç”¨TemplateæŸ¥è¯¢
        
    }
    
    @Test
    public void testSearchByTempalte(){
        //ä¸€æ ·çš„SearchQuery
        SearchQuery searchQuery = new NativeSearchQueryBuilder().withQuery(QueryBuilders.multiMatchQuery("äº’è”ç½‘å¯’å†¬","title","content"))
            .withSort(SortBuilders.fieldSort("type").order(SortOrder.DESC))
            .withSort(SortBuilders.fieldSort("score").order(SortOrder.DESC))
             .withSort(SortBuilders.fieldSort("creatTime").order(SortOrder.DESC))
            .withPageable(PageRequest.of(0,10))
            .withHighlightFields(
        		new HighlightBuilder.Fields("title").preTags("<em>").postTags("</em>"),
            	new HighlightBuilder.Fields("content").preTags("<em>").postTags("</em>"),
        ).build();
        
        Page<DiscussPost> page = elasticTemplate.queryForPage(searchQuery,DiscussPost.class,new SearchResultMapper(){
            @Override
            public <T> AggregatedPage<T> mapResults(SearchResponse searchResponse,Class<T> aClass,Pageable pageable){
                //å…ˆé€šè¿‡responseå–åˆ°è¿™æ¬¡æœç´¢å¾—åˆ°çš„æ•°æ®
                SearchHits hits = response.getHits();
                if(hits.getTotalHits()<=0) return null;
                //æœ€ç»ˆéœ€è¦å°†æ•°æ®å°è£…åˆ°é›†åˆé‡Œè¿”å›
                List<DiscussPost> list = new ArrayList<>();
                for(SearchHit hit:hits){
                    DiscussPost post = new DiscussPost();
                    //ç”±äºæ˜¯Jsonæ ¼å¼çš„ï¼Œéœ€è¦toString
                    String id = hit.getSourceAsMap().get("id").toString();
                    post.setId(Integer.valueOf(id));
                    String userId = hit.getSourceAsMap().get("userId").toString();
                    post.setUserId(Integer.valueOf(userId));
			//ç”±äºæœ‰å¯èƒ½åŒ¹é…çš„å­—æ®µåªåœ¨titleæˆ–contentä¸­ï¼Œæ‰€ä»¥å…ˆå°†åŸå§‹titleï¼Œcontentå†™å…¥é˜²æ­¢ç©º
                    //åŸå§‹titleï¼Œéé«˜äº®æ˜¾ç¤ºçš„
                    String title = hit.getSourceAsMap().get("title").toString();
                    post.setTitle(title);
                    String content = hit.getSourceAsMap().get("content").toString();
                    post.setContent(content);
                    String status = hit.getSourceAsMap().get("status").toString();
                    post.setStatus(Integer.valueOf(status));
                    String createTime = hit.getSourceAsMap().get("userId").toString();
                    post.setCreateTime(new Date(Long.valueOf(createTime)));//ESåœ¨å­˜æ—¥æœŸæ—¶è½¬æˆlong
                    String commentCount = hit.getSourceAsMap().get("commentCount").toString();
                    post.setCommentCount(Integer.valueOf(commentCount));
                    //è·å–é«˜äº®å†…å®¹
                    HeightlightField titleField = hit.getHighlightFields().get("title");
                    if(titleField!=null){
                        //getFregments è¿”å›çš„æ˜¯æ•°ç»„ï¼Œå› ä¸ºä¸€æ®µå†…å®¹ä¸­å¯èƒ½å‡ºç°å¤šæ¬¡åŒ¹é…ä¸²
                        post.setTitle(titleField.getFragments()[0].toString();
                    }
                    HeightlightField contentField = hit.getHighlightFields().get("content");
                    if(contentField!=null){
                        //getFregments è¿”å›çš„æ˜¯æ•°ç»„ï¼Œå› ä¸ºä¸€æ®µå†…å®¹ä¸­å¯èƒ½å‡ºç°å¤šæ¬¡åŒ¹é…ä¸²
                        post.setContent(contentField.getFragments()[0].toString();
                    }
                    list.add(post);
                    //è¿”å›ç±»å‹æ˜¯ AggregatedPage<T> æ¥å£ï¼Œéœ€è¦æ„é€ ä¸€ä¸ªå®ç°ç±»
                }
                                        //éœ€è¦å‚æ•°ï¼šå…·ä½“æŸ¥çœ‹åº•å±‚å®ç°
                return new AggregatedPageImpl<>(list,pageable,hits.getTtotalHits(),response.getAggregations(),
                                               response.getScrollId(),hits.getMaxScore());
            }
        });
        //ç›¸åŒä»£ç 
        Page<DiscussPost> page = discussRepository.search(searchQuery);
        sout(page.getTotalElements());
        sout(page.getTotalPages());
        sout(page.getNumber());
    }
}


```



### 6.6 å¼€å‘ç¤¾åŒºæœç´¢åŠŸèƒ½ğŸ”°

åŠŸèƒ½ï¼š

- æœç´¢æœåŠ¡
    	å°†å¸–å­ä¿å­˜åˆ°ESæœåŠ¡å™¨
    	ä»ESæœåŠ¡å™¨åˆ é™¤å¸–å­
    	ä»ESæœåŠ¡å™¨æœç´¢å¸–å­
- å‘å¸ƒäº‹ä»¶
     å‘å¸ƒå¸–å­æ—¶ï¼Œå°†å¸–å­**å¼‚æ­¥**æäº¤åˆ°ESæœåŠ¡å™¨
    å¢åŠ è¯„è®ºæ—¶ï¼Œå°†å¸–å­**å¼‚æ­¥**æäº¤åˆ°ESæœåŠ¡å™¨
    åœ¨æ¶ˆè´¹ç»„ä»¶å¢åŠ æ–¹æ³•ï¼Œæ¶ˆè´¹å¸–å­å‘å¸ƒäº‹ä»¶
- æ˜¾ç¤ºç»“æœ
    åœ¨æ§åˆ¶å™¨å¤„ç†æœç´¢è¯·æ±‚ï¼Œåœ¨HTMLä¸Šæ˜¾ç¤ºç»“æœ

å…ˆè§£å†³é—®é¢˜ï¼šåœ¨discussPost.xmlä¸­çš„sqlè¯­å¥ï¼š

```xml
<insert id = "insertDiscussPost" parameterType="DiscussPost"><!--è¿™é‡Œæ²¡æœ‰å£°æ˜ä¸»é”®æ˜¯ä»€ä¹ˆ-->
	<!--mybaitsä¸ä¼šæŠŠç”Ÿæˆçš„ç»„ä»¶å­˜åˆ°å®ä½“ç±»ä¸­-->
</insert>
<!--å› æ­¤æ·»åŠ ï¼š-->
<insert id = "insertDiscussPost" parameterType="DiscussPost" keyProperty="id">
```

å¤„ç†ä¸šåŠ¡å±‚ï¼šæ–°å»ºelsasticSearchService

```java
@Service
public class ElasticSearchService{
    @Autowired
    private DiscussPostRepository discussRepository;
     @Autowired
    private ElasticsearchTemplate elasticTempate;//æƒ³è¦é«˜äº®æ˜¾ç¤ºå°±éœ€è¦
    
    //æ–¹æ³•ï¼šå‘ESæœåŠ¡å™¨æäº¤æ–°äº§ç”Ÿçš„å¸–å­
    public void saveDiscussPost(DiscussPost post){
        discussRepository.save(post);
    }
    //åˆ é™¤
    public void deleteDiscussPost(int id){
        discussRepository.deleteById(id);
    }
    //æœç´¢:è¿”å›springæä¾›çš„pageç±»å‹
    //å‚æ•°ï¼škeyword å…³é”®å­—ï¼Œ currentå½“å‰é¡µ  limitæ¯é¡µå¤šå°‘æ•°æ®
    public Page<DiscussPost> searchDiscussPost(String keyWord,int current,int limit){
        //æ‹·è´æµ‹è¯•ç±»ä¸­æ–¹æ³•,ä¿®æ”¹
        SearchQuery searchQuery = new NativeSearchQueryBuilder().withQuery(QueryBuilders.multiMatchQuery(keyword,"title","content"))
            .withSort(SortBuilders.fieldSort("type").order(SortOrder.DESC))
            .withSort(SortBuilders.fieldSort("score").order(SortOrder.DESC))
             .withSort(SortBuilders.fieldSort("creatTime").order(SortOrder.DESC))
            .withPageable(PageRequest.of(current,limit))
            .withHighlightFields(
        		new HighlightBuilder.Fields("title").preTags("<em>").postTags("</em>"),
            	new HighlightBuilder.Fields("content").preTags("<em>").postTags("</em>"),
        ).build();
        
        return elasticTemplate.queryForPage(searchQuery,DiscussPost.class,new SearchResultMapper(){
            @Override
            public <T> AggregatedPage<T> mapResults(SearchResponse searchResponse,Class<T> aClass,Pageable pageable){
                //å…ˆé€šè¿‡responseå–åˆ°è¿™æ¬¡æœç´¢å¾—åˆ°çš„æ•°æ®
                SearchHits hits = response.getHits();
                if(hits.getTotalHits()<=0) return null;
                //æœ€ç»ˆéœ€è¦å°†æ•°æ®å°è£…åˆ°é›†åˆé‡Œè¿”å›
                List<DiscussPost> list = new ArrayList<>();
                for(SearchHit hit:hits){
                    DiscussPost post = new DiscussPost();
                    //ç”±äºæ˜¯Jsonæ ¼å¼çš„ï¼Œéœ€è¦toString
                    String id = hit.getSourceAsMap().get("id").toString();
                    post.setId(Integer.valueOf(id));
                    String userId = hit.getSourceAsMap().get("userId").toString();
                    post.setUserId(Integer.valueOf(userId));
			//ç”±äºæœ‰å¯èƒ½åŒ¹é…çš„å­—æ®µåªåœ¨titleæˆ–contentä¸­ï¼Œæ‰€ä»¥å…ˆå°†åŸå§‹titleï¼Œcontentå†™å…¥é˜²æ­¢ç©º
                    //åŸå§‹titleï¼Œéé«˜äº®æ˜¾ç¤ºçš„
                    String title = hit.getSourceAsMap().get("title").toString();
                    post.setTitle(title);
                    String content = hit.getSourceAsMap().get("content").toString();
                    post.setContent(content);
                    String status = hit.getSourceAsMap().get("status").toString();
                    post.setStatus(Integer.valueOf(status));
                    String createTime = hit.getSourceAsMap().get("userId").toString();
                    post.setCreateTime(new Date(Long.valueOf(createTime)));//ESåœ¨å­˜æ—¥æœŸæ—¶è½¬æˆlong
                    String commentCount = hit.getSourceAsMap().get("commentCount").toString();
                    post.setCommentCount(Integer.valueOf(commentCount));
                    //è·å–é«˜äº®å†…å®¹
                    HeightlightField titleField = hit.getHighlightFields().get("title");
                    if(titleField!=null){
                        //getFregments è¿”å›çš„æ˜¯æ•°ç»„ï¼Œå› ä¸ºä¸€æ®µå†…å®¹ä¸­å¯èƒ½å‡ºç°å¤šæ¬¡åŒ¹é…ä¸²
                        post.setTitle(titleField.getFragments()[0].toString();
                    }
                    HeightlightField contentField = hit.getHighlightFields().get("content");
                    if(contentField!=null){
                        //getFregments è¿”å›çš„æ˜¯æ•°ç»„ï¼Œå› ä¸ºä¸€æ®µå†…å®¹ä¸­å¯èƒ½å‡ºç°å¤šæ¬¡åŒ¹é…ä¸²
                        post.setContent(contentField.getFragments()[0].toString();
                    }
                    list.add(post);
                    //è¿”å›ç±»å‹æ˜¯ AggregatedPage<T> æ¥å£ï¼Œéœ€è¦æ„é€ ä¸€ä¸ªå®ç°ç±»
                }
                                        //éœ€è¦å‚æ•°ï¼šå…·ä½“æŸ¥çœ‹åº•å±‚å®ç°
                return new AggregatedPageImpl<>(list,pageable,hits.getTtotalHits(),response.getAggregations(),
                                               response.getScrollId(),hits.getMaxScore());
            }
        });
    }
    
}
```

#### å‘å¸ƒäº‹ä»¶

è¡¨ç°å±‚ï¼šé‡‡ç”¨äº‹ä»¶ã€å¼‚æ­¥ã€‘æ–¹å¼æ¥åŒæ­¥æ•°æ®

**å‘å¸ƒå¸–å­**ï¼šæ‰¾åˆ°DiscussPostController

```java
//å‘å¸ƒå¸–å­å·²æœ‰çš„æ–¹æ³•
public String addDiscussPost(String title,String content){
    User user = hostHolder.getUser();
    if(User==null){
        return CommunityUtil.geetJSONString(403,"ä½ è¿˜æ²¡æœ‰ç™»å…¥å“¦ï¼");
    }
    DiscussPost post = new DiscussPost();
    post.setUserId(user.getId());
    post.setTitle(title);
    post.setContent(content);
    post.setCreateTime(new Date());
    discussPostService.addDiscussPost(post);
    //æ–°å¢ä½ç½®ï¼šè§¦å‘å‘å¸–äº‹ä»¶
    Event event = new Event().setTopic("publish").setUserId(user.getId()).setEntityType(POST/*å¸¸é‡é‡Œè®¾ç½®*/)
        .setEntityId(post.getId());
    //åœ¨å‰é¢æ³¨å…¥ EventProducer eventProducer
    eventProducer.fireEvent(event);
    
    return CommunityUtil.getJSONStrign(0,"å‘å¸ƒæˆåŠŸï¼");
}
```

**å‘å¸ƒè¯„è®º**ï¼šCommentController

```java
//åŠ åˆ°æ–¹æ³•é‡Œï¼Œè¯„è®ºå’Œå¸–å­å¤„ç†ä¸åŒ
```

#### æ¶ˆè´¹äº‹ä»¶

EventConsumer

```java
//æ–°å¢ä¸»é¢˜å’Œæ–¹æ³•

//æ¶ˆè´¹å‘å¸–äº‹ä»¶
@KafkaListener(topics={TOPIC_PUBLISH})//å¸¸é‡æ¥å£é‡Œçš„"publish"
public void handlePublishMessage(ConsumerRecord record){
    if(record==null || record.value()==null){
        logger.error("æ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºï¼");return ;
    }
    Event event = JSONObject.parseObject(record.value().toString(), Event.class);
    if(event==null){
        logger.error("æ¶ˆæ¯æ ¼å¼é”™è¯¯");return ;
    }
    //ä»äº‹ä»¶æ¶ˆæ¯é‡Œå¾—åˆ°å¸–å­idï¼ŒæŸ¥åˆ°å¸–å­ï¼Œå­˜åˆ°ESæœåŠ¡å™¨ä¸­
    //æ³¨å…¥DiscussPostService, ElasticsearchService
    DiscussPost post = discussPostService.findDiscussPostById(event.getEntityId());
    elasticsearchService.saveDiscussPsot(post); 
}
```

#### å±•ç°

æ–°å¢searchControllerç±»

```java
//æ³¨å…¥ ElasticsearchService , UserService, LikeService
//æ–¹æ³•å‚æ•°ï¼š å…³é”®å­—ï¼Œåˆ†é¡µï¼Œè§†å›¾æ¨¡å‹
//ç”±äºé‡‡ç”¨GETæ–¹æ³•ï¼Œä¼ å…¥å…³é”®å­—å°±æ²¡æœ‰è¯·æ±‚ä½“æ¥ä¼ ï¼Œé‡‡ç”¨urlä¼ å…¥
// /search?keyword=xxx
@RequestMapping(path="\search", method = GET)
public String search(String keyword, Page page, Model model){
    //æœç´¢å¸–å­,ä¼ å…¥çš„pageä»1å¼€å§‹ï¼Œè€Œæ–¹æ³•ä»0å¼€å§‹
    //ç”±äºæœç´¢å¯¹è±¡å’Œè‡ªå®šä¹‰çš„Pageç±»å†²çªäº†ï¼Œæ‰€ä»¥å¸¦ä¸Šå…¨ç±»å
    org.springframework.data.domain.Page<DiscussPost> searchResult = 
        elasticsearchService.searchDiscussPost(keyword, page.getCurrent()-1, page.getLimit());
    //èšåˆæ•°æ®ï¼šè¿˜åŒ…å«ç”¨æˆ·ä¿¡æ¯
    List<Map<String,Object>> discussPosts = new ArrayList<>();
    if(searchResult !=null){
        for(DiscussPost post : searchResult){
            Map<String,Object> map = new HashMap<>();
            map.put("post",post);
            map.put("user",userService.findUserById(post.getUserId()));
            map.put("likeCount",LikeService.findEntityLikeCount(ENTITY_TYPE_POST,post.getId()));
            discussPost.add(map);
        }
    }
    model.addAttribute("discussPost",discussPost);
    model.addAttribute("keyword",keyword);
    //åˆ†é¡µä¿¡æ¯
    page.setPath("/search?keyword="+keyword);
    //å¤šå°‘æ•°æ®ï¼Œä¾¿äºè®¡ç®—æ€»é¡µæ•°
    page.setRow(searchResult==null?0:(int)searchResult.getTotalElements());
    return "/site/search";
}
```

HTML

åœ¨index.htmlçš„headerï¼Œæ‰€æœ‰é¡µé¢çš„éƒ½å¤ç”¨

![image-20221125183915654](Resources/image-20221125183915654.png)

ç”±äºæ˜¯ä¸ªinputæ–‡æœ¬æ¡†ï¼Œå…¶å†…å®¹éœ€è¦æäº¤åˆ°åå°ï¼Œæ·»åŠ  name å±æ€§  `name="keyword"`

æˆ‘ä»¬åœ¨æœç´¢åè·³è½¬åˆ°é¡µé¢ï¼Œè¯¥é¡µé¢çš„æœç´¢æ¡†å¾—ä¿æŒ<u>åŸè¾“å…¥å…³é”®å­—</u>  `th:value="${keyword}"`

![image-20221125184351027](Resources/image-20221125184351027.png)

å¤„ç† search.html





### 7.1 SpringSecurityğŸ§‡

<img src="Resources/image-20221125185009943.png" alt="image-20221125185009943" style="zoom:67%;" />

 

<img src="Resources/image-20221125190054872.png" alt="image-20221125190054872" style="zoom:67%;" />



Filterå’ŒDispatcherServletéƒ½æ˜¯ç¬¦åˆJavaEEè§„èŒƒçš„ã€‚Filterå¹¶ä¸åœ¨MVCä¸­

åœ¨mavenä¸­å¼•å…¥spring securityåï¼Œå°†è‡ªåŠ¨æ¥ç®¡ç³»ç»Ÿï¼Œå¹¶ç”Ÿæˆåˆå§‹ç™»å…¥è´¦å·å’Œå¯†ç 

> è´¦å·ï¼šuser
>
> å¯†ç ï¼š//åœ¨æ§åˆ¶å°ä¸­ç”Ÿæˆ

è¿›ä¸€æ­¥å¤„ç†ï¼šç”¨æˆ·ç®¡ç†ï¼š

å¯¹Userå®ä½“ç±»å®ç°æ¥å£ <font color="yellow">UserDetails</font>ï¼Œé‡å†™ä»¥ä¸‹æ–¹æ³•

<img src="Resources/image-20221126092347986.png" alt="image-20221126092347986" style="zoom:67%;" />

è·å–åˆ°userå¯¹è±¡åï¼šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•è·å–å…¶è®¤è¯ï¼Œå¯ä»¥å¾—çŸ¥æ˜¯ç®¡ç†å‘˜è¿˜æ˜¯æ™®é€šç”¨æˆ·

<img src="Resources/image-20221126092912140.png" alt="image-20221126092912140" style="zoom:80%;" />



**Serviceå±‚**ï¼šUserService æ–°å®ç°æ¥å£ï¼š<font color="yellow">UserDetailsService</font>

é‡å†™æ–¹æ³•ï¼šæ ¹æ®ç”¨æˆ·åæŸ¥ç”¨æˆ·

![image-20221126093238902](Resources/image-20221126093238902.png)

æ¥ç€å®ç°securityå¯¹ç³»ç»Ÿçš„æŒæ§ï¼šåŸºäºFilterï¼Œä¸éœ€è¦æ”¹å†™å¤§é‡çš„ç±»ï¼Œè€Œæ–°å¢securotyé…ç½®ç±»

```java
//Config åŒ…ä¸‹
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter{
    @Autowired
    private UserService userService;
    //é‡å†™ä¸‰ä¸ªæ–¹æ³• :Configure
    @Override
    public void configure(WebSecurity web) throws Exception{
        web.ignoring().antMatchers("/resources/**");//å¿½ç•¥é™æ€èµ„æºçš„è®¿é—®
    }
    /*
    	ä¸€äº›ç»„ä»¶ï¼š
    	AuthenticationManager:è®¤è¯æ ¸å¿ƒæ¥å£
    	AuthenticationManagerBuilder: æ„å»ºAuthenticationManagerçš„å·¥å…·ç±»
    	ProviderManager:  AuthenticationManageræ¥å£çš„é»˜è®¤å®ç°ç±»
		AuthenticationProvider:  ProviderManageræŒæœ‰ä¸€ç»„AuthenticationProviderï¼Œæ¯ä¸ªAuthenticationProviderè´Ÿè´£ä¸€ç§è®¤è¯
			è¿™æ ·ProviderManagerå°±èƒ½å…¼å®¹å¤šç§è®¤è¯ï¼Œè´¦å·å¯†ç ï¼Œå¾®ä¿¡ç­‰ç­‰ã€‚ã€‚
			å§”æ‰˜æ¨¡å¼
    */
    @Override
    public void configure(AuthenticationManagerBuilder auth) throws Exception{
        //è®¤è¯+æˆæƒå¤„ç†
       // auth.userDetailsService(userService).passwordEncoder(new pbkd2PasswirdEncoder("123456"));  //åŠ å¯†å·¥å…·å’Œsalt
        //ä¸Šæ–¹æ³•å’Œä¹‹å‰çš„ä¸åŒ¹é…ï¼Œå› ä¸ºæ¯ä¸ªç”¨æˆ·éƒ½å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„salt
        //è‡ªå®šä¹‰è®¤è¯è§„åˆ™
        //..æˆªå›¾
    }
    
    // Authentication: ç”¨äºå°è£…è®¤è¯ä¿¡æ¯çš„æ¥å£ï¼Œä¸åŒå®ç°ç±»ä»£è¡¨ä¸åŒè®¤è¯æ–¹å¼
}
```

![image-20221126094510699](Resources/image-20221126094510699.png)

![image-20221126160119084](Resources/image-20221126160119084.png)









### 7.3 æƒé™æ§åˆ¶ğŸ§‡

<img src="Resources/image-20221128170254125.png" alt="image-20221128170254125" style="zoom:67%;" />











### 7.5 ç½®é¡¶åŠ ç²¾åˆ é™¤

<img src="Resources/image-20221128172119655.png" alt="image-20221128172119655" style="zoom:67%;" />



 











### 7.8Redisé«˜çº§æ•°æ®ç±»å‹



### 7.10 ç½‘ç«™æ•°æ®ç»Ÿè®¡



### 7.13 ä»»åŠ¡æ‰§è¡Œå’Œè°ƒåº¦



### 7.16 çƒ­å¸–æ’è¡Œ



### 7.19 ç”Ÿæˆé•¿å›¾



### 7.23 å°†æ–‡ä»¶ä¸Šä¼ è‡³äº‘æœåŠ¡å™¨



### 7.27 ä¼˜åŒ–ç½‘ç«™æ€§èƒ½



### 8.1 å•å…ƒæµ‹è¯•ğŸ”°

<img src="Resources/image-20221201165008972.png" alt="image-20221201165008972" style="zoom:67%;" />



ç‹¬ç«‹æ€§ï¼šå¤šä¸ªæµ‹è¯•çš„æ–¹æ³•ä¸ä¾èµ–ï¼Œèƒ½éšæ—¶æ‰§è¡Œã€‚å› æ­¤æœ‰äº†ä»¥ä¸‹æ­¥éª¤ï¼š

1. åˆå§‹åŒ–æ•°æ®ï¼šä¸ºæœ¬æ¬¡æµ‹è¯•å•ç‹¬çš„æ•°æ®ï¼Œæœ€ç»ˆæ¸…é™¤æ•°æ®ï¼Œå› æ­¤è¯¥æµ‹è¯•æ–¹æ³•æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¾èµ–äºå…¶ä»–æ–¹æ³•çš„æ•°æ®
2. SpringBootä¸ºäº†é¿å…å†™é‡å¤çš„ä»£ç ï¼Œä¿è¯åˆå§‹åŒ–çš„æ•°æ®å¯é‡å¤ä½¿ç”¨ï¼›æŒ‰æ­¥éª¤è¿›è¡Œ

```java
@BeforeClassï¼šåœ¨æ­¤ç±»åˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œçš„æ–¹æ³•
    @AfterClassï¼šåœ¨ç±»é”€æ¯åæ‰§è¡Œ
    @Beforeï¼šåœ¨è°ƒç”¨ä»»ä½•æµ‹è¯•æ–¹æ³•ä¹‹æ°”ï¼Œè¯¥æ–¹æ³•æ‰§è¡Œä¸€æ¬¡
    @Afterï¼š
```

```java
@SpringBootTest
@ContextConfiguration(classes = CommunityApplication.class)
public class SpringBootTests {
    //éªŒè¯æµ‹è¯•ç±»çš„ç›¸å…³æ³¨è§£ @BeforeClass
     //ç”±äºæ˜¯åœ¨ç±»åˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œçš„ï¼Œå› æ­¤æ˜¯é™æ€æ–¹æ³•
    @BeforeClass
    public static void beforeClass(){
        System.out.println("beforeClass");
    }

    @AfterClass
    public static void afterClass(){
        System.out.println("afterClass");
    }

    @Before
    public void before(){
        System.out.println("before");
    }

    @After
    public void after(){
        System.out.println("after");
    }

    @Test
    public void test1(){
        System.out.println("test1");
    }
}

```

```
beforeClass
before
test1
after
afterClass

Process finished with exit code 0

```

è¿™æ ·åœ¨beforeä¸­å®šä¹‰æ•°æ®ï¼ˆæ³¨å…¥mapperæ’å…¥æ•°æ®ï¼‰

ç„¶ååœ¨è¿™ä¸ªæµ‹è¯•ç±»ä¸­å†™å¤šä¸ªtestæ–¹æ³•ï¼Œç»Ÿä¸€è¿è¡Œè¯¥ç±»ï¼ŒæˆåŠŸå°±æ ‡ç»¿ã€‚å¦‚ä½•éªŒè¯æˆåŠŸï¼Ÿé‡‡ç”¨æ–­è¨€

```java
Assert.assertNotNull(post);
Assert.assertEquals(data.getTitle(),post.getTitle());//åˆ¤æ–­ä¸¤æ•°æ®æ˜¯å¦ç›¸ç­‰
```







### 8.2 é¡¹ç›®ç›‘æ§

<img src="Resources/image-20221201170935802.png" alt="image-20221201170935802" style="zoom:80%;" />













### 8.3 é¡¹ç›®éƒ¨ç½²

<img src="Resources/image-20221204171404373.png" alt="image-20221204171404373" style="zoom:80%;" />

æ­£å‘ä»£ç†ï¼šä»£ç†æµè§ˆå™¨   åå‘ä»£ç†ï¼šä»£ç†æœåŠ¡å™¨

puttyï¼šç”¨äºè®¿é—®æœåŠ¡å™¨











### 8.4 é¡¹ç›®æ€»ç»“



# 10â˜£ 



### 1.2 æ­å»ºå¼€å‘ç¯å¢ƒğŸ”°

springboot ï¼šèµ·æ­¥ä¾èµ–ï¼Œç«¯ç‚¹æ§åˆ¶ï¼Œ

### 1.3 springğŸ”°

æœ¬å®éªŒç”¨åˆ° **spring AMQP** ä½œæ¶ˆæ¯é˜Ÿåˆ—

å½“å£°æ˜äº†ä¸¤ä¸ªBeanä¸”éƒ½æ˜¯åŒä¸€çˆ¶ç±»çš„å­ç±»æ—¶ï¼Œè¿™æ—¶getBeanè·å–çˆ¶ç±»å®ç°ç±»å°±ä¼šæŠ¥é”™`applicationContext.getBean(father.class)`ï¼š
åœ¨ä¼˜å…ˆé€‰æ‹©çš„Beanä¸ŠåŠ ä¸Šæ³¨è§£  `@Primary`

ä½†æ˜¯å¦‚æœåè¦è·å–ä¹‹å‰çš„Beanï¼Œæˆ‘ä»¬åœ¨æ³¨è§£`@Repository` ä¸ŠåŠ æ‹¬å·å†™ä¸Šåå­— `@Repository("son2")`
ç„¶åé€šè¿‡åå­—è·å–`applicationContext.getBean("son2",father.class)`

Springå®¹å™¨è¿˜èƒ½ç®¡ç†beançš„åˆå§‹åŒ–å’Œé”€æ¯

`@PostConstruct` è¡¨ç¤ºåœ¨åˆå§‹åŒ–ä¹‹åè¿è¡Œæ–¹æ³•

`@PreDestroy` åœ¨é”€æ¯åè‡ªåŠ¨è¿è¡Œæ–¹æ³•

å¦‚æœä¸å¸Œæœ›Beanæ˜¯å•ä¾‹çš„ï¼ŒåŠ ä¸Šæ³¨è§£ `@Scope("prototype")` ï¼Œæ¯æ¬¡è®¿é—®beanéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„

### 1.14 springMVC

### 1.30 å¼€å‘ç¤¾åŒºé¦–é¡µğŸ”°

å°†æ¯ä¸€ä¸ªåŠŸèƒ½ä½œä¸ºä¸€æ¬¡è¯·æ±‚ï¼š

è¯·æ±‚æµç¨‹ï¼šController-> Service-> Dao->DB

ç¤¾åŒºé¦–é¡µï¼šæŸ¥è¯¢å¸–å­åˆ—è¡¨

é¦–å…ˆå¼€å‘DAOï¼Œå…ˆæŠŠå®ä½“ç±»åšå¥½

```java
//DisscussPost
private int id;
    private int userId;
    private String title;
    private String content;
    private int type;
    private int status;
    private Date createTime;
    private int commentCount;
    private double score;//ç”Ÿæˆgettersetter
```

```java
//DiscussPostMapper
public interface DiscussPostMapper {

    /**
     *
     * @param userId    åœ¨é¦–é¡µæŸ¥è¯¢ä¸éœ€è¦idï¼Œè€Œä»¥åçš„ä¸ªäººä¸»é¡µæŸ¥è¯¢éœ€è¦idï¼Œå› æ­¤å¼€å‘æˆåŠ¨æ€sql
     * @param offset    èµ·å§‹è¡Œè¡Œå·
     * @param limit     æ¯é¡µæœ€å¤šæ˜¾ç¤ºçš„æ•°æ®æ¡æ•°
     * @return
     */
    List<DiscussPost> selectDiscussPosts(int userId,int offset, int limit);

    int selectDiscussPostRows(@Param("userId") int userId);//å¦‚æœéœ€è¦åŠ¨æ€æ‹¼æ¡ä»¶ï¼Œä¸”æ–¹æ³•æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ¡ä»¶ï¼Œåˆ™è¿™ä¸ªå‚æ•°å‰å¿…é¡»èµ·åˆ«å

}
```

```xml
    <sql id="selectFields">
        id,user_id,title,content,`type`,status,create_time,comment_count,score
    </sql>

    <!--List<DiscussPost> selectDiscussPosts(int userId,int offset, int limit);-->
    <select id="selectDiscussPosts" resultType="DiscussPost">
        select <include refid="selectFields"></include>
        from discuss_post
        where status !=2 <!--2 è¡¨ç¤ºæ‹‰é»‘çš„-->
        <if test="userId!=0">
            and user_id = #{userId}
        </if>
        order by type desc, create_time desc
        limit #{offset},#{limit}
    </select>

    <!--int selectDiscussPostRows(@Param("userId") int userId);-->
    <select id="selectDiscussPostRows" resultType="int">
        select count(id)
        from discuss_post
        where status !=2
        <if test="userId!=0">
            and user_id = #{userId}
        </if>
    </select>
```

å†™å®Œåæµ‹è¯•ä¸€ä¸‹

```java
	@Autowired
    private DiscussPostMapper discussPostMapper;
    @Test
    public void testSelectPosts(){
        List<DiscussPost> list  = discussPostMapper.selectDiscussPosts(149,0,10);
        for(DiscussPost post: list){
            System.out.println(post);
        }

        int rows = discussPostMapper.selectDiscussPostRows(149);
        System.out.println(rows);
    }
```

service

```java
 @Autowired
    private DiscussPostMapper discussPostMapper;

    public List<DiscussPost> findDiscussPosts(int userId, int offset, int limit){
        return discussPostMapper.selectDiscussPosts(userId,offset,limit);
    }

    public int findDiscussPostRows(int userId){
        return discussPostMapper.selectDiscussPostRows(userId);
    }
//æˆ‘ä»¬æŸ¥è¯¢åˆ°çš„DiscussPostç»“æœçš„userIæ˜¯å¤–é”®ï¼Œåœ¨é¡µé¢ä¸Šéœ€è¦æ˜¾ç¤ºç”¨æˆ·åç§°
//æ–¹æ³•ä¸€ï¼š åŒæ—¶åšå…³è”æŸ¥è¯¢ï¼ŒæŸ¥è¯¢username
//æ–¹æ³•äºŒï¼š é’ˆå¯¹æ¯ä¸€ä¸ªDiscussPostå•ç‹¬æŸ¥userï¼Œç„¶åç»„åˆåœ¨ä¸€èµ·---å½“ä½¿ç”¨Redisæ›´æ–¹ä¾¿
```

æ–°å»ºUserService

```java
 public User findUserById(int id){
        return userMapper.selectById(id);
    }
```

è§†å›¾å±‚ï¼šè®¿é—®é¦–é¡µ

```java
@ReqeustMapping(path="/index",method = GET)
public String getIndexPage(Model model){
	//æˆ‘ä»¬è¦è·å–å‰åæ¡å¸–å­
   List<DiscussPost> list = disscussPostService.finfDiscussPost(0,0,10);
    //æˆ‘ä»¬è¿˜è¦æŸ¥åˆ°userIdï¼Œå› æ­¤å°†ä¸¤ä¸ªæ•°æ®ç»„è£…åœ¨mapä¸­
    List<Map<String,Object>> disscussPost = new ArrayList<>();
    if(list!=null){
       	for(DiscussPost post:list){
            Map<String,Object> map = new HashMap<>();
            map.put("post",post);
            //ç„¶åæ ¹æ®Userçš„æ–¹æ³•æŸ¥è¯¢ç”¨æˆ·
            User user = userService.findUserById(post.getUserId());
            map.put("user",user);
            discussPost.add(map);
        }
    }
    //ä¹‹åå°†è¿™ä¸ªListåŠ è¿›Modelä¸­
    model.addAttribute("discussPosts",discussPosts);
    return "/index"
}
```

ç„¶åä¿®æ”¹index.html

```html
<!-- å¸–å­åˆ—è¡¨ -->
				<ul class="list-unstyled">
					<li class="media pb-3 pt-3 mb-3 border-bottom" th:each="map:${discussPosts}">
						<a href="site/profile.html">
							<img th:src="${map.user.headerUrl}" class="mr-4 rounded-circle" alt="ç”¨æˆ·å¤´åƒ" style="width:50px;height:50px;">
						</a>
						<div class="media-body">
							<h6 class="mt-0 mb-3">
								<a href="#" th:utext="${map.post.title}">å¤‡æˆ˜æ˜¥æ‹›ï¼Œé¢è¯•åˆ·é¢˜è·Ÿä»–å¤ä¹ ï¼Œä¸€ä¸ªæœˆå…¨æå®šï¼</a>
								<span class="badge badge-secondary bg-primary" th:if="${map.post.type==1}">ç½®é¡¶</span>
								<span class="badge badge-secondary bg-danger" th:if="${map.post.status==1}">ç²¾å</span>
							</h6>
							<div class="text-muted font-size-12">
								<u class="mr-3" th:utext="${map.user.userName}">å¯’æ±Ÿé›ª</u> å‘å¸ƒäº <b th:text="${#dates.format(map.post.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b>
								<ul class="d-inline float-right">
									<li class="d-inline ml-2">èµ 11</li>
									<li class="d-inline ml-2">|</li>
									<li class="d-inline ml-2">å›å¸– 7</li>
								</ul>
							</div>
						</div>						
					</li>
				</ul>
```

```
è¿™é‡Œçš„ ${map.user.headerUrl} ä¼šæ ‡çº¢ï¼ˆä½†å¯è¿è¡Œï¼‰
å…¶å®æ˜¯è°ƒç”¨  map.get("User").getHeaderUrl()
```

æ·»åŠ pageå®ä½“ï¼Œè¦ä¿®æ”¹éƒ¨åˆ†gettersetterï¼Œä½œæœ‰æ•ˆåˆ¤æ–­ï¼Œå¹¶æ·»åŠ æ–¹æ³•è®¡ç®—é¡µé¢æ€»æ•°ï¼Œèµ·å§‹ç¼–å·å’Œå°¾ç«¯ç¼–å·

```java
public class Page {
    private int current = 1;//å½“å‰é¡µç 
    private int limit =10;//æ˜¾ç¤ºä¸Šé™
    private int rows;//æ•°æ®æ€»æ•°ï¼ˆç”¨äºè®¡ç®—æ€»é¡µæ•°ï¼‰
    private String path;//æŸ¥è¯¢è·¯å¾„
    //è·å–å½“å‰é¡µçš„èµ·å§‹è¡Œ
    public int getOffset(){
        return (current-1)*limit;
    }
    //è·å–æ€»çš„å¶æ•°
    public int getTotal(){
        if(rows%limit==0){
           return rows/limit;
        }else{
            return rows/limit+1;
        }
    }
    //ä»å“ªå¼€å§‹ï¼Œä»å“ªç»“æŸ
    public int getFrom(){
        int from = current-2;
        return Math.max(from, 1);
    }
    public int getTo(){
        int to = current+2;
        int total = getTotal();
        return Math.min(to, total);
    }
    public int getCurrent() {
        return current;
    }
    public void setCurrent(int current) {
        if(current>=1){
            this.current = current;
        }
    }
    public int getLimit() {
        return limit;
    }
    public void setLimit(int limit) {
        if(limit>=1&&limit<=100){
            this.limit = limit;
        }

    }
    public int getRows() {
        return rows;
    }
    public void setRows(int rows) {
        if(rows>=0){
            this.rows = rows;
        }
    }
    public String getPath() {
        return path;
    }
    public void setPath(String path) {
        this.path = path;
    }
}
```

è¿™æ ·ï¼Œè¦ä¿®æ”¹Controllerï¼Œå°†Pageä¼ å…¥

```java
@RequestMapping(path="/index",method = RequestMethod.GET)
    public String getIndexPage(Model model, Page page){
        //æ–¹æ³•è°ƒç”¨å‰ï¼ŒspringMVCä¼šè‡ªåŠ¨å®ä¾‹åŒ–modelå’Œpageï¼Œä¸”å°†pageæ³¨å…¥ç»™model
        page.setRows(discussPostService.findDiscussPostRows(0));
        page.setPath("/index");

        List<DiscussPost> list = discussPostService.findDiscussPosts(0, page.getOffset(), page.getLimit());
        //ç”±äºæŸ¥åˆ°çš„ç”¨æˆ·idï¼Œä¸æ˜¯ç”¨æˆ·åï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠé›†åˆéå†ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ªDiscussPostï¼Œæ ¹æ®userIdæŸ¥è¯¢userï¼Œå°†ç»“æœç»„åˆèµ·æ¥
        List<Map<String,Object>> discussPosts = new ArrayList<>();
        if(list!=null){
            for(DiscussPost post:list){
                Map<String,Object> map = new HashMap<>();
                map.put("post",post);
                User user = userService.findUserById(post.getUserId());
                map.put("user",user);
                discussPosts.add(map);
            }
        }
        model.addAttribute("discussPosts",discussPosts);
        model.addAttribute("page",page);//å…¶å®å¯ä»¥ä¸ç”¨åŠ 
        return "/index";
    }
```

ä¿®æ”¹index.htmlçš„åˆ†é¡µéƒ¨åˆ†

```html
<!-- åˆ†é¡µ -->
				<nav class="mt-5" th:if="${page.rows>0}">
					<ul class="pagination justify-content-center">
						<li class="page-item">
							<a class="page-link" th:href="@{${page.path}(current=1)}">é¦–é¡µ</a></li>
						<li th:class="|page-item ${page.current==1?'disabled':''}|">
							<a class="page-link" th:href="@{${page.path}(current=${page.current-1})}">ä¸Šä¸€é¡µ</a>
						</li>
						<li th:class="|page-item ${i==page.current?'active':''}|" th:each="i:${#numbers.sequence(page.from,page.to)}">
							<a class="page-link" th:href="${i}" th:text="${i}">1</a>
						</li>
						<li th:class="|page-item ${page.current==page.total?'disabled':''}|">
							<a class="page-link" th:href="@{${page.path}(current=${page.current+1})}">ä¸‹ä¸€é¡µ</a>
						</li>
						<li class="page-item">
							<a class="page-link" th:href="@{${page.path}(current=${page.total})}">æœ«é¡µ</a>
						</li>
					</ul>
				</nav>
```

### 1.38  é¡¹ç›®è°ƒè¯•æŠ€å·§ğŸ”°

**å“åº”çŠ¶æ€ç çš„å«ä¹‰**

> 200 OK
>
> 201 Created   è¯·æ±‚æˆåŠŸï¼Œå¹¶å› æ­¤åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„èµ„æº
>
> 202 Accepted è¯·æ±‚å·²æ”¶åˆ°ï¼Œä½†è¿˜æœªå“åº”
>
> 302 Found  è¯·æ±‚çš„èµ„æºç°åœ¨ä»ä¸åŒçš„URIå“åº”ï¼Œè¿™æ˜¯ä¸´æ—¶çš„ 
>
> 400 Bad Request è¯­ä¹‰æœ‰è¯¯ï¼Œæ— æ³•è¢«æœåŠ¡å™¨ç†è§£
>
> 403 Forbidden
>
> 404 Not Found èµ„æºåœ¨æœåŠ¡å™¨ä¸Šæœªå‘ç°
>
> 500 Internal Server Error æœåŠ¡å™¨é‡åˆ°äº†ä¸çŸ¥å¦‚ä½•å¤„ç†

**è®¾ç½®æ—¥å¿—**

é»˜è®¤æ—¥å¿—å·¥å…·  ï¼š logback

æ¥å£ï¼šLogger

æ–¹æ³•ï¼š

```java
//ä¸åŒçº§åˆ«ï¼š
trace();
debug();
info();
warn();
error();
```

åˆ›å»ºæ—¥å¿—æµ‹è¯•ç±»ï¼š

```java
//æµ‹è¯•ç±»çš„æ³¨è§£
@RunWith(SpringRunner.class)
@SpringBootTest
@ContextConfiguration
public class LoggerTests {
    //æ³¨æ„æ˜¯ slf4j åŒ…ä¸‹çš„
    private static final Logger logger = LoggerFactory.getLogger(LoggerTests.class);
     @Test
    public void testLogger(){
        System.out.println(logger.getName());
        logger.debug("debug-log");
        logger.info("info-log");
        logger.warn("warn-log");
        logger.error("error-log");
    }
}

```

åœ¨é…ç½®ä¸­ï¼š

```properties
# logger
#logging.level.com.nowcoder.community=debug
#logging.file=d:/work/data/nowcoder/community.log
```

ä½†æ˜¯ä¿®æ”¹é…ç½®ä¹Ÿä¸æ–¹ä¾¿ï¼Œå¯ä»¥åœ¨resourcesä¸‹æ·»åŠ logback-spring.xml ï¼Œä¼šè‡ªåŠ¨å¯ç”¨è¯¥é…ç½®



### 1.47 ç‰ˆæœ¬æ§åˆ¶ğŸ”°

```properties
#è´¦å·é…ç½®
git config --list
git config --global user.name "myName"
git config --user..email "xxxxx"
#æœ¬åœ°ä»“åº“
git init
git status -s
git add *
git commit -m '....'
#ç”Ÿæˆå¯†é’¥
ssh-keygen -t rsa -C "é‚®ç®±"

#æ¨é€å·²æœ‰é¡¹ç›®
git remote add origin
git push -u origin master
#å…‹éš†å·²æœ‰é¡¹ç›®
git clone https://git.xxxxxxxxxxxxxxxxxx.git
```



### 2.1å‘é€é‚®ä»¶ğŸ”°

pomä¸­æ·»åŠ  spring-boot-starter-mail ä¾èµ–

é‚®ç®±å‚æ•°é…ç½®

```properties
#MailProperties
spring.mail.host=smtp.sina.com
spring.mail.port=465
spring.mail.username=zhujinliang89@sina.com
spring.mail.password=6656762999867642
spring.mail.protocol=smtps
spring.mail.properties.mail.smtp.ssl.enable=true
```

é‚®ç®±å·¥å…·ç±»

```java
@Component
public class MailClient {
    private static final Logger logger = LoggerFactory.getLogger(MailClient.class);

    @Autowired
    private JavaMailSender mailSender;
    
    @Value("${spring.mail.username}")
    private String from;//æœåŠ¡å™¨ä½œä¸ºå‘é€æ–¹æ˜¯å›ºå®šçš„

    //æ”¶ä»¶äºº + ä¸»é¢˜ + å†…å®¹
    public void sendMail(String to, String subject, String content) {
        try {
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message);
            helper.setFrom(from);
            helper.setTo(to);
            helper.setSubject(subject);
            helper.setText(content, true);
            mailSender.send(helper.getMimeMessage());
        } catch (MessagingException e) {
            logger.error("å‘é€é‚®ä»¶å¤±è´¥" + e.getMessage());
        }
    }
}
```

htmlé‚®ä»¶æ¨¡æ¿

```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>é‚®ä»¶ç¤ºä¾‹</title>
</head>
<body>
    <p>æ¬¢è¿æ‚¨ï¼Œ<span style="color: darkorchid;" th:text="${username}"></span>!</p>
</body>
</html>
```

åœ¨æµ‹è¯•ç±»ä¸­

```java
 @Autowired
    private MailClient mailClient;	//è‡ªå·±å†™çš„bean
    @Autowired
    private TemplateEngine templateEngine;//springbootä¸­å·²ç®¡ç†äº†æ¨¡æ¿å¼•æ“ï¼Œåªéœ€æ³¨å…¥

    @Test
    public void testMail(){
        mailClient.sendMail("574524709@qq.com","test","test mail");
    }

    @Test
    public void testHtmlMail(){
        Context context = new Context();//æ³¨æ„æ˜¯thymeleafåŒ…ä¸‹çš„
        context.setVariable("username","sunday");//å¾…ä¼šä¼ é€’ç»™æ¨¡æ¿
        String content = templateEngine.process("/mail/demo", context);//æŠŠæ¨¡æ¿åœ°å€ï¼Œæ•°æ®
        System.out.println(content);
        mailClient.sendMail("574524709@qq.com",  "HTML",content);
    }
```



### 2.7 å¼€å‘æ³¨å†ŒåŠŸèƒ½ğŸ”°

æ ¹æ®è¯·æ±‚åŠŸèƒ½æ‹†è§£

> ç‚¹å‡»æ³¨å†Œï¼šæ‰“å¼€æ³¨å†Œé¡µé¢
>
> æ³¨å†Œï¼šæäº¤è¡¨å•æ•°æ®ã€æœåŠ¡ç«¯ä½œéªŒè¯ã€æœåŠ¡ç«¯å‘é€é‚®ç®±
>
> æ¿€æ´»ï¼šç‚¹å‡»é‚®ä»¶çš„é“¾æ¥ï¼Œè®¿é—®æœåŠ¡ç«¯çš„é“¾æ¥

ç™»å…¥æ¨¡å—æ–°å»ºControllerï¼š

```java
//æ–°æ–¹æ³•ï¼šè·å–æ³¨å†Œé¡µé¢--> è¿”å›æ¨¡æ¿è·¯å¾„
@RequestMapping(path = "/register",method = RequestMethod.GET)
    public String getRegisterPage(){
        return "/site/register";
    }
```

æäº¤æ³¨å†Œæ•°æ®ï¼š

å…ˆå¯¼ä¸€ä¸ªå·¥å…·åŒ… Comments Lang ç”¨äºå¤„ç†å­—ç¬¦ä¸²

ç»™é¡¹ç›®å†™ä¸ªåŸŸå`community.path.domain=http://localhost:8080`

æ–°å»ºå·¥å…·ç±» CommunityUtil

```java
public class CommunityUtil {
    //ç”Ÿæˆæ¿€æ´»ç ï¼Œæä¾›å­—ç¬¦ä¸²
    public static String generateUUID(){
        return UUID.randomUUID().toString().replaceAll("-","");//ä¸æƒ³è¦æœ‰æ¨ªçº¿
    }
    //MD5åŠ å¯†(åªèƒ½åŠ å¯†ï¼Œä¸èƒ½è§£å¯†)
    public static String md5(String key){
        if(StringUtils.isBlank(key)){//å…ˆç®€å•åˆ¤æ–­ä¸‹ä¸ä¸ºç©ºï¼Œé‡‡ç”¨äº†commons langåŒ…
            return null;
        }else {
            return DigestUtils.md5DigestAsHex(key.getBytes(StandardCharsets.UTF_8));//è¿™æ˜¯springè‡ªå¸¦çš„åŠ å¯†æ–¹æ³•
        }
    }
}
```

UserService

```java
//æ³¨å…¥	
@Autowired
    private UserMapper userMapper;
    @Autowired
    private MailClient mailClient;
    @Autowired
    private TemplateEngine templateEngine;
    //æ³¨å†Œæ—¶å‘é€æ¿€æ´»ç éœ€è¦å¸¦ä¸ŠåŸŸåå’Œé¡¹ç›®åï¼Œå› æ­¤ä»propertiesä¸­æ³¨å…¥
    @Value("${community.path.domain}")
    private String domain;
    @Value("${server.servlet.context-path}")
    private String contextPath;
    @Autowired
    private LoginTicketMapper loginTicketMapper;
```

```java
//æ³¨å†Œä¸šåŠ¡çš„æ–¹æ³•ï¼š
//ä¼ å…¥ User(æ¥è‡ªControllerç”±å‰ç«¯å°è£…çš„)
//è¿”å› Map  :ç”¨äºè¿”å›ä¿¡æ¯ï¼Œè´¦å·ä¸ä¸ºç©ºï¼Œå¯†ç ä¸ä¸ºç©ºç­‰
/**
ä¸šåŠ¡é€»è¾‘ï¼š
1.å‚æ•°åˆ¤æ–­ï¼ˆç©ºå€¼ï¼‰
2.è´¦å·æ˜¯å¦å·²å­˜åœ¨ï¼ˆuserMapper.selectByName()è·å–userï¼‰
3.é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ(userMapper.selectByEmail()è·å–user)
4.æ³¨å†Œç”¨æˆ·ï¼Œå…ˆè¦å¯¹å¯†ç åŠ å¯†
	user.setSalt();éšæœºç”Ÿæˆsalt
	user.setPassword(åŸå¯†ç +saltç„¶åMD5åŠ å¯†)
	ç”Ÿæˆéšæœºå¤´åƒï¼Œuser.setHeaderUrl(String.format("http://images.nowcoder.com/head/%dt.png",new Random().nextInt(1000)));
	è®°å½•åˆ›å»ºäº‹ä»¶user.setCreateTime(new Date());
5.å‘é€æ¿€æ´»é‚®ä»¶
 //ç»™ç”¨æˆ·å‘é‚®ä»¶ï¼Œç”¨äºæ¿€æ´» æ¨¡æ¿ activation.html*/

//é€šè¿‡é…ç½®ä½¿å¾—mybatiså¯¹insertè‡ªåŠ¨ç”Ÿæˆidå¹¶å›å¡«
mybatis.configuration.useGeneratedKeys=true
   ///////////////////////////////////////////
        Context context = new Context();
        context.setVariable("email",user.getEmail());
        //åŠ¨æ€æ‹¼æ¥ç”¨æˆ·èƒ½ç‚¹çš„è·¯å¾„ï¼ˆæ¯ä¸ªç”¨æˆ·çš„æ¿€æ´»é¡µé¢æ˜¯ä¸åŒçš„ï¼‰ :101 æ˜¯ç”¨æˆ·idï¼Œcodeæ˜¯æ¿€æ´»ç 
        //http://localhost:8080/community/activation/101/code
        String url = domain+contextPath+"/activation/"+user.getId()+"/"+user.getActivationCode();
        context.setVariable("url",url);
        //ç”Ÿæˆæ¨¡æ¿å¼•æ“
        String content = templateEngine.process("/mail/activation",context);
        mailClient.sendMail(user.getEmail(), "è´¦å·æ¿€æ´»",content);




```

Controller

å·¥ä½œï¼šé‡‡ç”¨Userå¯¹è±¡æ¥å—	å‰ç«¯ä¼ å…¥çš„è¡¨å•æ•°æ®

è°ƒç”¨serviceæ–¹æ³• è·å–map

æ ¹æ®è¿”å›çš„mapä½œåˆ¤æ–­ï¼Œï¼Œç„¶åå°†æ¶ˆæ¯å°è£…ç»™modelè¿”å›æ¨¡æ¿

ä¿®æ”¹html

```html
<!--ä¿®æ”¹è¡¨å• æäº¤æ–¹æ³•postï¼Œactionè·¯å¾„-->
<form class="mt-5" method="post" th:action="@{/register}"></form>
<!--æ³¨æ„æ·»åŠ nameå±æ€§ï¼Œè¦å’Œå®ä½“ç±»å±æ€§ä¸€æ ·-->
	 <input type="text" th:class="|form-control ${usernameMsg!=null?'is-invalid':''}|" th:value="${user!=null?user.userName:''}"
								   id="username" name="username" placeholder="è¯·è¾“å…¥æ‚¨çš„è´¦å·!" required>
```

é‚®ç®±æ¿€æ´»

```java
//è·¯å¾„å°±æ˜¯å‘ç»™é‚®ç®±çš„é“¾æ¥
@RequestMapping(path = "/activation/{userId}/{code}",method = RequestMethod.GET)
//è®¾è®¡å¸¸é‡æ¥å£ï¼Œæ¿€æ´»æˆåŠŸï¼Œé‡å¤æ¿€æ´»ï¼Œæ¿€æ´»å¤±è´¥
//æ¿€æ´»æ–¹æ³•ï¼šè¿”å›æˆåŠŸæˆ–å¤±è´¥
//å‚æ•°ï¼šuserIdå’Œcode
//é€»è¾‘ï¼šæŸ¥è¯¢ç”¨æˆ·ï¼Œè·å–æ¿€æ´»ç ï¼ŒéªŒè¯æ­£ç¡®
User user = userMapper.selectById();
//é€šè¿‡user.getStatus()è·å–çŠ¶æ€
```



### 2.11 ä¼šè¯ç®¡ç†ğŸ”°

httpæ€§è´¨ï¼šæ— çŠ¶æ€çš„

```java
//æµ‹è¯•ï¼š	
@RequestMapping(path = "/cookie/set",method = RequestMethod.GET)
    @ResponseBody
    public String setCookie(HttpServletResponse httpServletResponse){
        //éœ€è¦ç”¨åˆ°responseå¯¹è±¡ï¼Œåœ¨æ–¹æ³•å‚æ•°ä¼ å…¥
        Cookie cookie = new Cookie("code","123");//æ¯ä¸ªcookieåªèƒ½æœ‰ä¸€å¯¹å­—ç¬¦ä¸²
        //éœ€è¦æŒ‡å®šè·¯å¾„
        cookie.setPath("/community");
        //æµè§ˆå™¨å¾—åˆ°cookieé»˜è®¤å­˜å†…å­˜ä¸­ï¼Œæ‰€ä»¥å…³é—­æµè§ˆå™¨cookieä¼šæ¶ˆå¤±ï¼Œéœ€è¦è®¾ç½®ç”Ÿæ•ˆæ—¶é—´
        cookie.setMaxAge(60*10*60);//ç§’
        httpServletResponse.addCookie(cookie);
        return "set cookie";
```

```java
//æµ‹è¯•è¿”å›ï¼š
//å¦‚æœè¦è·å–å…¨éƒ¨cookieï¼Œå¯ä»¥ä¼ å…¥requestå¯¹è±¡ï¼Œä½†æ˜¯è·å¾—cookieæ•°ç»„ï¼Œéœ€è¦éå†è·å¾—ï¼Œå› æ­¤å¯ä½¿ç”¨æ³¨è§£è·å–æŒ‡å®šcookie
//@CookieValue("")
@RequestMapping(path = "/cookie/get",method = RequestMethod.GET)
    @ResponseBody
    public String getCookie(@CookieValue("code") String code){
        //å°±å¯ä»¥è·å–code ä½¿ç”¨
        return "get cookie";
    }
```

**Sesscion**ï¼šMVCè‡ªåŠ¨åˆ›å»ºï¼Œåªè¦æ³¨å…¥å°±è¡Œ

```java
@RequestMapping(path = "/session/get",method = RequestMethod.GET)
@ResponseBody
public String setSession(HttpSession httpSession){
    httpSession.setAttribute("id",1);
    return "set session";
}
```

<font color=red>åˆ†å¸ƒå¼éƒ¨ç½²</font>ï¼šnginxå®ç°è´Ÿè½½å‡è¡¡

- ç²˜æ€§sessionï¼šåŒä¸€ipçš„è¯·æ±‚å‡åˆ†é…åˆ°æŒ‡å®šä¸€å°æœåŠ¡å™¨ä¸Š
-  åŒæ­¥sessionï¼šæœåŠ¡å™¨å°†sessionåŒæ­¥ç»™æ‰€æœ‰æœåŠ¡å™¨
- å…±äº«sessionï¼šæœ‰ä¸€å°å•ç‹¬çš„æœåŠ¡å™¨ç”¨äºå¤„ç†sessionï¼Œå…¶ä»–æœåŠ¡å™¨ä¸è¯¥æœåŠ¡å™¨
- ä¸»æµï¼šä¸ä½¿ç”¨sessionï¼Œè€Œæ˜¯ç”¨cookieï¼Œéƒ¨åˆ†ä¸é€‚åˆå­˜cookieçš„å­˜æ•°æ®åº“é‡Œï¼Œæ•°æ®åº“é›†ç¾¤å¤‡ä»½
- æ›´å¥½çš„åšæ³•ï¼šä¸å­˜åœ¨å…³ç³»å‹æ•°æ®åº“ï¼ˆç¡¬ç›˜ï¼‰ä¸­ï¼Œè€Œæ˜¯NOSQLä¸­



### 2.17ç”ŸæˆéªŒè¯ç ğŸ”°

```java
@RequestMapping(value = "/kaptcha",method = RequestMethod.GET)
    public void getKaptcha(HttpServletResponse response, HttpSession session){//ç”±äºä¼ å…¥çš„æ˜¯å›¾ç‰‡å› æ­¤è¿”å›å€¼ä¸ºvoidï¼›éªŒè¯ç ä¸èƒ½å­˜åœ¨æµè§ˆå™¨ç«¯ï¼Œä¸”éœ€è¦è·¨è¯·æ±‚ï¼Œå› æ­¤ä½¿ç”¨session
        //å…ˆåœ¨ä¸Šé¢æŠŠbeanæ³¨å…¥
        String text = kaptchaProducer.createText();//æ ¹æ®é…ç½®ä¼šå¾—åˆ°å››ä½çš„å­—ç¬¦ä¸²
        BufferedImage image = kaptchaProducer.createImage(text);
        //å°†éªŒè¯ç å­˜å…¥session
        session.setAttribute("kaptcha",text);
        //å°†å›¾ç‰‡è¾“å‡ºç»™æµè§ˆå™¨,æ³¨æ„ä½¿ç”¨response
        response.setContentType("image/png");
        try {
            ServletOutputStream os = response.getOutputStream();//å­—èŠ‚æµ
            ImageIO.write(image,"png",os);
        } catch (IOException e) {
            //è¿™é‡Œå°±ä¸è¦æ•è·å¼‚å¸¸äº†ï¼Œ
            logger.error("å“åº”éªŒè¯ç å¤±è´¥",e.getMessage());
        }//ä¸éœ€è¦å…³é—­osï¼Œspringä¼šç»Ÿä¸€å¤„ç†
    }
```

æ¨¡æ¿ä¿®æ”¹ï¼šç‚¹å‡»<u>åˆ·æ–°éªŒè¯ç </u>æ¥åˆ·æ–°ï¼Œè€Œä¸æ˜¯æ•´ä¸ªé¡µé¢åˆ·æ–°ï¼Œéœ€è¦jså®ç°

```html
<div class="col-sm-4">
	<img th:src="@{kaptcha}" id="kaptcha" style="width:100px;height:40px;" class="mr-2"/><!--è¿™ä¸ªid æ˜¯ç”¨äºjs-->
	<a href="javascript:refresh_kaptcha();" class="font-size-12 align-bottom">åˆ·æ–°éªŒè¯ç </a>
</div>
```

```html
<script><!--åŸºäºjqueryçš„-->
	function refresh_kaptcha(){
		var path = CONTEXT_PATH +"/kaptcha?p="+Math.random();//CONTEXT_PATHæ˜¯æˆ‘ä»¬å†™åœ¨js/global.jsçš„å…¨å±€å˜é‡ï¼Œä¾¿äºä»¥åæ”¹åŠ¨
		//è¿™é‡ŒåŠ ä¸Šå‚æ•°p=Math.random()æ˜¯ä¸ºäº†æ¬ºéª—æµè§ˆå™¨ï¼Œä¸è¦è®©å®ƒè§‰å¾—æ¯æ¬¡è®¿é—®ä¸€æ ·çš„è·¯å¾„è€Œé‡‡ç”¨ç¼“å­˜
		$("#kaptcha").attr("src",path);//å°†ä¸Šæ–‡ä¸­id=kaptcha çš„srcå±æ€§æ”¹æˆpath
    }
</script>
```



### 2.23 ç™»å…¥ã€é€€å‡ºåŠŸèƒ½ğŸ”°

å¦‚ä½•æ£€æŸ¥ç™»å…¥é€€å‡ºçŠ¶æ€ï¼›æ•°æ®åº“è¡¨LoginTicketï¼Œå­˜userId,status,Expiredï¼Œæ ¸å¿ƒæ˜¯ticket

1.åˆ›å»ºå®ä½“ç±»

2ã€‚Daoå±‚ï¼š

```java
//ç™»å…¥ï¼šåœ¨è¡¨ä¸­æ’å…¥æ•°æ®
//æŸ¥è¯¢ï¼šæ ¹æ®ticket
//é€€å‡ºï¼šä¿®æ”¹çŠ¶æ€status
```

```java
//@Insert({"","",""})//é‡Œé¢çš„å¤šä¸ªå­—ç¬¦ä¸²è‡ªåŠ¨åˆæˆä¸€æ¡sql
 //ç™»å…¥æˆåŠŸåè¦æ’å…¥å‡­è¯//éœ€è¦å£°æ˜ä¸»é”®è‡ªåŠ¨ç”Ÿæˆï¼Œ@Optionsï¼Œä¸”éœ€è¦å°†ç”Ÿæˆçš„å€¼æ³¨å…¥ç»™å¯¹è±¡ï¼ŒkeyProperty = "id"
    @Insert({
            "insert into login_ticket (user_id,ticket,status,expired) ",//åŠ ä¸ªç©ºæ ¼æ–­å¼€
            "values(#{userId},#{ticket},#{status},#{expired})"
    })
    @Options(useGeneratedKeys = true,keyProperty = "id")
    int insertLoginTicket(LoginTicket loginTicket);

    //æŸ¥è¯¢æ–¹æ³•ï¼šå›´ç»•ticket
    @Select({
            "select id,user_id,ticket,status,expired ",
            "from login_ticket where ticket=#{ticket}"
    })
    LoginTicket selectByTicket(String ticket);

    //ä¿®æ”¹å‡­è¯çŠ¶æ€ï¼šä¸åˆ é™¤
    @Update({
            "update login_ticket set status=#{status} where ticket=#{ticket}"
    })
    int updateStatus(String ticket,int status);
    //å­¦ä¹ ï¼šå‡å¦‚éœ€è¦åŠ¨æ€sqlæ—¶
    /*@Update({
            "<script>",
            "update login_ticket set status=#{status} where ticket=#{ticket} ",
            "<if test=\"ticket!=null\">",           //è¿™é‡Œçš„åŒå¼•å·ç”¨äºè½¬ä¹‰
            "and 1 =1",
            "</if>",
            "</script>"
    })*/
```

å®ç°ç™»å…¥åŠŸèƒ½ï¼Œåœ¨UserService

```java
//å‚æ•°ï¼šæ¥è‡ªControllerä¼ é€’çš„username,password,ä»¥åŠexpiredSecond
//è¿”å›mapï¼Œå°è£…æ¶ˆæ¯
1.éªŒè¯å­—æ®µä¸ä¸ºç©º;
2.æ•°æ®åº“æŸ¥è¯¢ï¼ˆè´¦å·ä¸å­˜åœ¨ï¼Œè´¦å·æœªæ¿€æ´»ï¼Œï¼‰;
3.è·å–saltï¼Œç„¶åå°†æ˜æ–‡å¯†ç åŠ å¯†ï¼ŒéªŒè¯å¯†ç ;
4.ç™»å…¥æˆåŠŸï¼Œç”Ÿæˆç™»å…¥å‡­è¯loginTicketï¼Œå‡­è¯éœ€è¦å‘ç»™å®¢æˆ·ç«¯ï¼Œç±»ä¼¼äºsession
```

è¡¨ç°å±‚ï¼Œåœ¨LoginController

```
åŒæ ·æ˜¯loginæ–¹æ³•ï¼Œä½†æ˜¯å‚æ•°ä¸åŒï¼Œgetè·å–é¡µé¢ï¼Œpostä¸ºç™»å…¥
æ–¹æ³•å‚æ•°ï¼šè´¦å·ï¼Œå¯†ç ï¼ŒéªŒè¯ç ï¼Œè®°ä½æˆ‘ï¼Œmodelï¼Œsessionï¼Œresponse
		(sessionå­˜ä¹‹å‰çš„éªŒè¯ç å­—ç¬¦ä¸²ï¼Œresponseç”¨äºè·å–cookie)
è¿”å›ï¼šString
```

```java
//å–å‡ºéªŒè¯ç 
String kaptcha = (String)session.getAttribute("kaptcha");
if(StringUtils.isBlank(kaptcha)||StringUtils.isBlank(code)||!kaptcha.equalsIgnoreCase(code)){
            model.addAttribute("codeMsg","éªŒè¯ç ä¸æ­£ç¡®");
            return "/site/login";
        }
//æ£€æŸ¥è´¦å·å¯†ç  ï¼Œç”±serviceå¤„ç†
        //å¦‚æœå‹¾é€‰äº†â€œè®°ä½æˆ‘â€ï¼Œåˆ™å­˜çš„æ—¶é—´é•¿ä¸€ç‚¹
        //è¿™é‡Œå†æ¬¡åœ¨CommunityConstantç±»æ·»åŠ å¸¸é‡
        int expiredSecond = rememberme?REMEMBER_EXPIRED_SECONDS:DEFAULT_EXPIRED_SECONDS;
        Map<String, Object> map = userService.login(username, password, expiredSecond);
        //å¦‚æœmapæ€»åŒ…å«ticketï¼Œå°±æ˜¯æˆåŠŸäº†
        if(map.containsKey("ticket")){
            Cookie cookie = new Cookie("ticket",map.get("ticket").toString());
            cookie.setPath(contextPath);//è¡¨ç¤ºæ•´ä¸ªé¡¹ç›®ä¸‹cookieéƒ½æ˜¯æœ‰æ•ˆçš„:æ³¨å…¥propertiesä¸­çš„å€¼
            cookie.setMaxAge(expiredSecond);
            response.addCookie(cookie);//å°†cookieå‘ç»™ç”¨æˆ·
            return "redirect:/index";
        }else {
            model.addAttribute("usernameMsg",map.get("usernameMsg"));
            model.addAttribute("passwordMsg",map.get("passwordMsg"));
            return "/site/login";
        }
```

å¦‚æœæ˜¯å®ä½“å¯¹è±¡ï¼ŒMVCä¼šå°†æ­¤è£…è¿›modelä¸­ï¼Œè€Œä¸€èˆ¬å˜é‡ï¼ˆæœ¬æ–¹æ³•ç”¨çš„Stringï¼‰åˆ™ä¸ä¼šåœ¨modelä¸­ï¼Œä½†æ˜¯åœ¨request å¯¹è±¡ä¸­

è¿™é‡Œçš„ `${param.password}` ç›¸å½“äº `request.get(password)`;

```html
<div class="col-sm-10">
	<input type="password" th:class="|form-control ${passwordMsg!=null?'is-valid':''}|" name="password" th:value="${param.password}"
						id="password" placeholder="è¯·è¾“å…¥æ‚¨çš„å¯†ç !" required>
		<div class="invalid-feedback" th:text="${passwordMsg}">
						å¯†ç é•¿åº¦ä¸èƒ½å°äº8ä½!
		</div>							
</div>
```

é€€å‡ºï¼šæŠŠå‡­è¯æ”¹ä¸ºå¤±æ•ˆçŠ¶æ€ï¼Œè¿”å›é¦–é¡µ

```java
//userService
    public void logout(String ticket){
        loginTicketMapper.updateStatus(ticket,1);
    }
```

```java
//LoginController
@RequestMapping(path = "logout",method = RequestMethod.GET)
    public String logout(@CookieValue("ticket") String ticket){
        userService.logout(ticket);
        return "redirect:/login";//é»˜è®¤getè¯·æ±‚
    }
```



### 2.27 æ˜¾ç¤ºç™»å…¥ä¿¡æ¯

æ‹¦æˆªå™¨ï¼š

### 2.33 è´¦å·è®¾ç½®

### 2.41 æ£€æŸ¥ç™»å…¥çŠ¶æ€







# å†™ä¸ªæ•°æ®åº“é¡¹ç›®

[ä¸€èµ·å†™ä¸ªæ•°æ®åº“ â€”â€” 0. é¡¹ç›®ç»“æ„å’Œä¸€äº›ä¸å¾—ä¸è¯´çš„è¯ - èœç‹—ã®æ—¥å¸¸ (ziyang.moe)](https://ziyang.moe/article/mydb0.html)
