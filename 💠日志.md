###  Spring

åœ¨æµ‹è¯•ç±»ä¸­æµ‹è¯•IoCå®¹å™¨çš„å­˜åœ¨

- æ·»åŠ æ³¨è§£`@ContextConfiguration(classes = CommunityApplication.class)`
- å®ç°æ¥å£ `ApplicationContextAware`
- é‡å†™æ–¹æ³•`public void setApplicationContext(ApplicationContext applicationContext)`

```java
@SpringBootTest
@ContextConfiguration(classes = CommunityApplication.class)//åœ¨æµ‹è¯•ç±»ä¸­åŠ ä¸Šæ­¤æ³¨è§£å°±èƒ½å°†é…ç½®ç±»ï¼ˆï¼‰å¼•ç”¨åœ¨æœ¬ç±»ä¸­
class CommunityApplicationTests implements ApplicationContextAware {

	private ApplicationContext applicationContext;
	@Override
	public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
		this.applicationContext = applicationContext;
	}
	@Test
	public void testApplicationContext(){
		System.out.println(applicationContext);
        //org.springframework.web.context.support.GenericWebApplicationContext@598bd2ba, started on Thu Jun 02 19:55:32 CST 2022
		//è¯æ˜å®¹å™¨æ˜¯å­˜åœ¨çš„
	}
}
```

`@Primary`  æ³¨è§£åœ¨beanä¸Šè¡¨ç¤ºä¼˜å…ˆè¢«Iocå®ä¾‹åŒ–
`@PostConstruct` æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºåœ¨æ„é€ å™¨è¿è¡Œä¹‹åæ‰§è¡Œ
`@PreDestory` æ³¨è§£åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºåœ¨é”€æ¯æ–¹æ³•å‰æ‰§è¡Œ

**æƒ³å®ä¾‹åŒ–ä¸€ä¸ªç¬¬ä¸‰æ–¹jaråŒ…çš„bean**ï¼šè‡ªå·±å†™ä¸ªé…ç½®ç±»ï¼Œé€šè¿‡beanæ³¨è§£å®ç°

`@SpringbootApplication` ä¸€èˆ¬ç”¨äº**ç¨‹åºå…¥å£**çš„é…ç½®ç±»
`@Configuration` è¡¨ç¤ºä¸º**ä¸€èˆ¬**é…ç½®ç±»

```java
@Configuration
public class AlphaConfig {
    @Bean
    public SimpleDateFormat simpleDateFormat(){
        return new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    }
}
```

```java
@Test
	public void testBeanConfiguration(){
		SimpleDateFormat simpleDateFormat = applicationContext.getBean(SimpleDateFormat.class);
		System.out.println(simpleDateFormat.format(new Date()));
        //2022-06-02 20:13:55
	}
```



### MVC

##### ä¼ é€’å‚æ•°æ–¹å¼

ç¬¬ä¸€ç§:

```java
@RequestMapping(path = "/student",method = RequestMethod.GET)
@ResponseBody
public String getStudent(@RequestParam(name="current",required=false,defalutValue="1") int current,
                        @RequestParam(name="limit",required=false,defalutValue="10") int limit){}
```

RestFul

```java
@RequestMapping(path = "/student/{id}",method = RequestMethod.GET)
@ResponseBody
public String getStudent(@PathVariable("id") int id){
        System.out.println(id);
        return "a student";
    }
```

### é‚®ä»¶åŠŸèƒ½

1. åœ¨sinaå¼€å¯æˆæƒç çŠ¶æ€ï¼Œå’ŒPOP3,SMTPæœåŠ¡

2. æ–°å»ºå·¥å…·ç±»MailClient

   ```java
   /*	1.å°†å…¶æ·»åŠ åˆ°springIoCç®¡ç†
   *	2.å®šä¹‰ä¸€ä¸ªLoggerï¼Œç”¨äºè®°å½•é”™è¯¯ä¿¡æ¯
   *	3.å°†é…ç½®æ–‡ä»¶ä¸­çš„usernameæ³¨å…¥ï¼Œè¿™æ˜¯ï¼ˆä»£è¡¨äº†ç½‘ç«™ï¼‰å‘é€æ–¹
   *	4.å®šä¹‰sendMailæ–¹æ³•ï¼Œéœ€è¦ å‘é‚®ä»¶çš„æ ‡é¢˜ ï¼Œå†…å®¹ ï¼Œæˆ‘çš„é‚®ç®± ï¼Œä»–äººçš„é‚®ç®± å››ä¸ªå‚æ•°
   		éœ€è¦springä¸­çš„MimeMessageHelper å¸®åŠ©æ„å»ºé‚®ä»¶
   */
   @Component
   public class MailClient {
       private static final Logger logger = LoggerFactory.getLogger(MailClient.class);
   
       @Autowired
       private JavaMailSender mailSender;
       //éœ€è¦å‘é‚®ä»¶çš„æ ‡é¢˜ï¼Œå†…å®¹ï¼Œæˆ‘çš„é‚®ç®±ï¼Œä»–äººçš„é‚®ç®±
       //å°†usernameæ³¨å…¥ï¼Œå› ä¸ºæœåŠ¡å™¨å‘é‚®ä»¶éƒ½æ˜¯ç”¨ç›´æ¥çš„è´¦å·ï¼ˆé…ç½®ä¸­çš„sinaï¼‰
       @Value("${spring.mail.username}")
       private String from;
   
       //å°è£…å…¬æœ‰æ–¹æ³•
       public void sendMail(String to, String subject, String content) {
           try {
               MimeMessage message = mailSender.createMimeMessage();
               MimeMessageHelper helper = new MimeMessageHelper(message);
               helper.setFrom(from);
               helper.setTo(to);
               helper.setSubject(subject);
               helper.setText(content, true);
               mailSender.send(helper.getMimeMessage());
           } catch (MessagingException e) {
               logger.error("å‘é€é‚®ä»¶å¤±è´¥" + e.getMessage());
           }
       }
   }
   ```

   æµ‹è¯•ï¼š

```java
@Autowired
private MailClient mailClient;//æ³¨å…¥å·¥å…·ç±»

@Test
public void testMail(){
    mailClient.sendMail("574524709@qq.com","test","test mail");
}
```

éœ€è¦å‘htmlå½¢å¼é‚®ç®±ï¼šé‡‡ç”¨thymeleafæ„å»ºæ¨¡æ¿ï¼š

```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>é‚®ä»¶ç¤ºä¾‹</title>
</head>
<body>
    <p>æ¬¢è¿æ‚¨ï¼Œ<span style="color: darkorchid;" th:text="${username}"></span>!</p>
</body>
</html>
```

æµ‹è¯•ï¼š

```java
@Autowired
private TemplateEngine templateEngine;//springbootä¸­å·²ç®¡ç†äº†æ¨¡æ¿å¼•æ“ï¼Œåªéœ€æ³¨å…¥
@Test
    public void testHtmlMail(){
        Context context = new Context();//æ³¨æ„æ˜¯thymeleafçš„ç±»
        context.setVariable("username","sunday");//è¿™æ˜¯å…¶ä¸­çš„ä¸€ä¸ªå˜é‡
        String content = templateEngine.process("/mail/demo", context);//æŠŠæ¨¡æ¿åœ°å€ï¼Œæ•°æ®ä¼ å…¥å¦‚
        System.out.println(content);
        mailClient.sendMail("574524709@qq.com","HTML",content);
}
```

### 6.5

å¯åŠ¨å‡ºç°é—®é¢˜

```
java.sql.SQLNonTransientConnectionException: Public Key Retrieval is not allowed
```

åœ¨é…ç½®ä¸­æ•°æ®åº“è¿æ¥ååŠ ä¸Š

```
allowPublicKeyRetrieval=true
```

åœ¨é¦–é¡µç‚¹å‡»ï¼ˆé¦–é¡µï¼‰ï¼Œï¼ˆæ³¨å†Œï¼‰éƒ½æ— é¡µé¢

```html
<!--æ³¨æ„thymeleafçš„è¿™ä¸ªå†™æ³•æ˜¯é”™çš„-->
<a class="nav-link" th:href="@{site/index.html}">é¦–é¡µ</a>
<!--é‡‡ç”¨è¿™æ ·-->
<a class="nav-link" th:href="@{index}">é¦–é¡µ</a>
```

### Cookie

```java
 //Cookieç¤ºä¾‹
    @RequestMapping(path = "/cookie/set",method = RequestMethod.GET)
    @ResponseBody
    public String setCookie(HttpServletResponse response){
        Cookie cookie = new Cookie("code1", CommunityUtil.generateUUID());
        //è®¾ç½®èŒƒå›´ï¼Œæœ‰äº›è·¯å¾„ä¸‹æœ‰æ•ˆçš„
        cookie.setPath("/community/alpha");
        //ç”Ÿå­˜æ—¶é—´ï¼ˆé»˜è®¤æ˜¯å…³é—­æµè§ˆå™¨å¤±æ•ˆï¼‰
        cookie.setMaxAge(600);//ç§’
        //å‘é€
        response.addCookie(cookie);
        return "set cookie";
    }

    @RequestMapping(path = "/cookie/get",method = RequestMethod.GET)
    @ResponseBody
    public String getCookie(@CookieValue("code1") String code1){//åŸæœ¬åœ¨requestä¸­å–å¾—ï¼Œä½†å¯ä»¥ç”¨æ³¨è§£å–å¾—å¹¶èµ‹ç»™å€¼
        System.out.println();
        return "get cookie";
    }
```

### session

ä¼˜ç‚¹ï¼šå­˜åœ¨æœåŠ¡å™¨æ›´å®‰å…¨

ç¼ºç‚¹ï¼šæœåŠ¡å™¨å‹åŠ›

```java
 //Sessionæ˜¯javaSEçš„è§„èŒƒï¼Œä¸æ˜¯httpçš„
    @RequestMapping(path = "/session/set",method = RequestMethod.GET)
    @ResponseBody
    public String setSession(HttpSession session){//ä¸cookieä¸åŒï¼ŒspringMVCä¼šè‡ªåŠ¨åˆ›å»ºSession,åªéœ€è¦å£°æ˜ï¼Œå°±èƒ½æ³¨å…¥è¿›æ¥
        session.setAttribute("id",1);
        session.setAttribute("name","test");
        return "session test";
    }

    @RequestMapping(path = "/session/get",method = RequestMethod.GET)
    @ResponseBody
    public String getSession(HttpSession session){
        System.out.println(session.getAttribute("id"));
        System.out.println(session.getAttribute("name"));
        return "get session test";
    }
```

<font color=red>åˆ†å¸ƒå¼éƒ¨ç½²</font>ï¼šnginxå®ç°è´Ÿè½½å‡è¡¡

- ç²˜æ€§sessionï¼šåŒä¸€ipçš„è¯·æ±‚å‡åˆ†é…åˆ°æŒ‡å®šä¸€å°æœåŠ¡å™¨ä¸Š
- åŒæ­¥sessionï¼šæœåŠ¡å™¨å°†sessionåŒæ­¥ç»™æ‰€æœ‰æœåŠ¡å™¨
- å…±äº«sessionï¼šæœ‰ä¸€å°å•ç‹¬çš„æœåŠ¡å™¨ç”¨äºå¤„ç†sessionï¼Œå…¶ä»–æœåŠ¡å™¨ä¸è¯¥æœåŠ¡å™¨
- ä¸»æµï¼šä¸ä½¿ç”¨sessionï¼Œè€Œæ˜¯ç”¨cookieï¼Œéƒ¨åˆ†ä¸é€‚åˆå­˜cookieçš„å­˜æ•°æ®åº“é‡Œï¼Œæ•°æ®åº“é›†ç¾¤å¤‡ä»½
- æ›´å¥½çš„åšæ³•ï¼šä¸å­˜åœ¨å…³ç³»å‹æ•°æ®åº“ï¼ˆç¡¬ç›˜ï¼‰ä¸­ï¼Œè€Œæ˜¯NOSQLä¸­

### ç”ŸæˆéªŒè¯ç 

Kaptchaï¼š

- å¯¼å…¥jaråŒ…
- ç¼–å†™kaptchaé…ç½®ç±»
- ç”Ÿæˆéšæœºå­—ç¬¦ï¼Œå›¾ç‰‡

### ç™»å…¥å’Œé€€å‡º

ç™»å½•è¯·æ±‚ï¼š

- ç‚¹å‡»ä¸Šæ–¹çš„â€œç™»å…¥â€ï¼Œèƒ½è·³åˆ°ç™»å…¥é¡µé¢
- ç‚¹å‡»â€œç«‹å³ç™»å…¥â€ï¼Œè¿”å›ç»“æœï¼ˆç™»å…¥å‡­è¯ï¼Œcookieï¼‰å‘ç»™å®¢æˆ·ç«¯

é€€å‡ºè¯·æ±‚:

- å°†ç™»å…¥å‡­è¯ä¿®æ”¹ä¸ºå¤±æ•ˆçŠ¶æ€
- è·³è½¬è‡³é¦–é¡µ

æ•°æ®åº“ä¸­çš„è¡¨ login_ticketï¼š

| id   | user_id | ticket               | status        | expired  |
| ---- | ------- | -------------------- | ------------- | -------- |
|      |         | éšæœºå­—ç¬¦ä¸²ï¼Œå”¯ä¸€æ ‡è¯† | 0-æœ‰æ•ˆ 1-æ— æ•ˆ | è¿‡æœŸæ—¶é—´ |

1ã€åˆ›å»ºå®ä½“ç±»ï¼Œå°è£…æ•°æ®

```java
//dao

/**
 * åœ¨æœ¬ç±»ä¸­ï¼Œå­¦ä¹ ä½¿ç”¨æ³¨è§£å®ç°sqlï¼Œä¸æ˜¯xml
 *
 */
@Mapper
public interface LoginTicketMapper {

    //ç™»å…¥æˆåŠŸåè¦æ’å…¥å‡­è¯//éœ€è¦å£°æ˜ä¸»é”®è‡ªåŠ¨ç”Ÿæˆï¼Œ@Optionsï¼Œä¸”éœ€è¦å°†ç”Ÿæˆçš„å€¼æ³¨å…¥ç»™å¯¹è±¡ï¼ŒkeyProperty = "id"
    @Insert({
            "insert into login_ticket (user_id,ticket,status,expired) ",//åŠ ä¸ªç©ºæ ¼æ–­å¼€
            "values(#{userId},#{ticket},#{status},#{expired})"
    })
    @Options(useGeneratedKeys = true,keyProperty = "id")
    int insertLoginTicket(LoginTicket loginTicket);

    //æŸ¥è¯¢æ–¹æ³•ï¼šå›´ç»•ticket
    @Select({
            "select id,user_id,ticket,status,expired ",
            "from login_ticket where ticket=#{ticket}"
    })
    LoginTicket selectByTicket(String ticket);

    //ä¿®æ”¹å‡­è¯çŠ¶æ€ï¼šä¸åˆ é™¤
    @Update({
            "update login_ticket set status=#{status} where ticket=#{ticket}"
    })
    int updateStatus(String ticket,int status);
    //å­¦ä¹ ï¼šå‡å¦‚éœ€è¦åŠ¨æ€sqlæ—¶
    /*@Update({
            "<script>",
            "update login_ticket set status=#{status} where ticket=#{ticket} ",
            "<if test=\"ticket!=null\">",
            "and 1 =1",
            "</if>",
            "</script>"
    })*/
}
```

```java
//UserService


//å®ç°ç™»å…¥åŠŸèƒ½ï¼šæˆåŠŸã€å¤±è´¥ï¼ˆå¤šç§æƒ…å†µï¼‰
    public Map<String ,Object> login(String username,String password,int expiredSeconds){
        Map<String ,Object> map = new HashMap<>();
        //ç©ºå€¼åˆ¤æ–­
        if(StringUtils.isBlank(username)){
            map.put("usernameMsg","è´¦å·ä¸èƒ½ä¸ºç©ºï¼");
            return map;
        }
        if(StringUtils.isBlank(password)){
            map.put("passwordMsg","å¯†ç ä¸èƒ½ä¸ºç©ºï¼");
            return map;
        }
        //éªŒè¯åˆæ³•æ€§
        User user = userMapper.selectByName(username);
        if(user==null){
            map.put("usernameMsg","è´¦å·ä¸å­˜åœ¨ï¼");
            return map;
        }
        //æ²¡æ¿€æ´»çš„è´¦å·ä¸èƒ½ç™»å…¥
        if(user.getStatus()==0){
            map.put("usernameMsg","è´¦å·æœªæ¿€æ´»ï¼");
            return map;
        }
        //å¯†ç 
        password = CommunityUtil.md5(password+ user.getSalt());
        if(user.getPassword().equals(password)){
            map.put("passwordMsg","å¯†ç ä¸æ­£ç¡®ï¼");
            return map;
        }
        //ç™»å…¥æˆåŠŸï¼Œç”Ÿæˆç™»å…¥å‡­è¯
        LoginTicket loginTicket = new LoginTicket();
        loginTicket.setUserId(user.getId());
        loginTicket.setTicket(CommunityUtil.generateUUID());
        loginTicket.setStatus(0);//æœ‰æ•ˆçŠ¶æ€
        loginTicket.setExpired(new Date(System.currentTimeMillis()+expiredSeconds*1000));
        loginTicketMapper.insertLoginTicket(loginTicket);
        //è¿™ä¸ªLoginTicketè¡¨å°±ç›¸å½“ä¸sessionäº†ï¼Œä¸‹æ¬¡ç”¨æˆ·è¯·æ±‚å¸¦ä¸Šticketï¼ŒæœåŠ¡å™¨æŸ¥è¯¢çŠ¶æ€å’Œæ—¶é—´çœ‹æ˜¯å¦æœ‰æ•ˆ
        map.put("ticket",loginTicket.getTicket());
        return map;
    }
```

```java
//LoginController

@RequestMapping(path = "/login",method = RequestMethod.POST)
    public String login(String username,String password ,String code,boolean rememberme,//è¿™ä¸ªremembermeæ˜¯å‹¾é€‰è®°ä½æˆ‘
                        Model model,HttpSession session,HttpServletResponse response){//modelç”¨äºèŒƒå›´å“åº”æ•°æ®ï¼›getKaptchaå­˜çš„éªŒè¯ç éœ€è¦sessionè·å–ï¼›ç™»å…¥æˆåŠŸäº†ï¼Œéœ€è¦å°†ticketå‘ç»™å®¢æˆ·ç«¯ç”¨cookieä¿å­˜
        String kaptcha = (String) session.getAttribute("kaptcha");
        if(StringUtils.isBlank(kaptcha)||StringUtils.isBlank(code)||!kaptcha.equalsIgnoreCase(code)){
            model.addAttribute("codeMsg","éªŒè¯ç ä¸æ­£ç¡®");
            return "/site/login";
        }
        //æ£€æŸ¥è´¦å·å¯†ç 
        //å¦‚æœå‹¾é€‰äº†â€œè®°ä½æˆ‘â€ï¼Œåˆ™å­˜çš„æ—¶é—´é•¿ä¸€ç‚¹
        //è¿™é‡Œå†æ¬¡åœ¨CommunityConstantç±»æ·»åŠ å¸¸é‡
        int expiredSecond = rememberme?REMEMBER_EXPIRED_SECONDS:DEFAULT_EXPIRED_SECONDS;
        Map<String, Object> map = userService.login(username, password, expiredSecond);
        //å¦‚æœmapæ€»åŒ…å«ticketï¼Œå°±æ˜¯æˆåŠŸäº†
        if(map.containsKey("ticket")){
            Cookie cookie = new Cookie("ticket",map.get("ticket").toString());
            cookie.setPath(contextPath);//è¡¨ç¤ºæ•´ä¸ªé¡¹ç›®ä¸‹cookieéƒ½æ˜¯æœ‰æ•ˆçš„:æ³¨å…¥propertiesä¸­çš„å€¼
            cookie.setMaxAge(expiredSecond);
            response.addCookie(cookie);//å°†cookieå‘ç»™ç”¨æˆ·
            return "redirect:/index";
        }else {
            model.addAttribute("usernameMsg",map.get("usernameMsg"));
            model.addAttribute("passwordMsg",map.get("passwordMsg"));
            return "/site/login";
        }
    }
```

### æ˜¾ç¤ºç™»å…¥ä¿¡æ¯

æ ¹æ®ç™»å…¥ä¸å¦ï¼Œè°ƒæ•´å¤´éƒ¨ä¿¡æ¯ï¼Œç”±äºåœ¨æ•´ä¸ªç½‘ç«™éƒ½æœ‰ï¼šè®¾å®šæ‹¦æˆªå™¨

1ã€å®šä¹‰æ‹¦æˆªå™¨

```java
@Controller
public class AlphaInterceptor implements HandlerInterceptor {
    private static final Logger logger = LoggerFactory.getLogger(AlphaInterceptor.class);

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        logger.debug("preHandleè°ƒç”¨äº†:"+handler.toString());
        return true;
    }

    //åœ¨Controllerä¹‹åè¿è¡Œï¼Œæ¨¡æ¿å¼•æ“ä¹‹å‰æ‰§è¡Œ
    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        logger.debug("postHandleè°ƒç”¨äº†:"+handler.toString());
    }

    //åœ¨æ¨¡æ¿å¼•æ“TemplateEngineä¹‹åæ‰§è¡Œ
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        logger.debug("afterCompletionè°ƒç”¨äº†:"+handler.toString());
    }
    //å†™å®Œä¹‹ååœ¨configå»ºç«‹é…ç½®ç±»
}
```

2ã€é…ç½®æ‹¦æˆªå™¨ï¼ŒæŒ‡å®šã€æ’é™¤è·¯å¾„

```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {


    @Autowired
    private AlphaInterceptor alphaInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(alphaInterceptor).
                excludePathPatterns("/**/*.css","/**/*.js","/**/*.png","/**/*.jpg","/**/*.jpeg")  //ä¸æ‹¦æˆªé™æ€èµ„æº
                .addPathPatterns("/register","/login"); //æ˜ç¡®è¦æ‹¦æˆªçš„è·¯å¾„ï¼šæ³¨å†Œå’Œç™»å…¥
    }
}
```

æ‹¦æˆªå™¨åœ¨æœ¬èŠ‚çš„å®ç°ï¼š

-  åœ¨è¯·æ±‚å¼€å§‹æ—¶æŸ¥è¯¢ç™»å…¥ç”¨æˆ·
- åœ¨æœ¬æ¬¡è¯·æ±‚ä¸­æŒæœ‰çš„ç”¨æˆ·æ•°æ®
- åœ¨æ¨¡æ¿è§†å›¾ä¸Šæ˜¾ç¤ºç”¨æˆ·æ•°æ®
- åœ¨ç»“æŸè¯·æ±‚æ—¶æ¸…ç†ç”¨æˆ·æ•°æ®

### è´¦å·è®¾ç½®

ä¸Šä¼ å¤´åƒå’Œä¿®æ”¹å¯†ç 

ä¸Šä¼ æ–‡ä»¶ï¼š

- è¯·æ±‚ï¼špost
- è¡¨å•ï¼šenctype="multipart/form-data"
- SpringMVC ï¼šé€šè¿‡MultipartFileå¤„ç†ä¸Šä¼ æ–‡ä»¶

æ­¥éª¤ï¼š

1. è®¿é—®é¡µé¢
2. ä¸Šä¼ å¤´åƒ
3. è·å–å¤´åƒï¼šåœ¨å…¶ä»–é¡µé¢éƒ½è¦è·å–

## 6.14

### æ³¨å†ŒåŠŸèƒ½

1.Controllerå±‚

```java
//LoginController
@RequestMapping(path = "/register",method = RequestMethod.GET)
    public String getRegisterPage(){
        return "/site/register";
    }
```

2.ä¿®æ”¹registeré¡µé¢

3.å¼•å…¥CommonsLangåŒ…ï¼Œç”¨äºå¸¸ç”¨å­—ç¬¦ä¸²æ£€æµ‹

4.å†™å·¥å…·ç±»ï¼ˆç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼ŒåŠ å¯†ç­‰ï¼‰ï¼Œç”±äºä¸éœ€è¦äº¤ç»™å®¹å™¨æ‰˜ç®¡ï¼Œå› æ­¤å†™æˆé™æ€æ–¹æ³•

```java
//ä½¿ç”¨ è‡ªå¸¦çš„UUIDåŒ…ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
public static String generateUUID(){
        return UUID.randomUUID().toString().replaceAll("-","");//ä¸æƒ³è¦æœ‰æ¨ªçº¿
    }
//åŠ å¯†å¯†ç :ä½¿ç”¨Spring è‡ªå¸¦çš„å·¥å…·ç±» DigestUtils.md5DigestAsHex()
public static String md5(String key){
        if(StringUtils.isBlank(key)){//å…ˆç®€å•åˆ¤æ–­ä¸‹ä¸ä¸ºç©ºï¼Œé‡‡ç”¨äº†commons langåŒ…
            return null;
        }else {
            return DigestUtils.md5DigestAsHex(key.getBytes(StandardCharsets.UTF_8));//è¿™æ˜¯springè‡ªå¸¦çš„åŠ å¯†æ–¹æ³•
        }
    }
```

5.å¼€å‘æ³¨å†Œä¸šåŠ¡

```java
//UserService
//æ³¨å…¥é‚®ä»¶å®¢æˆ·ç«¯ï¼Œæ¨¡æ¿å¼•æ“
//æ³¨å…¥é¡¹ç›®åï¼Œé¡¹ç›®è·¯å¾„
	@Autowired
    private MailClient mailClient;
    @Autowired
    private TemplateEngine templateEngine;
    //æ³¨å†Œæ—¶å‘é€æ¿€æ´»ç éœ€è¦å¸¦ä¸ŠåŸŸåå’Œé¡¹ç›®åï¼Œå› æ­¤ä»propertiesä¸­æ³¨å…¥
    @Value("${community.path.domain}")
    private String domain;
    @Value("${server.servlet.context-path}")
    private String contextPath;
    @Autowired
    private LoginTicketMapper loginTicketMapper;
```

6.å¼€å‘ä¸šåŠ¡

> - è¿”å›ç»“æœï¼šé”™è¯¯ä¿¡æ¯ï¼ˆæ³¨å†ŒæˆåŠŸã€è´¦å·å·²å­˜åœ¨ç­‰ï¼‰---> Map
>
>   1. ç©ºå€¼åˆ¤æ–­ï¼šè´¦å·ï¼Œå¯†ç ï¼Œé‚®ç®±
>
>   2. éªŒè¯ï¼šï¼ˆè´¦å·å·²å­˜åœ¨ã€é‚®ç®±å·²å­˜åœ¨ï¼‰â€”â€”> userMapper.selectByName
>
>   3. æ³¨å†Œç”¨æˆ·ï¼šæŠŠç”¨æˆ·æ’å…¥åº“ä¸­
>
>      1. user.setSalt
>
>      2. user.setPassword() å°†salt+åŸå¯†ç å¹¶åŠ å¯†è¦†ç›–åŸå¯†ç 
>
>      3. user.setType/setStatus/setActivationCode/setHeader
>
>      4. éšæœºå¤´åƒè®¾ç½®
>
>         ```java
>         user.setHeaderUrl(String.format("http:\\image.nowcoder.com/head/%dt.png",new Random().nextInt(1000)));
>         ```
>
>      5. ç»™ç”¨æˆ·å‘æ¿€æ´»é‚®ä»¶
>
>
> ```java
> Context context = new Context();//Thymeleafè‡ªå¸¦å¯¹è±¡ï¼šæ¨¡æ¿ç”Ÿæˆhtmlæ ¼å¼é‚®ä»¶
> context.setVariable("email",user.getEmail()); 
> //åŠ¨æ€æ‹¼æ¥ç”¨æˆ·èƒ½ç‚¹çš„è·¯å¾„ï¼ˆæ¯ä¸ªç”¨æˆ·çš„æ¿€æ´»é¡µé¢æ˜¯ä¸åŒçš„ï¼‰ :101 æ˜¯ç”¨æˆ·idï¼Œcodeæ˜¯æ¿€æ´»ç 
> //http://localhost:8080/community/activation/101/code
> String url = domain+contextPath+"/activation/"+user.getId()+"/"+user.getActivationCode();
> context.setVariable("url",url);
> //ç”Ÿæˆæ¨¡æ¿å¼•æ“
> String content = templateEngine.process("/mail/activation",context);
> mailClient.sendMail(user.getEmail(), "è´¦å·æ¿€æ´»",content);
> ```
>
> 

```java
//userService
    public Map<String,Object> register(User user){
        Map<String ,Object> map = new HashMap<>();
        //å…ˆå¯¹ç©ºå€¼åšåˆ¤æ–­
        if(user==null){
            throw new IllegalArgumentException("å‚æ•°ä¸ä¸ºç©º");
        }
        if(StringUtils.isBlank(user.getUserName())){
            map.put("usernameMsg","è´¦å·ä¸èƒ½ä¸ºç©º!");
            return map;
        }
        if(StringUtils.isBlank(user.getPassword())){
            map.put("passwordMsg","å¯†ç ä¸èƒ½ä¸ºç©º!");
            return map;
        }
        if(StringUtils.isBlank(user.getEmail())){
            map.put("emailMsg","é‚®ç®±ä¸èƒ½ä¸ºç©º!");
            return map;
        }
        //è´¦å·æ˜¯å¦å­˜åœ¨
        User u = userMapper.selectByName(user.getUserName());
        if(u!=null){
            map.put("usernameMsg","è´¦å·å·²å­˜åœ¨!");
            return map;
        }
        //é‚®ç®±éªŒè¯
        u = userMapper.selectByEmail(user.getEmail());
        if(u!=null){
            map.put("emailMsg","è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ!");
            return map;
        }
        //å¯ä»¥æ³¨å†Œäº†
        user.setSalt(CommunityUtil.generateUUID().substring(0,5));
        user.setPassword(CommunityUtil.md5(user.getPassword()+user.getSalt()));
        user.setType(0);//æ™®é€šç”¨æˆ·
        user.setStatus(0);//æœªæ¿€æ´»
        user.setActivationCode(CommunityUtil.generateUUID());//ç”Ÿæˆä¸€ä¸ªæ¿€æ´»ç 
        //ä¸ºç”¨æˆ·è®¾ç½®éšæœºå¤´åƒï¼Œç‰›å®¢ç½‘çš„å¤´åƒåº“æœ‰0-1000 å·å¤´åƒ
        user.setHeaderUrl(String.format("http://images.nowcoder.com/head/%dt.png",new Random().nextInt(1000)));
        user.setCreateTime(new Date());
        userMapper.insertUser(user);
        //ç»™ç”¨æˆ·å‘é‚®ä»¶ï¼Œç”¨äºæ¿€æ´» æ¨¡æ¿ activation.html
        Context context = new Context();
        context.setVariable("email",user.getEmail());
        //åŠ¨æ€æ‹¼æ¥ç”¨æˆ·èƒ½ç‚¹çš„è·¯å¾„ï¼ˆæ¯ä¸ªç”¨æˆ·çš„æ¿€æ´»é¡µé¢æ˜¯ä¸åŒçš„ï¼‰ :101 æ˜¯ç”¨æˆ·idï¼Œcodeæ˜¯æ¿€æ´»ç 
        //http://localhost:8080/community/activation/101/code
        String url = domain+contextPath+"/activation/"+user.getId()+"/"+user.getActivationCode();
        context.setVariable("url",url);
        //ç”Ÿæˆæ¨¡æ¿å¼•æ“
        String content = templateEngine.process("/mail/activation",context);
        mailClient.sendMail(user.getEmail(), "è´¦å·æ¿€æ´»",content);
        return map;
    }
```

7.æ§åˆ¶å™¨

> 1. å°†userServiceæ³¨å…¥
>
> 2. å®šä¹‰æ–¹æ³•å¤„ç†ç”¨æˆ·çš„æ³¨å†Œè¯·æ±‚ï¼šregisteré¡µé¢  post
>
>    ```java
>    @RequestMapping(path = "/register",method = RequestMethod.POST)
>        public String register(Model model, User user)
>    ```
>
>    
>
>    ```java
>    		Map<String,Object> map = userService.register(user);
>            if(map==null||map.isEmpty()){
>                model.addAttribute("msg","æ³¨å†ŒæˆåŠŸï¼Œæˆ‘ä»¬å·²å‘ä½ çš„é‚®ç®±å‘é€äº†æ¿€æ´»é‚®ä»¶ï¼Œè¯·å°½å¿«æ¿€æ´»ï¼");
>                model.addAttribute("target","/index");
>                return "/site/operate-result";//è·³è½¬åˆ°è·³è½¬é¡µé¢
>            }else{//æºå¸¦ä¿¡æ¯ï¼Œé‡æ–°å›åˆ°æ³¨å†Œé¡µé¢ï¼ŒæŠŠserviceå±‚çš„ä¸‰ä¸ªä¿¡æ¯éƒ½å‘å›ï¼Œå¦‚æœæ˜¯ç©ºçš„å°±ä¸æ˜¾ç¤º
>                model.addAttribute("usernameMsg",map.get("usernameMag"));
>                model.addAttribute("passwordMsg",map.get("passwordMag"));
>                model.addAttribute("emailMsg",map.get("emailMag"));
>                model.addAttribute("user",user);//æµ‹è¯•
>                return "/site/register";
>    ```

8.æ¿€æ´»è´¦å·

> åœ¨serviceå±‚æ·»åŠ ä¸šåŠ¡
>
> ```java
> 	public int activation(int userId,String code){//ä¼ å…¥ç”¨æˆ·idï¼Œå’Œæ¿€æ´»ç codeï¼ŒæŸ¥è¯¢æ¿€æ´»ç 
>         User user = userMapper.selectById(userId);
>         if(user.getStatus()==1){//å·²ç»æ¿€æ´»äº†
>             return ACTIVATION_REPEAT;
>         }else if(user.getActivationCode().equals(code)){
>             userMapper.updateStatus(userId,1);//ä¿®æ”¹æ¿€æ´»çŠ¶æ€
>             return ACTIVATION_SUCCESS;
>         }else {
>             return ACTIVATION_FAILURE;
>         }
>     }
> ```
>
> Controller
>
> ```java
> @RequestMapping(path = "/activation/{userId}/{code}",method = RequestMethod.GET)
>     public String activation(Model model, @PathVariable("userId") int userId,@PathVariable("code") String code){
>         int result = userService.activation(userId,code);
>         if(result==ACTIVATION_SUCCESS){
>             model.addAttribute("msg","æ¿€æ´»æˆåŠŸï¼");
>             model.addAttribute("target","/login");
>         }else if(result==ACTIVATION_REPEAT){
>             model.addAttribute("msg","è¯¥è´¦å·å·²ç»æ¿€æ´»è¿‡ï¼");
>             model.addAttribute("target","/index");
>         }else{
>             model.addAttribute("msg","æ¿€æ´»å¤±è´¥ï¼");
>             model.addAttribute("target","/index");
>         }
>         return "/site/operate-result";
>     }
> ```
>
> 

## 8.14

### è´¦å·è®¾ç½®ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰

è¯·æ±‚:å¿…é¡»æ˜¯POSTè¯·æ±‚ï¼Œ
è¡¨å•: enctype= "multipart/form-data
Spring MVC:é€šè¿‡MultipartFileå¤„ç†.ä¸Šä¼ æ–‡ä»¶

## 8.15

### æ£€æŸ¥ç™»å…¥çŠ¶æ€

å¦‚æœæœ‰äººçŸ¥é“ä¸€äº›è·¯å¾„ï¼Œå°±å¯ä»¥åœ¨æ²¡ç™»å…¥æ—¶è¿›å…¥æŸäº›é¡µé¢ï¼Œåº”è¯¥é…ç½®æ‹¦æˆªå™¨é˜»æ­¢éæ³•è®¿é—®ã€‚

```
â—ä½¿ç”¨æ‹¦æˆªå™¨
-åœ¨æ–¹æ³•å‰æ ‡æ³¨è‡ªå®šä¹‰æ³¨è§£
æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œåªå¤„ç†å¸¦æœ‰è¯¥æ³¨è§£çš„æ–¹æ³•
â—è‡ªå®šä¹‰æ³¨è§£
å¸¸ç”¨çš„å…ƒæ³¨è§£:
@Targetã€@Retentionã€@Documentã€ @Inherited
å¦‚ä½•è¯»å–æ³¨è§£:
Method . getDeclaredAnnotations ()
Method . getAnnotation (Class<T> annotationClass)
```

1.å…ˆå®šä¹‰æ³¨è§£

```java
@Target(ElementType.METHOD)
@Retention(RetentionPoliy.RUNTIME)
public @interface LOginRequired{
    //ä¸ç”¨å†™ä¸œè¥¿ï¼Œåªæ˜¯æ ‡è®°çš„ä½œç”¨
}
```

2.åœ¨éœ€è¦çš„æ–¹æ³•å‰åŠ ä¸Šè¯¥æ³¨è§£

3.å®šä¹‰æ‹¦æˆªå™¨

```java
@Autowired
public HostHolder hostHolder;//å°è¯•è·å–å½“å‰çš„ç”¨æˆ·æ¥åˆ¤æ–­ç™»å…¥

@Component
public Class LoginRequiredIntercepter implements HandlerInceptor{
    @override
    public boolean prehander(HttpServletRequest request,HttpServlet response, Object handler) throws Exception{
        //å‚æ•°çš„ Object handleræ˜¯æ‹¦æˆªçš„ç›®æ ‡ï¼Œç›®æ ‡æ˜¯æ–¹æ³•æ‰èƒ½æ‰§è¡Œ
        if(handler instanceof HandlerMethod){
            HandlerMethod handlerMethod = (HandlerMethod) handler;
            //é€šè¿‡å®ƒçš„æ–¹æ³•æ¥ç›´æ¥è·å–æ‹¦æˆªåˆ°çš„æ–¹æ³•
            sMethod method = handlerMethod.getMethod();
            //æœ‰äº†æ–¹æ³•å¯¹è±¡ï¼Œå°è¯•ä»æ–¹æ³•å¯¹è±¡ä¸­è·å–æ³¨è§£
            LoginRequired loginRequired = method.getAnnotation(LoginRequired.class);
            if(loginRequired != null && hostHolder.getUser()== null){//ä¸”è·å–ä¸åˆ°ç™»å…¥ç”¨æˆ·
                response.sendRedirect(request.getContextPath()+"/login");
                return false;
            }
        }
    }
  
}
```

4.å°†æ‹¦æˆªå™¨æ³¨å…¥WebMvcConfig

```java
//1.å…ˆæ³¨å…¥
@Autowired
private LoginRequiredInterceptor loginRequiredInterceptor;
//2.ç„¶ååœ¨addInterceptoråŠ å…¥
registry.addInterceptor().excludePathPatterns()
```

# 9

é¡¹ç›®ç›®å½•

### 3.1 è¿‡æ»¤æ•æ„Ÿè¯ğŸ”°

â€‹	å‰ç¼€æ ‘ï¼Œå»ºæ ‘ï¼Œåˆå§‹åŒ–postConstructï¼Œå­—ç¬¦åŒ¹é…

### 3.6 å‘å¸ƒå¸–å­

å¼‚æ­¥å¤„ç†AJAXï¼ˆé‡‡ç”¨JSONï¼‰
![image-20220901153603403](Resources/image-20220901153603403.png)

Serviceå±‚--å‘å¸ƒå¸–å­+æ•æ„Ÿè¯è¿‡æ»¤

![image-20220901155938935](Resources/image-20220901155938935.png)

Controllerå±‚

![image-20220901160251008](Resources/image-20220901160251008.png)

### 3.11 å¸–å­è¯¦æƒ…

ä¼ å…¥å¸–å­id

![image-20220902201311496](Resources/image-20220902201311496.png)

serviceå±‚

![image-20220902203130250](Resources/image-20220902203130250.png)

### 3.13 äº‹åŠ¡ç®¡ç†

### 3.20 æ˜¾ç¤ºè¯„è®º

### 3.22 æ·»åŠ è¯„è®º

### 3.24ç§ä¿¡åˆ—è¡¨

### 3.31 ç»Ÿä¸€å¤„ç†å¼‚å¸¸

### 3.33 ç»Ÿä¸€è®°å½•æ—¥å¿—

### 4.1 redis

### 4.7 springboot æ•´åˆredis

### 4.10 ç‚¹èµ

### 4.13 æˆ‘å—åˆ°çš„èµ

### 4.16 å…³æ³¨ã€å–æ¶ˆå…³æ³¨

### 4.19 å…³æ³¨åˆ—è¡¨ã€ç²‰ä¸åˆ—è¡¨

### 4.23 ä¼˜åŒ–ç™»å…¥æ¨¡å—

### 5.1é˜»å¡é˜Ÿåˆ—

### 5.5 kafka

### 5.9 springboot æ•´åˆkafka

### 5.11 å‘é€ç³»ç»Ÿé€šçŸ¥

### 5.13 æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥

### 6.1 ElasticSearch

### 6.4 spring bootæ•´åˆElasticSearch

### 6.6 å¼€å‘å¤±å»æœç´¢åŠŸèƒ½

### 7.1 SpringSecurity

### 7.3 æƒé™æ§åˆ¶

